<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.16">
<meta name="author" content="Version 1.0 Jan 12 2024">
<title>EMEWS Tutorial</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/*! Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment the following line when using as a custom stylesheet */
/* @import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700"; */
html{font-family:sans-serif;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
b,strong{font-weight:bold}
abbr{font-size:.9em}
abbr[title]{cursor:help;border-bottom:1px dotted #dddddf;text-decoration:none}
dfn{font-style:italic}
hr{height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type=button],input[type=reset],input[type=submit]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type=checkbox],input[type=radio]{padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,::before,::after{box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;line-height:1;position:relative;cursor:auto;-moz-tab-size:4;-o-tab-size:4;tab-size:4;word-wrap:anywhere;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:1px solid #dedede;word-wrap:normal}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre).nobreak{word-wrap:normal}
:not(pre).nowrap{white-space:nowrap}
:not(pre).pre-wrap{white-space:pre-wrap}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;border-radius:3px;box-shadow:0 1px 0 rgba(0,0,0,.2),inset 0 0 0 .1em #fff;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin:0 auto;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:flex;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border:1px solid #e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:none;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:hsla(0,0%,100%,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details{margin-left:1.25rem}
details>summary{cursor:pointer;display:block;position:relative;line-height:1.6;margin-bottom:.625rem;-webkit-tap-highlight-color:transparent}
details>summary::before{content:"";border:solid transparent;border-left:solid;border-width:.3em 0 .3em .5em;position:absolute;top:.5em;left:-1.25rem;transform:translateX(15%)}
details[open]>summary::before{border:solid transparent;border-top:solid;border-width:.5em .3em 0;transform:translateY(15%)}
details>summary::after{content:"";width:1.25rem;height:1em;position:absolute;top:.3em;left:-1.25rem}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class=paragraph]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6);word-wrap:anywhere}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border:1px solid #e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border:1px solid #dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{border-radius:4px;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class=highlight],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos{border-right:1px solid;opacity:.35;padding-right:.5em}
pre.pygments .lineno{border-right:1px solid;opacity:.35;display:inline-block;margin-right:.75em}
pre.pygments .lineno::before{content:"";margin-right:-.125em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans-serif;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;font-size:.85rem;text-align:left;margin-right:0}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:1.25em;word-wrap:anywhere}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>*>tr>*{border-width:1px}
table.grid-cols>*>tr>*{border-width:0 1px}
table.grid-rows>*>tr>*{border-width:1px 0}
table.frame-all{border-width:1px}
table.frame-ends{border-width:1px 0}
table.frame-sides{border-width:0 1px}
table.frame-none>colgroup+*>:first-child>*,table.frame-sides>colgroup+*>:first-child>*{border-top-width:0}
table.frame-none>:last-child>:last-child>*,table.frame-sides>:last-child>:last-child>*{border-bottom-width:0}
table.frame-none>*>tr>:first-child,table.frame-ends>*>tr>:first-child{border-left-width:0}
table.frame-none>*>tr>:last-child,table.frame-ends>*>tr>:last-child{border-right-width:0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd),table.stripes-even tr:nth-of-type(even),table.stripes-hover tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist>li>p:first-child{margin-left:-1em}
ul.checklist>li>p:first-child>.fa-square-o:first-child,ul.checklist>li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist>li>p:first-child>input[type=checkbox]:first-child{margin-right:.25em}
ul.inline{display:flex;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
td.hdlist2{word-wrap:anywhere}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:4px solid #fff;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);border-radius:50%;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt,summary{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt,summary{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]{border-bottom:1px dotted}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#header,#content,#footnotes,#footer{max-width:none}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media amzn-kf8,print{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<style>
pre { line-height: 125%; }
td.linenos .normal { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
span.linenos { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
td.linenos .special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
span.linenos.special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
pre.pygments .hll { background-color: #ffffcc }
pre.pygments { background: #f8f8f8; }
pre.pygments .tok-c { color: #3D7B7B; font-style: italic } /* Comment */
pre.pygments .tok-err { border: 1px solid #FF0000 } /* Error */
pre.pygments .tok-k { color: #008000; font-weight: bold } /* Keyword */
pre.pygments .tok-o { color: #666666 } /* Operator */
pre.pygments .tok-ch { color: #3D7B7B; font-style: italic } /* Comment.Hashbang */
pre.pygments .tok-cm { color: #3D7B7B; font-style: italic } /* Comment.Multiline */
pre.pygments .tok-cp { color: #9C6500 } /* Comment.Preproc */
pre.pygments .tok-cpf { color: #3D7B7B; font-style: italic } /* Comment.PreprocFile */
pre.pygments .tok-c1 { color: #3D7B7B; font-style: italic } /* Comment.Single */
pre.pygments .tok-cs { color: #3D7B7B; font-style: italic } /* Comment.Special */
pre.pygments .tok-gd { color: #A00000 } /* Generic.Deleted */
pre.pygments .tok-ge { font-style: italic } /* Generic.Emph */
pre.pygments .tok-gr { color: #E40000 } /* Generic.Error */
pre.pygments .tok-gh { color: #000080; font-weight: bold } /* Generic.Heading */
pre.pygments .tok-gi { color: #008400 } /* Generic.Inserted */
pre.pygments .tok-go { color: #717171 } /* Generic.Output */
pre.pygments .tok-gp { color: #000080; font-weight: bold } /* Generic.Prompt */
pre.pygments .tok-gs { font-weight: bold } /* Generic.Strong */
pre.pygments .tok-gu { color: #800080; font-weight: bold } /* Generic.Subheading */
pre.pygments .tok-gt { color: #0044DD } /* Generic.Traceback */
pre.pygments .tok-kc { color: #008000; font-weight: bold } /* Keyword.Constant */
pre.pygments .tok-kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
pre.pygments .tok-kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
pre.pygments .tok-kp { color: #008000 } /* Keyword.Pseudo */
pre.pygments .tok-kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
pre.pygments .tok-kt { color: #B00040 } /* Keyword.Type */
pre.pygments .tok-m { color: #666666 } /* Literal.Number */
pre.pygments .tok-s { color: #BA2121 } /* Literal.String */
pre.pygments .tok-na { color: #687822 } /* Name.Attribute */
pre.pygments .tok-nb { color: #008000 } /* Name.Builtin */
pre.pygments .tok-nc { color: #0000FF; font-weight: bold } /* Name.Class */
pre.pygments .tok-no { color: #880000 } /* Name.Constant */
pre.pygments .tok-nd { color: #AA22FF } /* Name.Decorator */
pre.pygments .tok-ni { color: #717171; font-weight: bold } /* Name.Entity */
pre.pygments .tok-ne { color: #CB3F38; font-weight: bold } /* Name.Exception */
pre.pygments .tok-nf { color: #0000FF } /* Name.Function */
pre.pygments .tok-nl { color: #767600 } /* Name.Label */
pre.pygments .tok-nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
pre.pygments .tok-nt { color: #008000; font-weight: bold } /* Name.Tag */
pre.pygments .tok-nv { color: #19177C } /* Name.Variable */
pre.pygments .tok-ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
pre.pygments .tok-w { color: #bbbbbb } /* Text.Whitespace */
pre.pygments .tok-mb { color: #666666 } /* Literal.Number.Bin */
pre.pygments .tok-mf { color: #666666 } /* Literal.Number.Float */
pre.pygments .tok-mh { color: #666666 } /* Literal.Number.Hex */
pre.pygments .tok-mi { color: #666666 } /* Literal.Number.Integer */
pre.pygments .tok-mo { color: #666666 } /* Literal.Number.Oct */
pre.pygments .tok-sa { color: #BA2121 } /* Literal.String.Affix */
pre.pygments .tok-sb { color: #BA2121 } /* Literal.String.Backtick */
pre.pygments .tok-sc { color: #BA2121 } /* Literal.String.Char */
pre.pygments .tok-dl { color: #BA2121 } /* Literal.String.Delimiter */
pre.pygments .tok-sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
pre.pygments .tok-s2 { color: #BA2121 } /* Literal.String.Double */
pre.pygments .tok-se { color: #AA5D1F; font-weight: bold } /* Literal.String.Escape */
pre.pygments .tok-sh { color: #BA2121 } /* Literal.String.Heredoc */
pre.pygments .tok-si { color: #A45A77; font-weight: bold } /* Literal.String.Interpol */
pre.pygments .tok-sx { color: #008000 } /* Literal.String.Other */
pre.pygments .tok-sr { color: #A45A77 } /* Literal.String.Regex */
pre.pygments .tok-s1 { color: #BA2121 } /* Literal.String.Single */
pre.pygments .tok-ss { color: #19177C } /* Literal.String.Symbol */
pre.pygments .tok-bp { color: #008000 } /* Name.Builtin.Pseudo */
pre.pygments .tok-fm { color: #0000FF } /* Name.Function.Magic */
pre.pygments .tok-vc { color: #19177C } /* Name.Variable.Class */
pre.pygments .tok-vg { color: #19177C } /* Name.Variable.Global */
pre.pygments .tok-vi { color: #19177C } /* Name.Variable.Instance */
pre.pygments .tok-vm { color: #19177C } /* Name.Variable.Magic */
pre.pygments .tok-il { color: #666666 } /* Literal.Number.Integer.Long */
</style>
</head>
<body class="article toc2 toc-left">
<div id="header">
<h1>EMEWS Tutorial</h1>
<div class="details">
<span id="author" class="author">Version 1.0 Jan 12 2024</span><br>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_emews_introduction_and_quickstart">1. EMEWS Introduction and Quickstart</a>
<ul class="sectlevel2">
<li><a href="#_extreme_scale_model_exploration_with_swift_emews">1.1. Extreme-scale Model Exploration with Swift (EMEWS)</a>
<ul class="sectlevel3">
<li><a href="#_emews_workflow_structure">1.1.1. EMEWS workflow structure</a></li>
<li><a href="#_tutorial_goals">1.1.2. Tutorial Goals</a></li>
<li><a href="#_tutorial_code">1.1.3. Tutorial Code</a></li>
<li><a href="#_emews_mailing_list">1.1.4. EMEWS Mailing List</a></li>
<li><a href="#_citing_emews">1.1.5. Citing EMEWS</a></li>
<li><a href="#_acknowledgments">1.1.6. Acknowledgments</a></li>
</ul>
</li>
<li><a href="#_quickstart">1.2. Quickstart</a></li>
</ul>
</li>
<li><a href="#uc1">2. <mark>Simple</mark> Workflows with ABM</a>
<ul class="sectlevel2">
<li><a href="#_tutorial_goals_2">2.1. Tutorial goals</a></li>
<li><a href="#_workflow_project_structure">2.2. Workflow Project Structure</a></li>
<li><a href="#_jzombie_repast_simulation">2.3. JZombie: Repast simulation</a>
<ul class="sectlevel3">
<li><a href="#_model_details">2.3.1. Model details</a></li>
</ul>
</li>
<li><a href="#_calling_a_repast_simphony_simulation_from_swiftt">2.4. Calling a Repast Simphony simulation from Swift/T</a>
<ul class="sectlevel3">
<li><a href="#_calling_the_external_application">2.4.1. Calling the External Application</a></li>
<li><a href="#_utility_functions">2.4.2. Utility Functions</a></li>
</ul>
</li>
<li><a href="#_parameter_sweeping">2.5. Parameter Sweeping</a></li>
<li><a href="#_results_analysis">2.6. Results Analysis</a>
<ul class="sectlevel3">
<li><a href="#_gathering_the_results">2.6.1. Gathering the Results</a></li>
<li><a href="#_finding_the_best_parameters">2.6.2. Finding the Best Parameters</a></li>
</ul>
</li>
<li><a href="#_running_the_swift_script">2.7. Running the Swift Script</a></li>
</ul>
</li>
<li><a href="#uc4">3. Minimizing the Ackley function with an EQSQL Workflow</a>
<ul class="sectlevel2">
<li><a href="#_tutorial_goals_3">3.1. Tutorial Goals</a></li>
<li><a href="#_running_the_workflow">3.2. Running the Workflow</a></li>
<li><a href="#_workflow_project_structure_2">3.3. Workflow Project Structure</a></li>
<li><a href="#_the_ackley_function">3.4. The Ackley Function</a></li>
<li><a href="#_calling_the_ackley_function_from_swift">3.5. Calling the Ackley Function from Swift</a>
<ul class="sectlevel3">
<li><a href="#_alternatives_to_a_bash_script">3.5.1. Alternatives to a Bash Script</a></li>
</ul>
</li>
<li><a href="#_the_ackley_me">3.6. The Ackley ME</a></li>
</ul>
</li>
<li><a href="#_installing_emews">Appendix A: Installing EMEWS</a>
<ul class="sectlevel2">
<li><a href="#_binary">A.1. Binary</a></li>
<li><a href="#_source">A.2. Source</a>
<ul class="sectlevel3">
<li><a href="#_r_on_osx_arm64">A.2.1. R on <code>osx-arm64</code></a>
<ul class="sectlevel4">
<li><a href="#_install_r_dependencies">Install R dependencies</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#_creating_emews_projects">Appendix B: Creating EMEWS Projects</a>
<ul class="sectlevel2">
<li><a href="#_installation">B.1. Installation</a></li>
<li><a href="#_using_emews_creator">B.2. Using EMEWS Creator</a></li>
<li><a href="#emews_proj_struc">B.3. EMEWS Project Structure</a>
<ul class="sectlevel3">
<li><a href="#_directories">B.3.1. Directories</a></li>
<li><a href="#_files">B.3.2. Files</a></li>
</ul>
</li>
<li><a href="#wflow_templates">B.4. Workflow Templates</a>
<ul class="sectlevel3">
<li><a href="#sweep">B.4.1. Sweep</a></li>
<li><a href="#eqpy_top">B.4.2. EQPy</a></li>
<li><a href="#eqr_top">B.4.3. EQR</a></li>
<li><a href="#eqsql_top">B.4.4. EQSQL</a></li>
</ul>
</li>
<li><a href="#_init_db">B.5. INIT DB</a></li>
</ul>
</li>
<li><a href="#_references">References</a></li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="_emews_introduction_and_quickstart">1. EMEWS Introduction and Quickstart</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_extreme_scale_model_exploration_with_swift_emews">1.1. Extreme-scale Model Exploration with Swift (EMEWS)</h3>
<div class="paragraph">
<p>Modern computational studies, involving simulation, AI/ML, or other black-box models, are campaigns consisting of large numbers of these models with many possible variations. The models may be run with different parameters, possibly as part of an automated model parameter optimization, classification, or, more generally, <strong>model exploration (ME)</strong>. Constructing the software to run
such studies at the requisite computational scales is often unnecessarily time-consuming and the resulting
software artifacts are typically difficult to generalize and
package for other users.</p>
</div>
<div class="paragraph">
<p>In this tutorial, we present a solution for many of the challenges in
running large-scale ME studies.  Our framework, Extreme-scale Model
Exploration with Swift (<strong>EMEWS</strong>) (<a href="#ozik_desktop_2016">Ozik et al. 2016</a>), uses the general-purpose parallel
scripting language Swift/T (<a href="#wozniak_swiftt_2013">Wozniak et al. 2013</a>)
to generate highly
concurrent ME workflows.  These workflows enable the flexible integration of multi-language
ME algorithms and libraries to coordinate the running and evaluation of large numbers of models.  The general-purpose nature of
the programming model also allows the user to supplement the workflows with additional
analyses and post-processing.</p>
</div>
<div class="paragraph">
<p>Our focus is on computational models that require the use of approximate, heuristic ME methods involving large ensembles. To improve the current state of the art it has been noted elsewhere that: “&#8230;&#8203;
there is a clear need to provide software frameworks for
metaheuristics that promote software reuse and reduce developmental
effort” (<a href="#boussaid_survey_2013">Boussaïd&#44; Lepagnot&#44; and Siarry 2013</a>). Our design goals are to ease
software integration while providing scalability to the largest scale
(exascale plus) supercomputers, running millions of models, thousands
at a time. EMEWS has shown robust scalability (<a href="#ozik_population_2021">Ozik et al. 2021</a>; <a href="#wozniak_candle_supervisor_2018">Wozniak et al. 2018</a>). The tools are also easy to install and run on an ordinary
laptop, requiring only an MPI (Message Passing Interface) implementation, which can be easily
obtained from common OS package repositories.</p>
</div>
<div class="sect3">
<h4 id="_emews_workflow_structure">1.1.1. EMEWS workflow structure</h4>
<div class="imageblock">
<div class="content">
<img src="images/EMEWS_figure.png" alt="EMEWS" width="640" height="480">
</div>
</div>
<div class="paragraph">
<p>This figure illustrates the main components of the EMEWS framework.  The main user interface is the Swift script, a high-level
program.  The core novel contributions of
EMEWS are shown in green, these allow the Swift script to access a
running ME algorithm.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/EMEWS_figure_EQX.png" alt="EQX Zoomed" width="640" height="480">
</div>
</div>
<div class="paragraph">
<p>The ME algorithm can be expressed in Python, R, C, C++,
Fortran, Julia, Tcl, or any language supported by Swift/T.  We provide
a high-level queue-like interface with (currently) three
implementations: EQ/Py, EQ/R, and EQSQL (EMEWS Queues for
Python, R, and SQL). The interface defines the two functions <code>OUT_put</code> and <code>IN_get</code> for sending candidate model parameters from the ME algorithm to the Swift script and getting model outputs back, respectively. The interface also allows the Swift script to obtain
candidate model parameter inputs (<code>EQX_get</code>) and return model outputs to the ME (<code>EQX_put</code>).  The models are distributed over large and distributed computer system, but smaller systems that run one
model at a time are also supported.  The models can be
implemented as external applications called through the shell, built-in interpreters, or
in-memory libraries accessed directly by Swift (for faster
invocation).</p>
</div>
<div class="paragraph">
<p>EMEWS thus offers the following contributions to the science and
practice of computational ME studies:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>It offers the capability to run very large, complex, and highly concurrent
ensembles of models of varying types on a broad range of individual or distributed computing resources;</p>
</li>
<li>
<p>It supports a wide class of model exploration algorithms,
including those increasingly available to the community via Python and R libraries;</p>
</li>
<li>
<p>It offers a software sustainability solution, in that computational workflows
based around EMEWS can easily be compared and distributed.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_tutorial_goals">1.1.2. Tutorial Goals</h4>
<div class="paragraph">
<p>This tutorial aims to describe through examples the following main elements of the EMEWS framework:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>How external ME code can be incorporated with minimal modifications</p>
</li>
<li>
<p>How the EMEWS Queues (EQ/Xs) are used to communicate between model exploration code and Swift workers</p>
</li>
<li>
<p>How EMEWS enables the scaling of simulation and black box model exploration to large and distributed computing resources</p>
</li>
<li>
<p>How modularized, multi-language code can be effectively tested and integrated within the EMEWS framework</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_tutorial_code">1.1.3. Tutorial Code</h4>
<div class="paragraph">
<p>The example use cases presented in this tutorial can be found <mark>here</mark>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/jozik/emews_next_gen_tutorial_tests/tree/main/code/uc1" target="UC1">UC1</a></p>
</li>
<li>
<p><a href="https://github.com/jozik/emews_next_gen_tutorial_tests/tree/main/code/uc4" target="UC4">UC4</a></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_emews_mailing_list">1.1.4. EMEWS Mailing List</h4>
<div class="paragraph">
<p>For questions about EMEWS or to access archived questions, please subscribe to the EMEWS mailing list:
<a href="https://lists.mcs.anl.gov/mailman/listinfo/emews" class="bare" target="mailinglist">https://lists.mcs.anl.gov/mailman/listinfo/emews</a></p>
</div>
</div>
<div class="sect3">
<h4 id="_citing_emews">1.1.5. Citing EMEWS</h4>
<div class="paragraph">
<p>To cite EMEWS, please use:</p>
</div>
<div class="paragraph">
<p>Ozik, Jonathan, Nicholson T. Collier, Justin M. Wozniak, and Carmine Spagnuolo. 2016. “From Desktop to Large-Scale Model Exploration with Swift/T.” In <em>2016 Winter Simulation Conference (WSC)</em>, 206–20. <a href="https://doi.org/10.1109/WSC.2016.7822090" class="bare">https://doi.org/10.1109/WSC.2016.7822090</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_acknowledgments">1.1.6. Acknowledgments</h4>
<div class="paragraph">
<p>Research reported in this website was supported by the National Science Foundation (2200234), the National Institutes of Health (R01GM115839, R01DA039934, R01DA055502), the U.S. Department of Energy, Office of Science, under contract number DE-AC02-06CH11357, and the DOE Office of Science through the Bio-preparedness Research Virtual Environment (BRaVE) initiative. The content is solely the responsibility of the authors and does not necessarily represent the official views of the National Science Foundation or the National Institutes of Health.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_quickstart">1.2. Quickstart</h3>
<div class="ulist">
<ul>
<li>
<p>Binary installations</p>
</li>
<li>
<p>Available distributions</p>
</li>
<li>
<p>Link to Install section below</p>
</li>
</ul>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<mark>Highlights</mark> below have in source TODOs.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="uc1">2. <mark>Simple</mark> Workflows with ABM</h2>
<div class="sectionbody">
<div class="paragraph">
<p>For a first demonstration ABM use case, we begin with an example of a Swift/T
parallel parameter sweep to explore the parameter space of a model.
This tutorial uses the project structure and files created from the
EMEWS <mark><a href="#_sweep_template">sweep template</a></mark>,
and that should be read before this.</p>
</div>
<div class="sect2">
<h3 id="_tutorial_goals_2">2.1. Tutorial goals</h3>
<div class="ulist">
<ul>
<li>
<p>Run an ABM simulation using Repast in Swift/T</p>
</li>
<li>
<p>Execute parallel parameters sweep of ABM simulation model</p>
</li>
<li>
<p>Implement parallel evaluation of the simulation results using Swift/T and R</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_workflow_project_structure">2.2. Workflow Project Structure</h3>
<div class="paragraph">
<p>The full source code for this tutorial use case can be accessed <a href="https://github.com/jozik/emews_next_gen_tutorial_tests/tree/main/code/uc1" target="UC1">here</a>.</p>
</div>
<div class="paragraph">
<p>An initial version of the project was created using the EMEWS creator with the following command issued <mark>here</mark>:</p>
</div>
<div id="uc1-creator" class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>emewscreator<span class="tok-w"> </span>-o<span class="tok-w"> </span>uc1<span class="tok-w"> </span>sweep<span class="tok-w"> </span>-c<span class="tok-w"> </span>tutorial_cfgs/UC1.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>The completed workflow project has the following directory <mark>structure and files</mark>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="text"><span></span>uc1
├── R
│   └── test
├── README.md
├── data
├── etc
│   └── emews_utils.sh
├── ext
│   └── emews
│       └── emews.swift
├── python
│   └── test
├── scripts
│   └── run_repast_uc1.sh
└── swift
    ├── cfgs
    │   └── sweep_workflow.cfg
    ├── run_sweep_workflow.sh
    └── sweep_workflow.swift</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p><mark>For running this use case, an R enabled Swift/T installation is required.</mark>
See the <a href="http://swift-lang.github.io/swift-t/guide.html#build_r" target="_blank" rel="noopener">Swift/T R Installation Guide</a> for installation details.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_jzombie_repast_simulation">2.3. JZombie: Repast simulation</h3>
<div class="paragraph">
<p>The example model used here is an adaptation of the JZombies demonstration model distributed with Repast Simphony
(<a href="https://repast.github.io/docs/RepastJavaGettingStarted.pdf" target="_blank" rel="noopener">Nick Collier and Michael North 2015</a>). This is only an example model. Any simulation
or scientific application that can be
launched from the command line can be adapted to this paradigm. The fictional Zombies
versus Humans model is intended to illustrate that EMEWS, Swift/T, and Repast Simphony are domain agnostic.</p>
</div>
<div class="sect3">
<h4 id="_model_details">2.3.1. Model details</h4>
<div class="paragraph">
<p>The model has two kinds of agents, Zombies and Humans. Zombies chase the Humans,
seeking to infect them, while Humans attempt to evade Zombies. When a
Zombie is close enough to a Human, that Human is infected and becomes a
Zombie. During a typical run all the Humans will eventually become Zombies.
These agents are located in a two dimensional continuous
space where each agent has a x and y coordinate expressed as a floating point number
(and in a corresponding discrete grid with integer coordinates).
Movement is performed in the continuous space and translated into discrete grid coordinates.
The grid is used for neighborhood queries (e.g., given a Zombie’s location, where are the nearest Humans).
The model records the grid coordinate of each agent as well as a count of each agent type (Zombie or Human)
at each time step and writes this data to two files.
The initial number of Zombies and Humans is specified
by model input parameters zombie count and human count, and the distance a Zombie or Human can move at each
time step is specified by the parameters zombie step size and human step size.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_calling_a_repast_simphony_simulation_from_swiftt">2.4. Calling a Repast Simphony simulation from Swift/T</h3>
<div class="paragraph">
<p>The full Swift/T script can be seen in <a href="https://github.com/jozik/emews_next_gen_tutorial_tests/blob/main/code/uc1/swift/uc1.swift#L1" target="uc1.swift">uc1.swift</a>.
The script consists of defining variables from environment variables and user input:</p>
</div>
<div id="variables" class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span></span><span class="tok-n">string</span><span class="tok-w"> </span><span class="tok-n">emews_root</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">getenv</span><span class="tok-p">(</span><span class="tok-s">&quot;EMEWS_PROJECT_ROOT&quot;</span><span class="tok-p">);</span>
<span class="tok-n">string</span><span class="tok-w"> </span><span class="tok-n">turbine_output</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">getenv</span><span class="tok-p">(</span><span class="tok-s">&quot;TURBINE_OUTPUT&quot;</span><span class="tok-p">);</span>

<span class="tok-n">file</span><span class="tok-w"> </span><span class="tok-n">model_sh</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">input</span><span class="tok-p">(</span><span class="tok-n">emews_root</span><span class="tok-o">+</span><span class="tok-s">&quot;/scripts/run_repast_uc1.sh&quot;</span><span class="tok-p">);</span>
<span class="tok-n">file</span><span class="tok-w"> </span><span class="tok-n">upf</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">input</span><span class="tok-p">(</span><span class="tok-n">argv</span><span class="tok-p">(</span><span class="tok-s">&quot;f&quot;</span><span class="tok-p">));</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>and then defining four functions, one that calls the simulation, which is auto-generated by the EMEWS Creator <a href="#uc1-creator">command</a>:</p>
</div>
<div id="repast-app" class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span></span><span class="tok-n">app</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">file</span><span class="tok-w"> </span><span class="tok-n">out</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">file</span><span class="tok-w"> </span><span class="tok-n">err</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-n">run_model</span><span class="tok-p">(</span><span class="tok-n">file</span><span class="tok-w"> </span><span class="tok-n">shfile</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">string</span><span class="tok-w"> </span><span class="tok-n">param_line</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">string</span><span class="tok-w"> </span><span class="tok-n">instance</span><span class="tok-p">)</span>
<span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-s">&quot;bash&quot;</span><span class="tok-w"> </span><span class="tok-n">shfile</span><span class="tok-w"> </span><span class="tok-n">param_line</span><span class="tok-w"> </span><span class="tok-n">emews_root</span><span class="tok-w"> </span><span class="tok-n">instance</span><span class="tok-w"> </span><span class="tok-nd">@stdout</span><span class="tok-o">=</span><span class="tok-n">out</span><span class="tok-w"> </span><span class="tok-nd">@stderr</span><span class="tok-o">=</span><span class="tok-n">err</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>two utility functions we create:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span></span><span class="tok-n">app</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-n">o</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-n">make_dir</span><span class="tok-p">(</span><span class="tok-n">string</span><span class="tok-w"> </span><span class="tok-n">dirname</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">  </span><span class="tok-s">&quot;mkdir&quot;</span><span class="tok-w"> </span><span class="tok-s">&quot;-p&quot;</span><span class="tok-w"> </span><span class="tok-n">dirname</span><span class="tok-p">;</span>
<span class="tok-p">}</span>

<span class="tok-n">app</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-n">o</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-n">run_prerequisites</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">  </span><span class="tok-s">&quot;cp&quot;</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">emews_root</span><span class="tok-o">+</span><span class="tok-s">&quot;/complete_model/MessageCenter.log4j.properties&quot;</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-n">turbine_output</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>followed by the code that performs the sweep, auto-generated, with the <code>run_prerequisites</code> block uncommented:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span></span><span class="tok-n">main</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">  </span><span class="tok-n">run_prerequisites</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-o">=&gt;</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-n">string</span><span class="tok-w"> </span><span class="tok-n">upf_lines</span><span class="tok-o">[]</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">file_lines</span><span class="tok-p">(</span><span class="tok-n">upf</span><span class="tok-p">);</span>
<span class="tok-w">    </span><span class="tok-n">foreach</span><span class="tok-w"> </span><span class="tok-n">s</span><span class="tok-p">,</span><span class="tok-n">i</span><span class="tok-w"> </span><span class="tok-n">in</span><span class="tok-w"> </span><span class="tok-n">upf_lines</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">      </span><span class="tok-n">string</span><span class="tok-w"> </span><span class="tok-n">instance</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-s">&quot;%s/instance_%i/&quot;</span><span class="tok-w"> </span><span class="tok-o">%</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">turbine_output</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">i</span><span class="tok-o">+</span><span class="tok-mi">1</span><span class="tok-p">);</span>
<span class="tok-w">      </span><span class="tok-n">make_dir</span><span class="tok-p">(</span><span class="tok-n">instance</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-o">=&gt;</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">        </span><span class="tok-n">file</span><span class="tok-w"> </span><span class="tok-n">out</span><span class="tok-w"> </span><span class="tok-o">&lt;</span><span class="tok-n">instance</span><span class="tok-o">+</span><span class="tok-s">&quot;out.txt&quot;</span><span class="tok-o">&gt;</span><span class="tok-p">;</span>
<span class="tok-w">        </span><span class="tok-n">file</span><span class="tok-w"> </span><span class="tok-n">err</span><span class="tok-w"> </span><span class="tok-o">&lt;</span><span class="tok-n">instance</span><span class="tok-o">+</span><span class="tok-s">&quot;err.txt&quot;</span><span class="tok-o">&gt;</span><span class="tok-p">;</span>
<span class="tok-w">        </span><span class="tok-p">(</span><span class="tok-n">out</span><span class="tok-p">,</span><span class="tok-n">err</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">run_model</span><span class="tok-p">(</span><span class="tok-n">model_sh</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">s</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">instance</span><span class="tok-p">);</span>
<span class="tok-w">      </span><span class="tok-p">}</span>
<span class="tok-w">    </span><span class="tok-p">}</span>
<span class="tok-w">  </span><span class="tok-p">}</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here we see how the EMEWS Creator allows for very minimal adjustment of the workflow code to adapt to specific use cases.</p>
</div>
<div class="sect3">
<h4 id="_calling_the_external_application">2.4.1. Calling the External Application</h4>
<div class="paragraph">
<p>In order for Swift/T to call our external application (i.e., the Zombies model),
we define an
<mark><a href="#_external_execution">app</a></mark> function.
(The Zombies model is written in Java which is not easily called via Tcl and thus an app function is the best
choice for integrating the model into a Swift script. See the Swift/T Tutorial for more details.) Repast Simphony provides command line compatible functionality
via an InstanceRunner class, for passing a set of parameters to a model and performing a single headless
run of the model using those parameters. Using the InstanceRunner main class, Repast Simphony models can be launched by other
control applications such as a bash, slurm, or Swift scripts.  We have wrapped the command line invocation of
Repast Simphony&#8217;s InstanceRunner in a bash script <a href="https://github.com/jozik/emews_next_gen_tutorial_tests/blob/main/code/uc1/scripts/run_repast_uc1.sh#L1" target="run_repast_uc1.sh">run_repast_uc1.sh</a>
 to ease command line usage.</p>
</div>
<div class="paragraph">
<p>Other non-Repast Simphony models or scientific applications with command line interfaces can be wrapped
and run similarly.</p>
</div>
<div class="paragraph">
<p>An annotated version of the Swift app function that calls Repast Simphony is shown <a href="#repast-app">below</a>.
Prior to the actual function definition, the environment variable
EMEWS_PROJECT_ROOT is accessed. This variable is used to define the project&#8217;s top level
directory, relative to which other directories (e.g., the directory
that contains the Zombies model) are defined. The value of the TURBINE_OUTPUT
environment variable is also retrieved. This specifies the path to
a directory where Swift/T stores its log files and which we will use
as a parent directory for the working directories of our individual runs.
For more on these variables see the
<mark><a href="#swift_run_sweep_sh">discussion</a></mark> in the template tutorial.</p>
</div>
<div id="repast-app-annot" class="listingblock">
<div class="title">Repast Simphony App Function</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span></span><span class="tok-n">app</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">file</span><span class="tok-w"> </span><span class="tok-n">out</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">file</span><span class="tok-w"> </span><span class="tok-n">err</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-n">run_model</span><span class="tok-p">(</span><span class="tok-n">file</span><span class="tok-w"> </span><span class="tok-n">shfile</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">string</span><span class="tok-w"> </span><span class="tok-n">param_line</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">string</span><span class="tok-w"> </span><span class="tok-n">instance</span><span class="tok-p">)</span><span class="tok-w">  </span><i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-s">&quot;bash&quot;</span><span class="tok-w"> </span><span class="tok-n">shfile</span><span class="tok-w"> </span><span class="tok-n">param_line</span><span class="tok-w"> </span><span class="tok-n">emews_root</span><span class="tok-w"> </span><span class="tok-n">instance</span><span class="tok-w"> </span><span class="tok-nd">@stdout</span><span class="tok-o">=</span><span class="tok-n">out</span><span class="tok-w"> </span><span class="tok-nd">@stderr</span><span class="tok-o">=</span><span class="tok-n">err</span><span class="tok-p">;</span><span class="tok-w">  </span><i class="conum" data-value="2"></i><b>(2)</b>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The app function definition begins. The function returns two files, one for standard output and one for standard error.
The function arguments are those required to run <a href="https://github.com/jozik/emews_next_gen_tutorial_tests/blob/main/code/uc1/scripts/run_repast_uc1.sh#L1" target="run_repast_uc1.sh">run_repast_uc1.sh</a>, that is,
the full path of the script, the parameters to run and the directory where the model run output should be written.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The body of the function calls the bash interpreter passing it the name of the script file to execute and the other function
arguments as well as the project root, that is, <code>emews_root</code> directory.
<code>@stdout=out</code> and <code>@stderr=err</code> redirect stdout and stderr to the files out and err.
It should be easy to see how any model or application that can be run from the command line
and wrapped in a bash script can be called from Swift in this way.</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_utility_functions">2.4.2. Utility Functions</h4>
<div class="paragraph">
<p>As mentioned above, the Swift script also contains two utility app functions.</p>
</div>
<div id="util-app-annot" class="listingblock">
<div class="title">Utility Functions</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span></span><span class="tok-n">app</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-n">o</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-n">make_dir</span><span class="tok-p">(</span><span class="tok-n">string</span><span class="tok-w"> </span><span class="tok-n">dirname</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w"> </span><i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-w">  </span><span class="tok-s">&quot;mkdir&quot;</span><span class="tok-w"> </span><span class="tok-s">&quot;-p&quot;</span><span class="tok-w"> </span><span class="tok-n">dirname</span><span class="tok-p">;</span>
<span class="tok-p">}</span>

<span class="tok-n">app</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-kt">void</span><span class="tok-w"> </span><span class="tok-n">o</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-n">run_prerequisites</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w">  </span><i class="conum" data-value="2"></i><b>(2)</b>
<span class="tok-w">  </span><span class="tok-s">&quot;cp&quot;</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">emews_root</span><span class="tok-o">+</span><span class="tok-s">&quot;/complete_model/MessageCenter.log4j.properties&quot;</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-n">turbine_output</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>make_dir</code> simply calls the Unix <code>mkdir</code> command to create a specified directory</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>run_prerequisites</code> calls the unix <code>cp</code> command to copy a Repast Simphony logging configuration file into
the current working directory.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Both of these are used by the parameter sweeping part of the script.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_parameter_sweeping">2.5. Parameter Sweeping</h3>
<div class="paragraph">
<p>The remainder of the Swift script performs a simple parameter sweep using the <code>run_model</code> app function to run the model.
The parameters over which we want to sweep are defined in an external file, the so-called unrolled parameter file (UPF),
where each row of the file contains a parameter set for an individual run. The script will read
these parameter sets and launch as many parallel runs as possible for a given process configuration,
passing each run an individual parameter set. The general script flow is as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Read the the list of parameters into a <code>file</code> object.</p>
</li>
<li>
<p>Split the contents of the file into lines and store each as an array element.</p>
</li>
<li>
<p>Iterate over the array in parallel, launching a model run
for each parameter set (i.e., array element) in the array, using
the <code>run_model</code> app function.</p>
</li>
</ul>
</div>
<div id="sweep-annot" class="listingblock">
<div class="title">Parameters Sweep</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span></span><span class="tok-n">string</span><span class="tok-w"> </span><span class="tok-n">emews_root</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">getenv</span><span class="tok-p">(</span><span class="tok-s">&quot;EMEWS_PROJECT_ROOT&quot;</span><span class="tok-p">);</span>
<span class="tok-n">string</span><span class="tok-w"> </span><span class="tok-n">turbine_output</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">getenv</span><span class="tok-p">(</span><span class="tok-s">&quot;TURBINE_OUTPUT&quot;</span><span class="tok-p">);</span>

<span class="tok-n">file</span><span class="tok-w"> </span><span class="tok-n">model_sh</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">input</span><span class="tok-p">(</span><span class="tok-n">emews_root</span><span class="tok-o">+</span><span class="tok-s">&quot;/scripts/run_repast_uc1.sh&quot;</span><span class="tok-p">);</span><span class="tok-w">  </span><i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-n">file</span><span class="tok-w"> </span><span class="tok-n">upf</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">input</span><span class="tok-p">(</span><span class="tok-n">argv</span><span class="tok-p">(</span><span class="tok-s">&quot;f&quot;</span><span class="tok-p">));</span><span class="tok-w">  </span><i class="conum" data-value="2"></i><b>(2)</b>

<span class="tok-n">main</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">  </span><span class="tok-n">run_prerequisites</span><span class="tok-p">()</span><span class="tok-w"> </span><span class="tok-o">=&gt;</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w">  </span><i class="conum" data-value="3"></i><b>(3)</b>
<span class="tok-w">    </span><span class="tok-n">string</span><span class="tok-w"> </span><span class="tok-n">upf_lines</span><span class="tok-o">[]</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">file_lines</span><span class="tok-p">(</span><span class="tok-n">upf</span><span class="tok-p">);</span><span class="tok-w">  </span><i class="conum" data-value="4"></i><b>(4)</b>
<span class="tok-w">    </span><span class="tok-n">foreach</span><span class="tok-w"> </span><span class="tok-n">s</span><span class="tok-p">,</span><span class="tok-n">i</span><span class="tok-w"> </span><span class="tok-n">in</span><span class="tok-w"> </span><span class="tok-n">upf_lines</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w">  </span><i class="conum" data-value="5"></i><b>(5)</b>
<span class="tok-w">      </span><span class="tok-n">string</span><span class="tok-w"> </span><span class="tok-n">instance</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-s">&quot;%s/instance_%i/&quot;</span><span class="tok-w"> </span><span class="tok-o">%</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">turbine_output</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">i</span><span class="tok-o">+</span><span class="tok-mi">1</span><span class="tok-p">);</span>
<span class="tok-w">      </span><span class="tok-n">make_dir</span><span class="tok-p">(</span><span class="tok-n">instance</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-o">=&gt;</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w">  </span><i class="conum" data-value="6"></i><b>(6)</b>
<span class="tok-w">        </span><span class="tok-n">file</span><span class="tok-w"> </span><span class="tok-n">out</span><span class="tok-w"> </span><span class="tok-o">&lt;</span><span class="tok-n">instance</span><span class="tok-o">+</span><span class="tok-s">&quot;out.txt&quot;</span><span class="tok-o">&gt;</span><span class="tok-p">;</span>
<span class="tok-w">        </span><span class="tok-n">file</span><span class="tok-w"> </span><span class="tok-n">err</span><span class="tok-w"> </span><span class="tok-o">&lt;</span><span class="tok-n">instance</span><span class="tok-o">+</span><span class="tok-s">&quot;err.txt&quot;</span><span class="tok-o">&gt;</span><span class="tok-p">;</span><span class="tok-w">  </span><i class="conum" data-value="7"></i><b>(7)</b>
<span class="tok-w">        </span><span class="tok-p">(</span><span class="tok-n">out</span><span class="tok-p">,</span><span class="tok-n">err</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">run_model</span><span class="tok-p">(</span><span class="tok-n">model_sh</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">s</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">instance</span><span class="tok-p">);</span><span class="tok-w">  </span><i class="conum" data-value="8"></i><b>(8)</b>
<span class="tok-w">      </span><span class="tok-p">}</span>
<span class="tok-w">    </span><span class="tok-p">}</span>
<span class="tok-w">  </span><span class="tok-p">}</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Initialize a Swift/T <code>file</code> variable with the location of the <code>run_repast_uc1.sh</code> script file. Note that the Swift/T <code>input</code>
function takes a path and returns a <code>file</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The path of the parameter file that contains
the parameter sets that will be passed as input to the Zombies model is defined, also as a <code>file</code> variable.
This line uses
the swift built-in function <code>argv</code> to parse command line arguments to the Swift script.
As indicated earlier, each line of this <code>upf</code> file contains an individual parameter set, that is,
the random_seed, zombie_count, human_count, zombie_step_size and human_step_size
for a single model run. The parameter set is passed as a single string
(e.g., random_seed = 14344, zombie_count = 10, &#8230;&#8203;)
to the Zombies model where it is parsed into the individual parameters.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Script execution begins by calling the <code>run_prerequisites</code> app function.
In the absence of any data flow dependency, Swift statements will execute in parallel whenever possible.
However, in our case, the Repast Simphony logging configuration file must be in place before a Zombie model run begins.
The <code>&#8658;</code> symbol enforces the required sequential execution:
the code on its left-hand side must complete execution before the code on the right-hand side begins execution.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Read the <code>upf</code> file into an array of strings where each line of the file is an element in the array.
The built-in Swift <code>file_lines</code> function (requires import of files module at the top of <a href="https://github.com/jozik/emews_next_gen_tutorial_tests/blob/main/code/uc1/swift/uc1.swift#L3" target="uc1.swift">uc1.swift</a>)
is used to read the upf file into this array of strings.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>The <code>foreach</code> loop
executes its loop iterations in parallel. In the <code>foreach</code> loop, the variable <code>s</code> is set to an
array element (that is, a single parameter set represented as a string) while the variable <code>i</code> is the index of that array element.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Create an instance directory into which each model run will write its output. The <code>make_dir</code> app function
is used to create the directory. The <code>&#8658;</code> keyword is again used to ensure that the directory is created before the actual model
run that uses that directory is performed.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Create file objects into which the standard out and standard error streams are
redirected by the <a href="#repast-app-annot">run_model</a> <mark>function</mark>.</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>Lastly the <code>run_model</code> app function that performs the Zombie model run is called with the required arguments.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This is a common pattern in EMEWS. Some collection of parameters is parsed into an array in which each element
is the set of parameters for an individual run. A foreach loop is then
used to iterate over the array, launching parallel model runs each with
their own parameters. In this way the number of model runs that can be
performed in parallel is limited only by hardware resources.</p>
</div>
</div>
<div class="sect2">
<h3 id="_results_analysis">2.6. Results Analysis</h3>
<div class="paragraph">
<p>In our initial script we have seen how to run multiple instances of the Zombies model in parallel, each with a different set of parameters.
Our next example builds on this by adding some post-run analysis that explores the effect of simulated step size on the final
number of humans. This analysis will be performed in R and executed within the Swift workflow.</p>
</div>
<div class="paragraph">
<p>The new script consists of the following steps:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Read the the list of a parameters into a <code>file</code> object.</p>
</li>
<li>
<p>Split the contents of the file into an array where each line of file is an array element.</p>
</li>
<li>
<p>Iterate over the array in parallel, launching a model run
for each parameter set (i.e. array element) in the array, using
the repast app function.</p>
</li>
<li>
<p>Get the final human count from each run using R, and add it to an array.</p>
</li>
<li>
<p>Also using R, determine the maximum human counts.</p>
</li>
<li>
<p>Get the parameters that produced those maximum human counts.</p>
</li>
<li>
<p>Write those parameters to a file.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This example assumes an existing parameter file in which zombie_step_size and human_step_size are varied.
For each run of the model, that is, for each combination of parameters, the model records a count of
each agent type at each time step in an output file. As before the script will iterate through the
file performing as many runs as possible in parallel. However, an additional step that reads each output file and
determines the parameter combination or combinations that resulted in the most humans surviving at the
final time step has been added.</p>
</div>
<div class="paragraph">
<p>The full updated swift code is in <a href="https://github.com/jozik/emews_next_gen_tutorial_tests/blob/main/code/uc1/swift/uc1_R.swift#L1" target="uc1_R.swift">uc1_R.swift</a>.</p>
</div>
<div class="paragraph">
<p>The updated code includes embedded R code that can be invoked using Swift&#8217;s <code>R</code> function:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span></span><span class="tok-kn">import</span><span class="tok-w"> </span><span class="tok-nn">R</span><span class="tok-p">;</span>

<span class="tok-n">string</span><span class="tok-w"> </span><span class="tok-n">count_humans</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-o">----</span>
<span class="tok-n">last</span><span class="tok-p">.</span><span class="tok-na">row</span><span class="tok-w"> </span><span class="tok-o">&lt;-</span><span class="tok-w"> </span><span class="tok-n">tail</span><span class="tok-p">(</span><span class="tok-n">read</span><span class="tok-p">.</span><span class="tok-na">csv</span><span class="tok-p">(</span><span class="tok-s">&quot;%s/counts.csv&quot;</span><span class="tok-p">),</span><span class="tok-w"> </span><span class="tok-mi">1</span><span class="tok-p">)</span>
<span class="tok-n">res</span><span class="tok-w"> </span><span class="tok-o">&lt;-</span><span class="tok-w"> </span><span class="tok-n">last</span><span class="tok-p">.</span><span class="tok-na">row</span><span class="tok-o">[</span><span class="tok-s">&quot;human_count&quot;</span><span class="tok-o">]</span>
<span class="tok-o">----</span><span class="tok-p">;</span>

<span class="tok-n">string</span><span class="tok-w"> </span><span class="tok-n">find_max</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w">  </span><span class="tok-o">----</span>
<span class="tok-n">v</span><span class="tok-w"> </span><span class="tok-o">&lt;-</span><span class="tok-w"> </span><span class="tok-n">c</span><span class="tok-p">(</span><span class="tok-o">%</span><span class="tok-n">s</span><span class="tok-p">)</span>
<span class="tok-n">res</span><span class="tok-w"> </span><span class="tok-o">&lt;-</span><span class="tok-w"> </span><span class="tok-n">which</span><span class="tok-p">(</span><span class="tok-n">v</span><span class="tok-w"> </span><span class="tok-o">==</span><span class="tok-w"> </span><span class="tok-n">max</span><span class="tok-p">(</span><span class="tok-n">v</span><span class="tok-p">))</span>
<span class="tok-o">----</span><span class="tok-p">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>an expanded <code>foreach</code> loop:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span></span><span class="tok-n">string</span><span class="tok-w"> </span><span class="tok-n">upf_lines</span><span class="tok-o">[]</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">file_lines</span><span class="tok-p">(</span><span class="tok-n">upf</span><span class="tok-p">);</span>
<span class="tok-n">string</span><span class="tok-w"> </span><span class="tok-n">results</span><span class="tok-o">[]</span><span class="tok-p">;</span>
<span class="tok-n">foreach</span><span class="tok-w"> </span><span class="tok-n">s</span><span class="tok-p">,</span><span class="tok-n">i</span><span class="tok-w"> </span><span class="tok-n">in</span><span class="tok-w"> </span><span class="tok-n">upf_lines</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">  </span><span class="tok-n">string</span><span class="tok-w"> </span><span class="tok-n">instance</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-s">&quot;%s/instance_%i/&quot;</span><span class="tok-w"> </span><span class="tok-o">%</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">turbine_output</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">i</span><span class="tok-o">+</span><span class="tok-mi">1</span><span class="tok-p">);</span>
<span class="tok-w">  </span><span class="tok-n">make_dir</span><span class="tok-p">(</span><span class="tok-n">instance</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-o">=&gt;</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-n">file</span><span class="tok-w"> </span><span class="tok-n">out</span><span class="tok-w"> </span><span class="tok-o">&lt;</span><span class="tok-n">instance</span><span class="tok-o">+</span><span class="tok-s">&quot;out.txt&quot;</span><span class="tok-o">&gt;</span><span class="tok-p">;</span>
<span class="tok-w">    </span><span class="tok-n">file</span><span class="tok-w"> </span><span class="tok-n">err</span><span class="tok-w"> </span><span class="tok-o">&lt;</span><span class="tok-n">instance</span><span class="tok-o">+</span><span class="tok-s">&quot;err.txt&quot;</span><span class="tok-o">&gt;</span><span class="tok-p">;</span>
<span class="tok-w">    </span><span class="tok-p">(</span><span class="tok-n">out</span><span class="tok-p">,</span><span class="tok-n">err</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">run_model</span><span class="tok-p">(</span><span class="tok-n">model_sh</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">s</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">instance</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-o">=&gt;</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">      </span><span class="tok-n">string</span><span class="tok-w"> </span><span class="tok-n">code</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">count_humans</span><span class="tok-w"> </span><span class="tok-o">%</span><span class="tok-w"> </span><span class="tok-n">instance</span><span class="tok-p">;</span>
<span class="tok-w">      </span><span class="tok-n">results</span><span class="tok-o">[</span><span class="tok-n">i</span><span class="tok-o">]</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">R</span><span class="tok-p">(</span><span class="tok-n">code</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-s">&quot;toString(res)&quot;</span><span class="tok-p">);</span>
<span class="tok-w">    </span><span class="tok-p">}</span>
<span class="tok-w">  </span><span class="tok-p">}</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>and calls to the post processing code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span></span><span class="tok-n">string</span><span class="tok-w"> </span><span class="tok-n">results_str</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">string_join</span><span class="tok-p">(</span><span class="tok-n">results</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-s">&quot;,&quot;</span><span class="tok-p">);</span>
<span class="tok-n">string</span><span class="tok-w"> </span><span class="tok-n">code</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">find_max</span><span class="tok-w"> </span><span class="tok-o">%</span><span class="tok-w"> </span><span class="tok-n">results_str</span><span class="tok-p">;</span>
<span class="tok-n">string</span><span class="tok-w"> </span><span class="tok-n">maxs</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">R</span><span class="tok-p">(</span><span class="tok-n">code</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-s">&quot;toString(res)&quot;</span><span class="tok-p">);</span>
<span class="tok-n">string</span><span class="tok-w"> </span><span class="tok-n">max_idxs</span><span class="tok-o">[]</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">split</span><span class="tok-p">(</span><span class="tok-n">maxs</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-s">&quot;,&quot;</span><span class="tok-p">);</span>
<span class="tok-n">string</span><span class="tok-w"> </span><span class="tok-n">best_params</span><span class="tok-o">[]</span><span class="tok-p">;</span>
<span class="tok-n">foreach</span><span class="tok-w"> </span><span class="tok-n">s</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">i</span><span class="tok-w"> </span><span class="tok-n">in</span><span class="tok-w"> </span><span class="tok-n">max_idxs</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">  </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-n">idx</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">toint</span><span class="tok-p">(</span><span class="tok-n">trim</span><span class="tok-p">(</span><span class="tok-n">s</span><span class="tok-p">));</span>
<span class="tok-w">  </span><span class="tok-n">best_params</span><span class="tok-o">[</span><span class="tok-n">i</span><span class="tok-o">]</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">upf_lines</span><span class="tok-o">[</span><span class="tok-n">idx</span><span class="tok-w"> </span><span class="tok-o">-</span><span class="tok-w"> </span><span class="tok-mi">1</span><span class="tok-o">]</span><span class="tok-p">;</span>
<span class="tok-p">}</span>
<span class="tok-n">file</span><span class="tok-w"> </span><span class="tok-n">best_out</span><span class="tok-w"> </span><span class="tok-o">&lt;</span><span class="tok-n">emews_root</span><span class="tok-w"> </span><span class="tok-o">+</span><span class="tok-w"> </span><span class="tok-s">&quot;/output/best_parameters.txt&quot;</span><span class="tok-o">&gt;</span><span class="tok-w"> </span><span class="tok-o">=</span>
<span class="tok-w">  </span><span class="tok-n">write</span><span class="tok-p">(</span><span class="tok-n">string_join</span><span class="tok-p">(</span><span class="tok-n">best_params</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-s">&quot;\n&quot;</span><span class="tok-p">));</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We describe this in two parts. The first describes the changes to the <code>foreach</code> loop to gather the output and the
second describes how that output is analyzed to determine the "best" parameter combination.</p>
</div>
<div class="sect3">
<h4 id="_gathering_the_results">2.6.1. Gathering the Results</h4>
<div id="enhanced-foreach-annot" class="listingblock">
<div class="title">Enhanced foreach loop</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span></span><span class="tok-kn">import</span><span class="tok-w"> </span><span class="tok-nn">R</span><span class="tok-p">;</span><span class="tok-w">  </span><i class="conum" data-value="1"></i><b>(1)</b>

<span class="tok-n">string</span><span class="tok-w"> </span><span class="tok-n">count_humans</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-o">----</span><span class="tok-w">  </span><i class="conum" data-value="2"></i><b>(2)</b>
<span class="tok-n">last</span><span class="tok-p">.</span><span class="tok-na">row</span><span class="tok-w"> </span><span class="tok-o">&lt;-</span><span class="tok-w"> </span><span class="tok-n">tail</span><span class="tok-p">(</span><span class="tok-n">read</span><span class="tok-p">.</span><span class="tok-na">csv</span><span class="tok-p">(</span><span class="tok-s">&quot;%s/counts.csv&quot;</span><span class="tok-p">),</span><span class="tok-w"> </span><span class="tok-mi">1</span><span class="tok-p">)</span><span class="tok-w">  </span><i class="conum" data-value="3"></i><b>(3)</b>
<span class="tok-n">res</span><span class="tok-w"> </span><span class="tok-o">&lt;-</span><span class="tok-w"> </span><span class="tok-n">last</span><span class="tok-p">.</span><span class="tok-na">row</span><span class="tok-o">[</span><span class="tok-s">&quot;human_count&quot;</span><span class="tok-o">]</span><span class="tok-w">  </span><i class="conum" data-value="4"></i><b>(4)</b>
<span class="tok-o">----</span><span class="tok-p">;</span>

<span class="tok-p">...</span>

<span class="tok-n">string</span><span class="tok-w"> </span><span class="tok-n">upf_lines</span><span class="tok-o">[]</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">file_lines</span><span class="tok-p">(</span><span class="tok-n">upf</span><span class="tok-p">);</span>
<span class="tok-n">string</span><span class="tok-w"> </span><span class="tok-n">results</span><span class="tok-o">[]</span><span class="tok-p">;</span><span class="tok-w">  </span><i class="conum" data-value="5"></i><b>(5)</b>
<span class="tok-n">foreach</span><span class="tok-w"> </span><span class="tok-n">s</span><span class="tok-p">,</span><span class="tok-n">i</span><span class="tok-w"> </span><span class="tok-n">in</span><span class="tok-w"> </span><span class="tok-n">upf_lines</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">  </span><span class="tok-n">string</span><span class="tok-w"> </span><span class="tok-n">instance</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-s">&quot;%s/instance_%i/&quot;</span><span class="tok-w"> </span><span class="tok-o">%</span><span class="tok-w"> </span><span class="tok-p">(</span><span class="tok-n">turbine_output</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">i</span><span class="tok-o">+</span><span class="tok-mi">1</span><span class="tok-p">);</span>
<span class="tok-w">  </span><span class="tok-n">make_dir</span><span class="tok-p">(</span><span class="tok-n">instance</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-o">=&gt;</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">    </span><span class="tok-n">file</span><span class="tok-w"> </span><span class="tok-n">out</span><span class="tok-w"> </span><span class="tok-o">&lt;</span><span class="tok-n">instance</span><span class="tok-o">+</span><span class="tok-s">&quot;out.txt&quot;</span><span class="tok-o">&gt;</span><span class="tok-p">;</span>
<span class="tok-w">    </span><span class="tok-n">file</span><span class="tok-w"> </span><span class="tok-n">err</span><span class="tok-w"> </span><span class="tok-o">&lt;</span><span class="tok-n">instance</span><span class="tok-o">+</span><span class="tok-s">&quot;err.txt&quot;</span><span class="tok-o">&gt;</span><span class="tok-p">;</span>
<span class="tok-w">    </span><span class="tok-p">(</span><span class="tok-n">out</span><span class="tok-p">,</span><span class="tok-n">err</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">run_model</span><span class="tok-p">(</span><span class="tok-n">model_sh</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">s</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">instance</span><span class="tok-p">)</span><span class="tok-w"> </span><span class="tok-o">=&gt;</span><span class="tok-w"> </span><span class="tok-p">{</span>
<span class="tok-w">      </span><span class="tok-n">string</span><span class="tok-w"> </span><span class="tok-n">code</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">count_humans</span><span class="tok-w"> </span><span class="tok-o">%</span><span class="tok-w"> </span><span class="tok-n">instance</span><span class="tok-p">;</span><span class="tok-w">  </span><i class="conum" data-value="6"></i><b>(6)</b>
<span class="tok-w">      </span><span class="tok-n">results</span><span class="tok-o">[</span><span class="tok-n">i</span><span class="tok-o">]</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">R</span><span class="tok-p">(</span><span class="tok-n">code</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-s">&quot;toString(res)&quot;</span><span class="tok-p">);</span><span class="tok-w">  </span><i class="conum" data-value="7"></i><b>(7)</b>
<span class="tok-w">    </span><span class="tok-p">}</span>
<span class="tok-w">  </span><span class="tok-p">}</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>To use Swift/T&#8217;s support for the R language, the R module is imported.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>A multiline R script, delineated by <code>----</code>, is assigned to the <code>count_humans</code> string variable.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The string contains a template character, "%s", which is replaced with the actual directory (described below) in which the output file (counts.csv) is written.
The R script reads the CSV file produced by a model run into a data frame.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The last row of the data frame is accessed and the value of the <code>human_count</code> column in that row is
assigned to a <code>res</code> variable.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>A <code>results</code> array is initialized.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>The <code>run_model</code> call is followed by the execution of the R script. First, the template substitution is performed with the directory for the current run, using the "%" format Swift operator.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>R code can be run using Swift&#8217;s <code>R</code> function. <code>R</code> takes two arguments, the R code to run,
and an additional R statement that generates the desired return value of the R
code as a string. The return statement is typically, as seen here, something like <code>"toString(res)"</code>
where R&#8217;s <code>toString</code> function is passed a variable that contains what
you want to return from the R script. In this case, the <code>res</code> variable contains the number of surviving humans.
This string is then placed in the <code>results</code> array at the ith index.</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_finding_the_best_parameters">2.6.2. Finding the Best Parameters</h4>
<div class="paragraph">
<p>The final workflow steps are to determine which runs yielded the maximum
number of humans and write out the parameters for those runs. The core idea here is
that we find the indices of the elements in the
results array that contain the maximum human counts and use those indices
to retrieve the parameters from the parameters array.</p>
</div>
<div id="find-best-param-annot" class="listingblock">
<div class="title">Finding the best parameter</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="java"><span></span><span class="tok-n">string</span><span class="tok-w"> </span><span class="tok-n">find_max</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w">  </span><span class="tok-o">----</span>
<span class="tok-n">v</span><span class="tok-w"> </span><span class="tok-o">&lt;-</span><span class="tok-w"> </span><span class="tok-n">c</span><span class="tok-p">(</span><span class="tok-o">%</span><span class="tok-n">s</span><span class="tok-p">)</span><span class="tok-w">  </span><i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-n">res</span><span class="tok-w"> </span><span class="tok-o">&lt;-</span><span class="tok-w"> </span><span class="tok-n">which</span><span class="tok-p">(</span><span class="tok-n">v</span><span class="tok-w"> </span><span class="tok-o">==</span><span class="tok-w"> </span><span class="tok-n">max</span><span class="tok-p">(</span><span class="tok-n">v</span><span class="tok-p">))</span><span class="tok-w">  </span><i class="conum" data-value="2"></i><b>(2)</b>
<span class="tok-o">----</span><span class="tok-p">;</span>

<span class="tok-p">...</span>

<span class="tok-n">string</span><span class="tok-w"> </span><span class="tok-n">results_str</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">string_join</span><span class="tok-p">(</span><span class="tok-n">results</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-s">&quot;,&quot;</span><span class="tok-p">);</span><span class="tok-w">  </span><i class="conum" data-value="3"></i><b>(3)</b>
<span class="tok-n">string</span><span class="tok-w"> </span><span class="tok-n">code</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">find_max</span><span class="tok-w"> </span><span class="tok-o">%</span><span class="tok-w"> </span><span class="tok-n">results_str</span><span class="tok-p">;</span><span class="tok-w">  </span><i class="conum" data-value="4"></i><b>(4)</b>
<span class="tok-n">string</span><span class="tok-w"> </span><span class="tok-n">maxs</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">R</span><span class="tok-p">(</span><span class="tok-n">code</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-s">&quot;toString(res)&quot;</span><span class="tok-p">);</span><span class="tok-w">  </span><i class="conum" data-value="5"></i><b>(5)</b>
<span class="tok-n">string</span><span class="tok-w"> </span><span class="tok-n">max_idxs</span><span class="tok-o">[]</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">split</span><span class="tok-p">(</span><span class="tok-n">maxs</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-s">&quot;,&quot;</span><span class="tok-p">);</span><span class="tok-w">  </span><i class="conum" data-value="6"></i><b>(6)</b>
<span class="tok-n">string</span><span class="tok-w"> </span><span class="tok-n">best_params</span><span class="tok-o">[]</span><span class="tok-p">;</span>
<span class="tok-n">foreach</span><span class="tok-w"> </span><span class="tok-n">s</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-n">i</span><span class="tok-w"> </span><span class="tok-n">in</span><span class="tok-w"> </span><span class="tok-n">max_idxs</span><span class="tok-w"> </span><span class="tok-p">{</span><span class="tok-w">  </span><i class="conum" data-value="7"></i><b>(7)</b>
<span class="tok-w">  </span><span class="tok-kt">int</span><span class="tok-w"> </span><span class="tok-n">idx</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">toint</span><span class="tok-p">(</span><span class="tok-n">trim</span><span class="tok-p">(</span><span class="tok-n">s</span><span class="tok-p">));</span><span class="tok-w">  </span><i class="conum" data-value="8"></i><b>(8)</b>
<span class="tok-w">  </span><span class="tok-n">best_params</span><span class="tok-o">[</span><span class="tok-n">i</span><span class="tok-o">]</span><span class="tok-w"> </span><span class="tok-o">=</span><span class="tok-w"> </span><span class="tok-n">upf_lines</span><span class="tok-o">[</span><span class="tok-n">idx</span><span class="tok-w"> </span><span class="tok-o">-</span><span class="tok-w"> </span><span class="tok-mi">1</span><span class="tok-o">]</span><span class="tok-p">;</span><span class="tok-w">  </span><i class="conum" data-value="9"></i><b>(9)</b>
<span class="tok-p">}</span>
<span class="tok-n">file</span><span class="tok-w"> </span><span class="tok-n">best_out</span><span class="tok-w"> </span><span class="tok-o">&lt;</span><span class="tok-n">emews_root</span><span class="tok-w"> </span><span class="tok-o">+</span><span class="tok-w"> </span><span class="tok-s">&quot;/output/best_parameters.txt&quot;</span><span class="tok-o">&gt;</span><span class="tok-w"> </span><span class="tok-o">=</span>
<span class="tok-w">  </span><span class="tok-n">write</span><span class="tok-p">(</span><span class="tok-n">string_join</span><span class="tok-p">(</span><span class="tok-n">best_params</span><span class="tok-p">,</span><span class="tok-w"> </span><span class="tok-s">&quot;\n&quot;</span><span class="tok-p">));</span><span class="tok-w">  </span><i class="conum" data-value="10"></i><b>(10)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The R script takes in the results from all of the model runs, as a comma separated string of values, through the "%s" template character (assigned below).</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The (1-based) indices of the maximum values are found and stored in the <code>res</code> variable.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Swift&#8217;s <code>string_join</code> function (requiring importing the string module) is used to join all the elements of the results array,
i.e., all the final human counts, into a comma separated string.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The comma separated string is assigned to the template character in the <code>find_max</code> R script and assigned to the <code>code</code> string.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>As before, Swift&#8217;s R function is called with the <code>code</code> string to yield the max indices.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>This string is split into a <code>max_idxs</code> array using Swift&#8217;s <code>split</code> function.
The <code>split</code> function takes two arguments, the string to split and the string
to split on, and returns an array of strings.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>The foreach loop iterates through <code>max_idxs</code> array.</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>The string representation of each number is converted to an integer.</td>
</tr>
<tr>
<td><i class="conum" data-value="9"></i><b>9</b></td>
<td>The corresponding parameter string is retrieved from the <code>upf_lines</code> array, and
is added to the <code>best_params</code> array.
Given that the value in <code>results</code>[i] (from which the max indices are derived) is produced from the parameter combination in
<code>upf_lines</code>[i], the index of the maximum value or values in the <code>max_idxs</code> array is the index of the best parameter combination or combinations.
Note that we subtract one from <code>idx</code> because R indices start at 1 while Swift&#8217;s start at 0.</td>
</tr>
<tr>
<td><i class="conum" data-value="10"></i><b>10</b></td>
<td>The final step is to write the best parameters to a file using Swift&#8217;s <code>write</code> function.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_running_the_swift_script">2.7. Running the Swift Script</h3>
<div class="paragraph">
<p>Swift scripts are typically launched using a shell script. This allows
one to export useful values as environment variables and to properly
configure the Swift workflow to be run on HPC resources.
The EMEWS Creator will automatically create such a shell script. The shell script for running
our simple workflow can be see in <a href="https://github.com/jozik/emews_next_gen_tutorial_tests/blob/main/code/uc1/swift/run_uc1.sh#L1" target="run_uc1.sh">run_uc1.sh</a>.</p>
</div>
<div id="run-uc1-front-annot" class="listingblock">
<div class="title">run_uc1.sh selected parts</div>
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-o">[</span><span class="tok-w"> </span><span class="tok-s2">&quot;</span><span class="tok-nv">$#</span><span class="tok-s2">&quot;</span><span class="tok-w"> </span>-ne<span class="tok-w"> </span><span class="tok-m">2</span><span class="tok-w"> </span><span class="tok-o">]</span><span class="tok-p">;</span><span class="tok-w"> </span><span class="tok-k">then</span><span class="tok-w">  </span><i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-w">  </span><span class="tok-nv">script_name</span><span class="tok-o">=</span><span class="tok-k">$(</span>basename<span class="tok-w"> </span><span class="tok-nv">$0</span><span class="tok-k">)</span>
<span class="tok-w">  </span><span class="tok-nb">echo</span><span class="tok-w"> </span><span class="tok-s2">&quot;Usage: </span><span class="tok-si">${</span><span class="tok-nv">script_name</span><span class="tok-si">}</span><span class="tok-s2"> exp_id cfg_file&quot;</span>
<span class="tok-w">  </span><span class="tok-nb">exit</span><span class="tok-w"> </span><span class="tok-m">1</span>
<span class="tok-k">fi</span>

<span class="tok-c1"># Uncomment to turn on swift/t logging. Can also set TURBINE_LOG,</span>
<span class="tok-c1"># TURBINE_DEBUG, and ADLB_DEBUG to 0 to turn off logging</span>
<span class="tok-c1"># export TURBINE_LOG=1 TURBINE_DEBUG=1 ADLB_DEBUG=1  </span><i class="conum" data-value="2"></i><b>(2)</b>
<span class="tok-nb">export</span><span class="tok-w"> </span><span class="tok-nv">EMEWS_PROJECT_ROOT</span><span class="tok-o">=</span><span class="tok-k">$(</span><span class="tok-w"> </span><span class="tok-nb">cd</span><span class="tok-w"> </span><span class="tok-k">$(</span><span class="tok-w"> </span>dirname<span class="tok-w"> </span><span class="tok-nv">$0</span><span class="tok-w"> </span><span class="tok-k">)</span>/..<span class="tok-w"> </span><span class="tok-p">;</span><span class="tok-w"> </span>/bin/pwd<span class="tok-w"> </span><span class="tok-k">)</span><span class="tok-w">  </span><i class="conum" data-value="3"></i><b>(3)</b>

...

<span class="tok-nb">export</span><span class="tok-w"> </span><span class="tok-nv">EXPID</span><span class="tok-o">=</span><span class="tok-nv">$1</span>
<span class="tok-nb">export</span><span class="tok-w"> </span><span class="tok-nv">TURBINE_OUTPUT</span><span class="tok-o">=</span><span class="tok-nv">$EMEWS_PROJECT_ROOT</span>/experiments/<span class="tok-nv">$EXPID</span><span class="tok-w">  </span><i class="conum" data-value="4"></i><b>(4)</b>
check_directory_exists

<span class="tok-nv">CFG_FILE</span><span class="tok-o">=</span><span class="tok-nv">$2</span>
<span class="tok-nb">source</span><span class="tok-w"> </span><span class="tok-nv">$CFG_FILE</span><span class="tok-w">  </span><i class="conum" data-value="5"></i><b>(5)</b>

<span class="tok-nb">echo</span><span class="tok-w"> </span><span class="tok-s2">&quot;--------------------------&quot;</span>
<span class="tok-nb">echo</span><span class="tok-w"> </span><span class="tok-s2">&quot;WALLTIME:              </span><span class="tok-nv">$CFG_WALLTIME</span><span class="tok-s2">&quot;</span>
<span class="tok-nb">echo</span><span class="tok-w"> </span><span class="tok-s2">&quot;PROCS:                 </span><span class="tok-nv">$CFG_PROCS</span><span class="tok-s2">&quot;</span>
<span class="tok-nb">echo</span><span class="tok-w"> </span><span class="tok-s2">&quot;PPN:                   </span><span class="tok-nv">$CFG_PPN</span><span class="tok-s2">&quot;</span>
<span class="tok-nb">echo</span><span class="tok-w"> </span><span class="tok-s2">&quot;QUEUE:                 </span><span class="tok-nv">$CFG_QUEUE</span><span class="tok-s2">&quot;</span>
<span class="tok-nb">echo</span><span class="tok-w"> </span><span class="tok-s2">&quot;PROJECT:               </span><span class="tok-nv">$CFG_PROJECT</span><span class="tok-s2">&quot;</span>
<span class="tok-nb">echo</span><span class="tok-w"> </span><span class="tok-s2">&quot;UPF FILE:              </span><span class="tok-nv">$CFG_UPF</span><span class="tok-s2">&quot;</span>
<span class="tok-nb">echo</span><span class="tok-w"> </span><span class="tok-s2">&quot;--------------------------&quot;</span>

<span class="tok-nb">export</span><span class="tok-w"> </span><span class="tok-nv">PROCS</span><span class="tok-o">=</span><span class="tok-nv">$CFG_PROCS</span>
<span class="tok-nb">export</span><span class="tok-w"> </span><span class="tok-nv">QUEUE</span><span class="tok-o">=</span><span class="tok-nv">$CFG_QUEUE</span>
<span class="tok-nb">export</span><span class="tok-w"> </span><span class="tok-nv">PROJECT</span><span class="tok-o">=</span><span class="tok-nv">$CFG_PROJECT</span>
<span class="tok-nb">export</span><span class="tok-w"> </span><span class="tok-nv">WALLTIME</span><span class="tok-o">=</span><span class="tok-nv">$CFG_WALLTIME</span>
<span class="tok-nb">export</span><span class="tok-w"> </span><span class="tok-nv">PPN</span><span class="tok-o">=</span><span class="tok-nv">$CFG_PPN</span>
...
<span class="tok-c1"># Copies UPF file to experiment directory</span>
<span class="tok-nv">U_UPF_FILE</span><span class="tok-o">=</span><span class="tok-nv">$EMEWS_PROJECT_ROOT</span>/<span class="tok-nv">$CFG_UPF</span>
<span class="tok-nv">UPF_FILE</span><span class="tok-o">=</span><span class="tok-nv">$TURBINE_OUTPUT</span>/upf.txt
cp<span class="tok-w"> </span><span class="tok-nv">$U_UPF_FILE</span><span class="tok-w"> </span><span class="tok-nv">$UPF_FILE</span><span class="tok-w">  </span><i class="conum" data-value="6"></i><b>(6)</b>

<span class="tok-nv">CMD_LINE_ARGS</span><span class="tok-o">=</span><span class="tok-s2">&quot;</span><span class="tok-nv">$*</span><span class="tok-s2"> -f=</span><span class="tok-nv">$UPF_FILE</span><span class="tok-s2"> &quot;</span><span class="tok-w">  </span><i class="conum" data-value="7"></i><b>(7)</b>
...

<span class="tok-nv">SWIFT_FILE</span><span class="tok-o">=</span>uc1.swift<span class="tok-w">  </span><i class="conum" data-value="8"></i><b>(8)</b>
swift-t<span class="tok-w"> </span>-n<span class="tok-w"> </span><span class="tok-nv">$PROCS</span><span class="tok-w"> </span><span class="tok-nv">$MACHINE</span><span class="tok-w"> </span>-p<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">    </span>-I<span class="tok-w"> </span><span class="tok-nv">$EMEWS_EXT</span><span class="tok-w"> </span>-r<span class="tok-w"> </span><span class="tok-nv">$EMEWS_EXT</span><span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">    </span>-e<span class="tok-w"> </span>TURBINE_MPI_THREAD<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">    </span>-e<span class="tok-w"> </span>TURBINE_OUTPUT<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">    </span>-e<span class="tok-w"> </span>EMEWS_PROJECT_ROOT<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">    </span><span class="tok-nv">$EMEWS_PROJECT_ROOT</span>/swift/<span class="tok-nv">$SWIFT_FILE</span><span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">    </span><span class="tok-nv">$CMD_LINE_ARGS</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>run_uc1.sh takes 2 required arguments (exp_id and cfg_file).
The first is an experiment id (e.g., "experiment_1"), which is used to define a directory (TURBINE_OUTPUT, defined below)
into which per workflow output can be written. Swift will also write its own
log files into this directory as the workflow executes.
The second required argument is the workflow configuration file. EMEWS Creator will have auto-generated
a configuration file based on the information provided to it, and can be seen in <a href="https://github.com/jozik/emews_next_gen_tutorial_tests/blob/main/code/uc1/swift/cfgs/uc1.cfg#L1" target="uc1.cfg">uc1.cfg</a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Additional logging, including debugging logs, can be enabled by uncommenting.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>EMEWS_PROJECT_ROOT is defined and exported here. The workflow launch script assumes the canonical EMEWS directory structure, where
the so-called EMEWS project root directory contains other directories
such as a <code>swift</code> directory in which the swift scripts are
located.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The TURBINE_OUTPUT directory is defined, using the EMEWS_PROJECT_ROOT and EXPID environment variables.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>The configuration file is sourced, bringing in the specific CFG_X environment variables defined there.
These include environment variables that are required for
cluster execution such as queue name (<code>QUEUE</code>), project name (<code>PROJECT</code>), requested walltime (<code>WALLTIME</code>),
processes per node (<code>PPN</code>), and so forth. Any additional environment variables can be included here
and optionally also provided through the configuration file mechanism.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>The utilized unrolled parameter file is copied to the TURBINE_OUTPUT directory to document
the details of the workflow and also to prevent any inadvertent overwriting between script submission and the job run.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>The command line arguments provided to the Swift script are constructed. Here the "-f=" argument points to the unrolled parameter file.</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>The final lines run the swift script by
calling <code>swift-t</code> with Swift specific, e.g., "-n" specifies the total number of processes on which to run,
and script specific arguments, here the CMD_LINE_ARGS defined above.
Additional help for the arguments to <code>swift-t</code> can be seen by running
<code>swift-t -h</code>. More information on the shell script used to
launch the Swift/T workflow can be seen in the <a href="#sweep">Sweep Template</a> section.</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<mark>Highlights</mark> below have in source TODOs.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="uc4">3. Minimizing the Ackley function with an EQSQL Workflow</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Our 4th use case workflow implements an example EQSQL optimization workflow
that attempts to find the minimum of the Ackley function using a
Gaussian process regression model (GPR). Our implementation,
is based on a similar example problem provided as part of the Colmena <a href="https://github.com/exalearn/colmena/blob/bd334e0a582fb79d97652d67d05666f13d178f83/demo_apps/optimizer-examples/streaming.py#L1" target="colmena">documentation</a>.
We begin with a sample set containing a number of randomly generated n-dimensional points.
Each of these points is submitted as a task to the Ackley function for evaluation. When
a specified number of tasks have completed (i.e., that number of Ackley function evaluation results
are available), we train a GPR using the results, and
reorder the evaluation of the remaining tasks, increasing the priority of those more
likely to find an optimal result according to the GPR. This repeats until all the evaluations complete.</p>
</div>
<div class="paragraph">
<p>This tutorial uses the project structure and files created from the
emews creator <a href="#eqsql_top">eqsql</a> template, and that should be read before this.</p>
</div>
<div class="sect2">
<h3 id="_tutorial_goals_3">3.1. Tutorial Goals</h3>
<div class="ulist">
<ul>
<li>
<p>Run an EQSQL Workflow in Swift/T</p>
</li>
<li>
<p>Implement a Python ME that produces tasks (parameters) for parallel evaluation</p>
</li>
<li>
<p>Implement the parallel evalution of those tasks in a SWift/T worker pool</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_running_the_workflow">3.2. Running the Workflow</h3>
<div class="paragraph">
<p>The workflow is designed to be run with a local swift-t conda install:</p>
</div>
<div class="paragraph">
<p><mark>TODO: proper install instructions</mark></p>
</div>
<div class="ulist">
<ul>
<li>
<p>install conda</p>
</li>
<li>
<p>create swift-t env</p>
</li>
<li>
<p>install swift-t conda package</p>
</li>
<li>
<p>pip3 install -e EQ/SQL</p>
</li>
<li>
<p>pip3 install emews_creator</p>
</li>
<li>
<p>conda install postgres, numpy, scipy, scikit-learn</p>
</li>
<li>
<p>emewscreator init_db</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The workflow can be run using the <a href="https://github.com/jozik/emews_next_gen_tutorial_tests/blob/4264709e4ee20153c8e164d72f9a1ccbd72c968b/code/uc4/python/me.py#L1" target="me"><code>uc4/python/me.py</code></a> python script. It takes two arguments:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>An experiment id, e.g. "test_ackley".</p>
</li>
<li>
<p>The path to the ME configuration file, i.e., <code>uc4/python/me_cfg.yaml</code></p>
</li>
</ol>
</div>
<div class="paragraph">
<p>For example,</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>$<span class="tok-w"> </span><span class="tok-nb">cd</span><span class="tok-w"> </span>uc4/python
$<span class="tok-w"> </span>python3<span class="tok-w"> </span>me.py<span class="tok-w"> </span>test_ackley<span class="tok-w"> </span>me_cfg.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>Running the workflow will create an experiment directory whose name
consists of th experiment id followed by a timestamp. The workflow runs
within this directory.</p>
</div>
</div>
<div class="sect2">
<h3 id="_workflow_project_structure_2">3.3. Workflow Project Structure</h3>
<div class="paragraph">
<p>The full source code for this use case can be accessed <a href="https://github.com/jozik/emews_next_gen_tutorial_tests/tree/main/code/uc4" target="uc4">here</a>.
The completed workflow project has the following directory structure and files:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="text"><span></span>uc4/
├── data
├── etc
│   └── emews_utils.sh
├── ext
│   ├── emews
│   │   └── emews.swift
│   └── EQ-SQL
│       ├── EQSQL.swift
│       └── eqsql_swift.py
├── python
│   ├── ackley.py
│   ├── me_cfg.yaml
│   ├── me.py
│   └── test
├── R
│   └── test
├── README.md
├── scripts
│   └── run_ackley.sh
└── swift
    ├── ackley_worker_pool.swift
    ├── cfgs
    │   └── ackley_worker_pool.cfg
    └── run_ackley_worker_pool.sh</code></pre>
</div>
</div>
<div class="paragraph">
<p>The initial version of this project was created using EMEWS Creator with the following command:</p>
</div>
<div id="uc4-creator" class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>emewscreator<span class="tok-w"> </span>-o<span class="tok-w"> </span>uc4<span class="tok-w"> </span>eqsql<span class="tok-w"> </span>-c<span class="tok-w"> </span>tutorial_cfgs/UC4.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>See the eqsql <a href="#eqsql_top">section</a> in the emews creator documentation for additional information on the general project structure.</p>
</div>
<div class="paragraph">
<p>As an eqsql project, the ME algorithm in the UC4 example submits tasks to a database. Those tasks are retrieved
and executed by a worker pool, which then submits the results back where they can be used by the ME. Here, the ME produces inputs to the Ackley function submitting those as tasks to the database. The
worker pool evaluates those inputs in parallel by executing the Ackley function on them, and pushes the results back to the database. Periodically, the ME uses a GPR model to re-prioritize the unevaluated
remaining inputs, assigning a higher priority to those it deems more likely to produce a minimum. The following files implement this workflow.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>python/me.py</code> - the Python ME that submits the Ackley inputs and re-prioritizes them</p>
</li>
<li>
<p><code>python/me_cfg.yaml</code> - the configuration file for the ME</p>
</li>
<li>
<p><code>swift/ackley_worker_pool.swift</code> - the worker pool that retrieves the inputs for evaluation by the Ackley function</p>
</li>
<li>
<p><code>swift/run_ackley_worker_pool.sh</code> - a bash script used to launch the worker pool</p>
</li>
<li>
<p><code>swift/cfgs/ackley_worker_pool.cfg</code> - the configuration file for the worker pool</p>
</li>
<li>
<p><code>scripts/run_ackley.sh</code> - a bash script called by the worker pool to run the Python Ackley function</p>
</li>
<li>
<p><code>python/ackley.py</code> - the Ackley function implemented in Python and called by the <code>run_ackley.sh</code> bash script</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_the_ackley_function">3.4. The Ackley Function</h3>
<div class="paragraph">
<p>The <a href="http://www.sfu.ca/~ssurjano/ackley.html" target="ackley_doc">Ackley</a> function is widely used for testing optimization algorithms.
In our example project, it is implemented in <a href="https://github.com/jozik/emews_next_gen_tutorial_tests/blob/4264709e4ee20153c8e164d72f9a1ccbd72c968b/code/uc4/python/ackley.py#L1" target="ackley_py"><code>uc4/python/ackley.py</code></a></p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>We have added a lognormally distributed sleep delay to the Ackley function implementation to increase the otherwise millisecond runtime and to add task runtime heterogeneity for demonstration purposes.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_calling_the_ackley_function_from_swift">3.5. Calling the Ackley Function from Swift</h3>
<div class="paragraph">
<p>The Ackley function is implemented in Python and is called by the swift worker pool
using a bash script <a href="https://github.com/jozik/emews_next_gen_tutorial_tests/blob/4264709e4ee20153c8e164d72f9a1ccbd72c968b/code/uc4/scripts/run_ackley.sh#L1" target="run_ackley"><code>uc4/scripts/run_ackley.sh</code></a></p>
</div>
<div class="paragraph">
<p>The <code>run_ackley.sh</code> script takes 5 inputs, which are passed from the worker pool swift code when
the script is called.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-w"> </span>Set<span class="tok-w"> </span>PARAM_LINE<span class="tok-w"> </span>from<span class="tok-w"> </span>the<span class="tok-w"> </span>first<span class="tok-w"> </span>argument<span class="tok-w"> </span>to<span class="tok-w"> </span>this<span class="tok-w"> </span>script
<span class="tok-c1"># PARAM_LINE is the string containing the model parameters for a run.</span>
<span class="tok-nv">PARAM_LINE</span><span class="tok-o">=</span><span class="tok-nv">$1</span>

<span class="tok-c1"># Set the name of the file to write model output to.</span>
<span class="tok-nv">OUTPUT_FILE</span><span class="tok-o">=</span><span class="tok-nv">$2</span>

<span class="tok-c1"># Set the TRIAL_ID - this can be used to pass a random seed (for example)</span>
<span class="tok-c1"># to the model</span>
<span class="tok-nv">TRIAL_ID</span><span class="tok-o">=</span><span class="tok-nv">$3</span>

<span class="tok-c1"># Set EMEWS_ROOT to the root directory of the project (i.e. the directory</span>
<span class="tok-c1"># that contains the scripts, swift, etc. directories and files)</span>
<span class="tok-nv">EMEWS_ROOT</span><span class="tok-o">=</span><span class="tok-nv">$4</span>

<span class="tok-c1"># Each model run, runs in its own &quot;instance&quot; directory</span>
<span class="tok-c1"># Set INSTANCE_DIRECTORY to that.</span>
<span class="tok-nv">INSTANCE_DIRECTORY</span><span class="tok-o">=</span><span class="tok-nv">$5</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The <code>TRIAL_ID</code> is not used when running the Ackley function</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>After cd-ing to the <code>INSTANCE_DIRECTORY</code>, the script runs the Ackley function Python code using these inputs.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-nb">cd</span><span class="tok-w"> </span><span class="tok-nv">$INSTANCE_DIRECTORY</span>

<span class="tok-c1"># TODO: Define the command to run the model.</span>
<span class="tok-nv">MODEL_CMD</span><span class="tok-o">=</span><span class="tok-s2">&quot;</span><span class="tok-nv">$HOME</span><span class="tok-s2">/anaconda3/envs/swift-t-r-py3.9/bin/python3&quot;</span><span class="tok-w">    </span><i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-c1"># TODO: Define the arguments to the MODEL_CMD. Each argument should be</span>
<span class="tok-c1"># surrounded by quotes and separated by spaces.</span>
<span class="tok-nv">arg_array</span><span class="tok-o">=(</span><span class="tok-w"> </span><span class="tok-s2">&quot;</span><span class="tok-nv">$EMEWS_ROOT</span><span class="tok-s2">/python/ackley.py&quot;</span><span class="tok-w">    </span><i class="conum" data-value="2"></i><b>(2)</b>
<span class="tok-w">            </span><span class="tok-s2">&quot;</span><span class="tok-nv">$PARAM_LINE</span><span class="tok-s2">&quot;</span>
<span class="tok-w">            </span><span class="tok-s2">&quot;</span><span class="tok-nv">$OUTPUT_FILE</span><span class="tok-s2">&quot;</span><span class="tok-o">)</span>

<span class="tok-nv">$TIMEOUT_CMD</span><span class="tok-w"> </span><span class="tok-s2">&quot;</span><span class="tok-nv">$MODEL_CMD</span><span class="tok-s2">&quot;</span><span class="tok-w"> </span><span class="tok-s2">&quot;</span><span class="tok-si">${</span><span class="tok-nv">arg_array</span><span class="tok-p">[@]</span><span class="tok-si">}</span><span class="tok-s2">&quot;</span><span class="tok-w">    </span><i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Set the Python interpreter to use for running the Ackley Python code.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Set the Ackley python implementation file, the input parameters, and
the file to write the Ackley function output to as arguments to the Python command.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Execute the Python command with the provided arguments.</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The <code>$TIMEOUT_CMD</code>
is an optional argument that can be set at the top of the bash script to
provide a duration after which the command called by the bash script times out.
By default it is an empty string and has no effect.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>We typically use JSON formatted strings to describe model input parameters. The
ME will push JSON formatted dictionaries to the database, and those strings
are retrieved by the worker pool, passed to the bash script, and from there
to the model execution itself.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>When the <code>run_ackley.sh</code> scripts calls <code>python/ackley.py</code> to execute the
Ackley function on the provided input, the <a href="https://github.com/jozik/emews_next_gen_tutorial_tests/blob/4264709e4ee20153c8e164d72f9a1ccbd72c968b/code/uc4/python/ackley.py#L50" target="ackley_main"><code><em>main</em></code></a> section of <code>ackley.py</code> is executed. The <code><em>main</em></code> section receives the Ackley function input (the <code>$PARAM_LINE</code> variable in
<code>run_ackley.sh</code>), and the path to the output file as command line arguments. It unpacks
these arguments, calls the <code>run</code> function, and writes the result to the output file.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">if</span> <span class="tok-vm">__name__</span> <span class="tok-o">==</span> <span class="tok-s1">&#39;__main__&#39;</span><span class="tok-p">:</span>
    <span class="tok-c1"># param_line, output_file</span>
    <span class="tok-n">param_str</span> <span class="tok-o">=</span> <span class="tok-n">sys</span><span class="tok-o">.</span><span class="tok-n">argv</span><span class="tok-p">[</span><span class="tok-mi">1</span><span class="tok-p">]</span>    <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="tok-n">output_file</span> <span class="tok-o">=</span> <span class="tok-n">sys</span><span class="tok-o">.</span><span class="tok-n">argv</span><span class="tok-p">[</span><span class="tok-mi">2</span><span class="tok-p">]</span>

    <span class="tok-n">y</span> <span class="tok-o">=</span> <span class="tok-n">run</span><span class="tok-p">(</span><span class="tok-n">param_str</span><span class="tok-p">)</span>    <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="tok-k">with</span> <span class="tok-nb">open</span><span class="tok-p">(</span><span class="tok-n">output_file</span><span class="tok-p">,</span> <span class="tok-s1">&#39;w&#39;</span><span class="tok-p">)</span> <span class="tok-k">as</span> <span class="tok-n">fout</span><span class="tok-p">:</span>    <i class="conum" data-value="3"></i><b>(3)</b>
        <span class="tok-n">fout</span><span class="tok-o">.</span><span class="tok-n">write</span><span class="tok-p">(</span><span class="tok-sa">f</span><span class="tok-s1">&#39;</span><span class="tok-si">{</span><span class="tok-n">y</span><span class="tok-si">}</span><span class="tok-s1">&#39;</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Unpack the command line arguments.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Call the run function, passing the Ackley function input.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Write the Ackley function result to the output file.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><code>run</code> unpacks the Ackley function parameters and calls the Ackley function itself.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">run</span><span class="tok-p">(</span><span class="tok-n">param_str</span><span class="tok-p">:</span> <span class="tok-nb">str</span><span class="tok-p">)</span> <span class="tok-o">-&gt;</span> <span class="tok-nb">str</span><span class="tok-p">:</span>
<span class="tok-w">    </span><span class="tok-sd">&quot;&quot;&quot;Run the Ackley function on the specified JSON</span>
<span class="tok-sd">    payload.</span>
<span class="tok-sd">    &quot;&quot;&quot;</span>
    <span class="tok-n">args</span> <span class="tok-o">=</span> <span class="tok-n">json</span><span class="tok-o">.</span><span class="tok-n">loads</span><span class="tok-p">(</span><span class="tok-n">param_str</span><span class="tok-p">)</span>    <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="tok-n">x</span> <span class="tok-o">=</span> <span class="tok-n">np</span><span class="tok-o">.</span><span class="tok-n">array</span><span class="tok-p">(</span><span class="tok-n">args</span><span class="tok-p">[</span><span class="tok-s1">&#39;x&#39;</span><span class="tok-p">])</span>    <i class="conum" data-value="2"></i><b>(2)</b>

    <span class="tok-n">result</span> <span class="tok-o">=</span> <span class="tok-n">ackley</span><span class="tok-p">(</span><span class="tok-n">x</span><span class="tok-p">)</span>    <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="tok-k">return</span> <span class="tok-n">json</span><span class="tok-o">.</span><span class="tok-n">dumps</span><span class="tok-p">(</span><span class="tok-n">result</span><span class="tok-p">)</span>     <i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Load the parameter string in to a dictionary. The parameter string
is formatted as a JSON map where each entry in the map is an input variable.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Convert the parameter <code>x</code> entry into a numpy array. <code>x</code> is a JSON list in the
parameter string and needs to be converted to an array for the Ackley function.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Run the Ackley function.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Return the Ackley function result as a JSON string.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The swift worker pool script is largely unchanged from what is created by the
eqsql emews creator template which is described <a href="#swift_worker_pool">here</a>. We have,
however, edited the <code>get_result</code> function to return the result of an
Ackley evaluation.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="swift"><span></span><span class="tok-p">(</span><span class="tok-n">float</span> <span class="tok-n">result</span><span class="tok-p">)</span> <span class="tok-n">get_result</span><span class="tok-p">(</span><span class="tok-n">string</span> <span class="tok-n">output_file</span><span class="tok-p">)</span> <span class="tok-p">{</span>
    <span class="tok-c1">// Read the output file to get result</span>
    <span class="tok-n">file</span> <span class="tok-n">of</span> <span class="tok-p">=</span> <span class="tok-n">input</span><span class="tok-p">(</span><span class="tok-n">output_file</span><span class="tok-p">);</span>    <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="tok-n">result</span> <span class="tok-p">=</span> <span class="tok-n">string2float</span><span class="tok-p">(</span><span class="tok-n">read</span><span class="tok-p">(</span><span class="tok-n">of</span><span class="tok-p">));</span>    <i class="conum" data-value="2"></i><b>(2)</b>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Initialize the output file as a swift-t file object. <code>output_file</code> is the path
passed to <code>ackley.py</code> as a command line argument. The Ackley function result is
written to this file in <a href="https://github.com/jozik/emews_next_gen_tutorial_tests/blob/4264709e4ee20153c8e164d72f9a1ccbd72c968b/code/uc4/python/ackley.py#L56" target="ackley_write_result"><code>python/ackley.py</code></a></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Read the first line of that file, which contains the result, and convert the
string to a float.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The worker pool configuration file (<a href="https://github.com/jozik/emews_next_gen_tutorial_tests/blob/4264709e4ee20153c8e164d72f9a1ccbd72c968b/code/uc4/swift/cfgs/ackley_worker_pool.cfg#L1" target="ackley_worker_pool_cfg"><code>swift/cfgs/ackley_worker_pool.cfg</code></a>) and the worker pool launch script
(<a href="https://github.com/jozik/emews_next_gen_tutorial_tests/blob/4264709e4ee20153c8e164d72f9a1ccbd72c968b/code/uc4/swift/run_ackley_worker_pool.sh#L1" target="run_ackley_worker_pool_sh"><code>swift/run_ackley_worker_pool.sh</code></a>))
are unchanged from those produced by eqsql template. A discussion of them can be found <a href="#pool_cfg">here</a>
and <a href="#eqsql_launch_script">here</a></p>
</div>
<div class="sect3">
<h4 id="_alternatives_to_a_bash_script">3.5.1. Alternatives to a Bash Script</h4>
<div class="paragraph">
<p>Python and R code can also be executed directly using Swift-T&#8217;s embedded Python and R interpreters. When calling Python or R
code directly from Swift, the convention is to provide the code to call in a text string with template arguments for the
variables that will be passed to the Python and R code. For example, calling the Ackley function Python code from within
Swift might look like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="swift"><span></span><span class="tok-n">string</span> <span class="tok-n">ackley_code_template</span> <span class="tok-p">=</span>    <i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-s">&quot;&quot;&quot;</span>
<span class="tok-s">import ackley</span>

<span class="tok-s">param_str = &#39;%s&#39;    </span><i class="conum" data-value="2"></i><b>(2)</b>
<span class="tok-s">result = ackley.run(param_str)    </span><i class="conum" data-value="3"></i><b>(3)</b>
<span class="tok-s">&quot;&quot;&quot;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Embed the Python code to be called in a string</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Use a formatting token for the parameters to pass to the Ackley function</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Call the Ackley function code, putting the result in the <code>result`</code> variable</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To run the code in this string, it is first formatted then executed by the
embedded interpreter.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="swift"><span></span><span class="tok-n">string</span> <span class="tok-n">code</span> <span class="tok-p">=</span> <span class="tok-n">ackley_code_template</span> <span class="tok-o">%</span> <span class="tok-p">(</span><span class="tok-n">task_payload</span><span class="tok-p">);</span>    <i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-n">string</span> <span class="tok-n">result</span> <span class="tok-p">=</span> <span class="tok-n">python_persist</span><span class="tok-p">(</span><span class="tok-n">code</span><span class="tok-p">,</span> <span class="tok-s">&quot;result&quot;</span><span class="tok-p">);</span>    <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Replace the <code>%s`</code> in the <code>ackley_code_template</code> string with the task payload</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Execute resulting string (i.e., <code>code</code>) in the Python interpreter, returning the value of the
named <code>result</code> variable.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>See <a href="http://swift-lang.github.io/swift-t/guide.html#external_scripting" target="swift_e_s">Swift-T External Scripting</a> for more details on using the embedded Python and R interpreters.</p>
</div>
<div class="paragraph">
<p>The primary advantage of using the embedded interpreters are being able retrieve the results without
writing to a file and then reading that file, and so streamlining the code and avoiding file I/O. The
disadvantage is that only the interpreters that are compiled into SWift can be used. HPC resources
often provide a variety of Pythons for different tasks and hardware. When running from a bash script,
the script can select the most appropriate Python (or R) for the task, rather than being constrained to a single
one.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
In addition to running a model, the embeded Python interpreter can be very useful for manipulating parameter strings removing, adding or transforming parameters.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_the_ackley_me">3.6. The Ackley ME</h3>
<div class="paragraph">
<p>The Ackley workflow can be run by executing the Python script <a href="https://github.com/jozik/emews_next_gen_tutorial_tests/blob/4264709e4ee20153c8e164d72f9a1ccbd72c968b/code/uc4/python/me.py#L1" target="me_py"><code>python/me.py</code></a>
The code begins by
starting the EQ/SQL database, the worker pool, and initializing a task queue through which tasks can be sent to the worker pool via the database. The code then submits a user specified amount of initial tasks to the database, and waits
for a prespecified number of tasks to complete. When that number has completed, the remaining unexecuted tasks are reprioritized
using a GPR model. This continues until some total number have been completed. The intention is to illustrate a typical
ME workflow where tasks are submitted to a task queue, and the ME waits for some to complete, at which point it can submit new tasks based on the existing results and reprioritize unexecuted tasks if necessary.</p>
</div>
<div class="paragraph">
<p>The code consists of a Python <code>dataclass</code> for encapsulating a task, 5 functions, and a <code><em>main</em></code> block. The <code>create_parser</code>, and
<code><em>main</em></code> block are discussed in the emews creator eqsql <a href="#me_main">section</a> and won&#8217;t be discussed here.
Similarily, creating the task queue, and starting the database, and worker pool which are performed in the <code>run</code> function were also discussed
in the  emews creator eqsql <a href="#me_init">section</a> and will not be covered here.</p>
</div>
<div class="paragraph">
<p>After initialization, the <code>run</code> function calls <a href="https://github.com/jozik/emews_next_gen_tutorial_tests/blob/4264709e4ee20153c8e164d72f9a1ccbd72c968b/code/uc4/python/me.py#L23" target="submit_initial_tasks"><code>submit_initial_tasks</code></a>, passing it the created task_queue,
the user provided experiment id, and the ME input parameters as a dictionary. The random samples
used as Ackley function input data are created and submitted as tasks for evaluation.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">submit_initial_tasks</span><span class="tok-p">(</span><span class="tok-n">task_queue</span><span class="tok-p">,</span> <span class="tok-n">exp_id</span><span class="tok-p">:</span> <span class="tok-nb">str</span><span class="tok-p">,</span> <span class="tok-n">params</span><span class="tok-p">:</span> <span class="tok-n">Dict</span><span class="tok-p">)</span> <span class="tok-o">-&gt;</span> <span class="tok-n">Dict</span><span class="tok-p">[</span><span class="tok-nb">int</span><span class="tok-p">,</span> <span class="tok-n">Task</span><span class="tok-p">]:</span>
    <span class="tok-o">...</span>
    <span class="tok-n">search_space_size</span> <span class="tok-o">=</span> <span class="tok-n">params</span><span class="tok-p">[</span><span class="tok-s1">&#39;search_space_size&#39;</span><span class="tok-p">]</span>    <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="tok-n">dim</span> <span class="tok-o">=</span> <span class="tok-n">params</span><span class="tok-p">[</span><span class="tok-s1">&#39;sample_dimensions&#39;</span><span class="tok-p">]</span>    <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="tok-n">sampled_space</span> <span class="tok-o">=</span> <span class="tok-n">np</span><span class="tok-o">.</span><span class="tok-n">random</span><span class="tok-o">.</span><span class="tok-n">uniform</span><span class="tok-p">(</span><span class="tok-n">size</span><span class="tok-o">=</span><span class="tok-p">(</span><span class="tok-n">search_space_size</span><span class="tok-p">,</span> <span class="tok-n">dim</span><span class="tok-p">),</span>    <i class="conum" data-value="3"></i><b>(3)</b>
                                      <span class="tok-n">low</span><span class="tok-o">=-</span><span class="tok-mf">32.768</span><span class="tok-p">,</span> <span class="tok-n">high</span><span class="tok-o">=</span><span class="tok-mf">32.768</span><span class="tok-p">)</span>

    <span class="tok-n">task_type</span> <span class="tok-o">=</span> <span class="tok-n">params</span><span class="tok-p">[</span><span class="tok-s1">&#39;task_type&#39;</span><span class="tok-p">]</span>    <i class="conum" data-value="4"></i><b>(4)</b>

    <span class="tok-n">payloads</span> <span class="tok-o">=</span> <span class="tok-p">[]</span>
    <span class="tok-k">for</span> <span class="tok-n">sample</span> <span class="tok-ow">in</span> <span class="tok-n">sampled_space</span><span class="tok-p">:</span>    <i class="conum" data-value="5"></i><b>(5)</b>
        <span class="tok-n">payload</span> <span class="tok-o">=</span> <span class="tok-n">json</span><span class="tok-o">.</span><span class="tok-n">dumps</span><span class="tok-p">({</span><span class="tok-s1">&#39;x&#39;</span><span class="tok-p">:</span> <span class="tok-nb">list</span><span class="tok-p">(</span><span class="tok-n">sample</span><span class="tok-p">)})</span>
        <span class="tok-n">payloads</span><span class="tok-o">.</span><span class="tok-n">append</span><span class="tok-p">(</span><span class="tok-n">payload</span><span class="tok-p">)</span>
    <span class="tok-n">_</span><span class="tok-p">,</span> <span class="tok-n">fts</span> <span class="tok-o">=</span> <span class="tok-n">task_queue</span><span class="tok-o">.</span><span class="tok-n">submit_tasks</span><span class="tok-p">(</span><span class="tok-n">exp_id</span><span class="tok-p">,</span> <span class="tok-n">eq_type</span><span class="tok-o">=</span><span class="tok-n">task_type</span><span class="tok-p">,</span> <span class="tok-n">payload</span><span class="tok-o">=</span><span class="tok-n">payloads</span><span class="tok-p">)</span>    <i class="conum" data-value="6"></i><b>(6)</b>

    <span class="tok-n">tasks</span> <span class="tok-o">=</span> <span class="tok-p">{</span><span class="tok-n">ft</span><span class="tok-o">.</span><span class="tok-n">eq_task_id</span><span class="tok-p">:</span> <span class="tok-n">Task</span><span class="tok-p">(</span><span class="tok-n">future</span><span class="tok-o">=</span><span class="tok-n">ft</span><span class="tok-p">,</span> <span class="tok-n">sample</span><span class="tok-o">=</span><span class="tok-n">sampled_space</span><span class="tok-p">[</span><span class="tok-n">i</span><span class="tok-p">],</span> <span class="tok-n">result</span><span class="tok-o">=</span><span class="tok-kc">None</span><span class="tok-p">)</span>    <i class="conum" data-value="7"></i><b>(7)</b>
             <span class="tok-k">for</span> <span class="tok-n">i</span><span class="tok-p">,</span> <span class="tok-n">ft</span> <span class="tok-ow">in</span> <span class="tok-nb">enumerate</span><span class="tok-p">(</span><span class="tok-n">fts</span><span class="tok-p">)}</span>

    <span class="tok-k">return</span> <span class="tok-n">tasks</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Get the search space size, i.e., the number of initial samples to evaluate.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Get the number of dimensions in each sample.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Create a numpy 2D array of <code>search_space_size</code> where each row is an array of <code>dim</code> size
containing random numbers between -32.768 and 32.768.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Get the task type id to be used in task submission. A worker pool will query for
tasks of a specific type, and this identifies that type.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>For each sample in the sampled space, create a JSON map with a single key, <code>x</code>,
whose value is the sample array. Add that JSON string to a list of payloads
to submit to the database queue.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Submit the list of payloads as tasks to be executed, passing the experiment id, and
task type. The submission returns a status, which we assume to be successful and ignore,
and a list of <code>eqsql.eq.Future</code> objects.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Create and return a Python dictionary of Task dataclass objects. Each Task contains
the <code>Future</code> for that tasks, the numpy array that was submitted as that task&#8217;s input,
and a result (which is initially None, indicating that the task has not yet been evaluated).</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Numpy structures such as arrays are not directly JSON-ifiable, and so
we need to convert them into Python structures that are, such as lists.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Having submitted the initial tasks, <code>run</code> begins the optimization <a href="https://github.com/jozik/emews_next_gen_tutorial_tests/blob/4264709e4ee20153c8e164d72f9a1ccbd72c968b/code/uc4/python/me.py#L117" target="opt_loop">loop</a>. The loop repeatedly queries for
some number of completed tasks using a task queues' <code>as_completed</code> method which returns
an iterator over that number of completed tasks, waiting for tasks to complete if necessary.
When <code>as_completed</code> finishes returning completed tasks, we reprioritize the remaining
uncompleted tasks using the results provided by the completed tasks. The loop continues
calling <code>as_completed</code> and reprioritizing until the total number of tasks have completed.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-n">tasks</span> <span class="tok-o">=</span> <span class="tok-n">submit_initial_tasks</span><span class="tok-p">(</span><span class="tok-n">task_queue</span><span class="tok-p">,</span> <span class="tok-n">exp_id</span><span class="tok-p">,</span> <span class="tok-n">params</span><span class="tok-p">)</span>
<span class="tok-n">total_completed</span> <span class="tok-o">=</span> <span class="tok-n">params</span><span class="tok-p">[</span><span class="tok-s1">&#39;total_completed&#39;</span><span class="tok-p">]</span>    <i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-n">tasks_completed</span> <span class="tok-o">=</span> <span class="tok-mi">0</span>
<span class="tok-n">reprioritize_after</span> <span class="tok-o">=</span> <span class="tok-n">params</span><span class="tok-p">[</span><span class="tok-s1">&#39;reprioritize_after&#39;</span><span class="tok-p">]</span>    <i class="conum" data-value="2"></i><b>(2)</b>
<span class="tok-c1"># list of futures for the submitted tasks</span>
<span class="tok-n">fts</span> <span class="tok-o">=</span> <span class="tok-p">[</span><span class="tok-n">t</span><span class="tok-o">.</span><span class="tok-n">future</span> <span class="tok-k">for</span> <span class="tok-n">t</span> <span class="tok-ow">in</span> <span class="tok-n">tasks</span><span class="tok-o">.</span><span class="tok-n">values</span><span class="tok-p">()]</span>    <i class="conum" data-value="3"></i><b>(3)</b>

<span class="tok-k">while</span> <span class="tok-n">tasks_completed</span> <span class="tok-o">&lt;</span> <span class="tok-n">total_completed</span><span class="tok-p">:</span>    <i class="conum" data-value="4"></i><b>(4)</b>
    <span class="tok-c1"># add the result to the completed Tasks.</span>
    <span class="tok-k">for</span> <span class="tok-n">ft</span> <span class="tok-ow">in</span> <span class="tok-n">task_queue</span><span class="tok-o">.</span><span class="tok-n">as_completed</span><span class="tok-p">(</span><span class="tok-n">fts</span><span class="tok-p">,</span> <span class="tok-n">pop</span><span class="tok-o">=</span><span class="tok-kc">True</span><span class="tok-p">,</span> <span class="tok-n">n</span><span class="tok-o">=</span><span class="tok-n">reprioritize_after</span><span class="tok-p">):</span>    <i class="conum" data-value="5"></i><b>(5)</b>
        <span class="tok-n">_</span><span class="tok-p">,</span> <span class="tok-n">result</span> <span class="tok-o">=</span> <span class="tok-n">ft</span><span class="tok-o">.</span><span class="tok-n">result</span><span class="tok-p">()</span>    <i class="conum" data-value="6"></i><b>(6)</b>
        <span class="tok-n">tasks</span><span class="tok-p">[</span><span class="tok-n">ft</span><span class="tok-o">.</span><span class="tok-n">eq_task_id</span><span class="tok-p">]</span><span class="tok-o">.</span><span class="tok-n">result</span> <span class="tok-o">=</span> <span class="tok-n">json</span><span class="tok-o">.</span><span class="tok-n">loads</span><span class="tok-p">(</span><span class="tok-n">result</span><span class="tok-p">)</span>    <i class="conum" data-value="7"></i><b>(7)</b>
        <span class="tok-n">tasks_completed</span> <span class="tok-o">+=</span> <span class="tok-mi">1</span>    <i class="conum" data-value="8"></i><b>(8)</b>

    <span class="tok-n">reprioritize</span><span class="tok-p">(</span><span class="tok-n">tasks</span><span class="tok-p">)</span>    <i class="conum" data-value="9"></i><b>(9)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Get the total number of tasks to complete (i.e., the total number of Ackley function evaluations
to perform) before stopping.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Get the number of tasks to complete before reprioritizing.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Create a list containing all the Task futures. Most of the eqsql functions that
return some number of completed tasks, or tasks as they complete, use a list of Futures
as an argument, so we create that here.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>While the number of completed tasks is less than the total number to complete,
wait for another <code>reprioritize_after</code> number of tasks to complete, and then reprioritize.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Iterate through <code>reprioritize_after</code> number of completed Futures. Those futures
are popped off the <code>fts</code> list of futures.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Get the result of a completed Future.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>JSON-ify that result and set the result attribute of the Task associated with that
Future.</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>Increment the number of total completed tasks.</td>
</tr>
<tr>
<td><i class="conum" data-value="9"></i><b>9</b></td>
<td>After another <code>reprioritize_after</code> number of tasks have completed, and their results
assigned to the corresponding Task object, reprioritize the uncompleted tasks.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <a href="https://github.com/jozik/emews_next_gen_tutorial_tests/blob/4264709e4ee20153c8e164d72f9a1ccbd72c968b/code/uc4/python/me.py#L65" target="reprioritize"><code>reprioritize</code></a> function uses the completed task results
captured in the <code>result</code> attribute of the Tasks objects to reprioritize the remaining tasks. It begins by separating
the Task objects into training and prediction data sets.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">reprioritize</span><span class="tok-p">(</span><span class="tok-n">tasks</span><span class="tok-p">:</span> <span class="tok-n">Dict</span><span class="tok-p">[</span><span class="tok-nb">int</span><span class="tok-p">,</span> <span class="tok-n">Task</span><span class="tok-p">]):</span>
    <span class="tok-n">training</span> <span class="tok-o">=</span> <span class="tok-p">[]</span>
    <span class="tok-n">uncompleted_fts</span> <span class="tok-o">=</span> <span class="tok-p">[]</span>
    <span class="tok-n">prediction</span> <span class="tok-o">=</span> <span class="tok-p">[]</span>
    <span class="tok-k">for</span> <span class="tok-n">t</span> <span class="tok-ow">in</span> <span class="tok-n">tasks</span><span class="tok-o">.</span><span class="tok-n">values</span><span class="tok-p">():</span>    <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="tok-k">if</span> <span class="tok-n">t</span><span class="tok-o">.</span><span class="tok-n">result</span> <span class="tok-ow">is</span> <span class="tok-kc">None</span><span class="tok-p">:</span>    <i class="conum" data-value="2"></i><b>(2)</b>
            <span class="tok-n">uncompleted_fts</span><span class="tok-o">.</span><span class="tok-n">append</span><span class="tok-p">(</span><span class="tok-n">t</span><span class="tok-o">.</span><span class="tok-n">future</span><span class="tok-p">)</span>
            <span class="tok-n">prediction</span><span class="tok-o">.</span><span class="tok-n">append</span><span class="tok-p">(</span><span class="tok-n">t</span><span class="tok-o">.</span><span class="tok-n">sample</span><span class="tok-p">)</span>
        <span class="tok-k">else</span><span class="tok-p">:</span>
            <span class="tok-n">training</span><span class="tok-o">.</span><span class="tok-n">append</span><span class="tok-p">([</span><span class="tok-n">t</span><span class="tok-o">.</span><span class="tok-n">sample</span><span class="tok-p">,</span> <span class="tok-n">t</span><span class="tok-o">.</span><span class="tok-n">result</span><span class="tok-p">])</span>    <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Iterate through all the Tasks, separating them into
test and prediction data sets.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>If the Task&#8217;s result is None (i.e., it hasn&#8217;t completed) then
add its sample input to the prediction data set, and it&#8217;s future to the list
of uncompleted futures.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Add the completed Task&#8217;s sample input and result values to the training data.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>With the training and prediction data created, <code>reprioritize</code> fits the GPR
using the training data and ranks the uncompleted tasks by likelihood
of minimizing the Ackley function. Using that ranking, it then reprioritizes the remaining
uncompleted tasks.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-n">fts</span> <span class="tok-o">=</span> <span class="tok-p">[]</span>
<span class="tok-n">priorities</span> <span class="tok-o">=</span> <span class="tok-p">[]</span>
<span class="tok-n">max_priority</span> <span class="tok-o">=</span> <span class="tok-nb">len</span><span class="tok-p">(</span><span class="tok-n">uncompleted_fts</span><span class="tok-p">)</span>    <i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-n">ranking</span> <span class="tok-o">=</span> <span class="tok-n">fit_gpr</span><span class="tok-p">(</span><span class="tok-n">training</span><span class="tok-p">,</span> <span class="tok-n">prediction</span><span class="tok-p">)</span>    <i class="conum" data-value="2"></i><b>(2)</b>
<span class="tok-k">for</span> <span class="tok-n">i</span><span class="tok-p">,</span> <span class="tok-n">idx</span> <span class="tok-ow">in</span> <span class="tok-nb">enumerate</span><span class="tok-p">(</span><span class="tok-n">ranking</span><span class="tok-p">):</span>    <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="tok-n">ft</span> <span class="tok-o">=</span> <span class="tok-n">uncompleted_fts</span><span class="tok-p">[</span><span class="tok-n">idx</span><span class="tok-p">]</span>
    <span class="tok-n">priority</span> <span class="tok-o">=</span> <span class="tok-n">max_priority</span> <span class="tok-o">-</span> <span class="tok-n">i</span>    <i class="conum" data-value="4"></i><b>(4)</b>
    <span class="tok-n">fts</span><span class="tok-o">.</span><span class="tok-n">append</span><span class="tok-p">(</span><span class="tok-n">ft</span><span class="tok-p">)</span>
    <span class="tok-n">priorities</span><span class="tok-o">.</span><span class="tok-n">append</span><span class="tok-p">(</span><span class="tok-n">priority</span><span class="tok-p">)</span>

<span class="tok-nb">print</span><span class="tok-p">(</span><span class="tok-s2">&quot;Reprioritizing ...&quot;</span><span class="tok-p">,</span> <span class="tok-n">flush</span><span class="tok-o">=</span><span class="tok-kc">True</span><span class="tok-p">)</span>
<span class="tok-n">eq</span><span class="tok-o">.</span><span class="tok-n">update_priority</span><span class="tok-p">(</span><span class="tok-n">fts</span><span class="tok-p">,</span> <span class="tok-n">priorities</span><span class="tok-p">)</span>     <i class="conum" data-value="5"></i><b>(5)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Set the maximum priority to the number of uncompleted tasks.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Call the GPR to get the Task ranking. The returned ranking
is a ranked list of indices into the prediction data.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>For each index in the ranking, get the Future corresponding
to that index, assign a priority, and add the Future and the
priority to their respective lists.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Compute a priority by subtracting the current iteration index
from the max priority.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Update the priorities of the specified futures to the priorities
in the specified list.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The ME itself is configured using a yaml format configuration file,
<a href="https://github.com/jozik/emews_next_gen_tutorial_tests/blob/4264709e4ee20153c8e164d72f9a1ccbd72c968b/code/uc4/python/me_cfg.yaml#L1" target="me_cfg"><code>python/me_cfg.yaml</code></a>. The ME
code reads in this file, and creates a <code>params</code> Python dictionary from it. In addition to
those entries described in the emews creator eqsql template <a href="#algo_cfg">section</a>, the file contains
the following entries:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span><span class="tok-nt">search_space_size</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">50</span><span class="tok-w">    </span><i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-nt">sample_dimensions</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">4</span><span class="tok-w">    </span><i class="conum" data-value="2"></i><b>(2)</b>
<span class="tok-nt">total_completed</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">40</span><span class="tok-w">    </span><i class="conum" data-value="3"></i><b>(3)</b>
<span class="tok-nt">reprioritize_after</span><span class="tok-p">:</span><span class="tok-w"> </span><span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">10</span><span class="tok-w">    </span><i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The size of the sample search space. This many samples are created and submitted as
tasks for Ackley function evaluation by the worker pool.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The number of dimensions in each sample.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The total number of Ackley function evaluations to complete before stopping.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The number of tasks to complete before reprioritizing. Each time this number of additional Ackley function
evaluations have completed, reprioritize the remaining uncompleted tasks.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><mark>TODO:</mark>
TIPS:
Dealing with worker pool error&#8201;&#8212;&#8201;short timeout in as completed to check, check output.txt</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_installing_emews">Appendix A: Installing EMEWS</h2>
<div class="sectionbody">
<div class="paragraph">
<p>EMEWS supports the following systems:</p>
</div>
<div class="paragraph">
<p>Types of installs:</p>
</div>
<div class="sect2">
<h3 id="_binary">A.1. Binary</h3>
<div class="paragraph">
<p>Binary installations are recommended for this tutorial and small scale testing on supported systems.</p>
</div>
<div class="paragraph">
<p>For Linux or macOS on x86, simply install Anaconda package <code>swift-t-r</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ conda install -c conda-forge -c swift-t swift-t-r</pre>
</div>
</div>
<div class="paragraph">
<p>See <a href="https://anaconda.org/swift-t/swift-t-r">the Anaconda.org site</a> for the full list of versions.</p>
</div>
</div>
<div class="sect2">
<h3 id="_source">A.2. Source</h3>
<div class="paragraph">
<p>Source installations are supported for:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Linux on x86 (<code>linux-64</code>)</p>
</li>
<li>
<p>Linux on ARM64</p>
</li>
<li>
<p>macOS on x86 (<code>osx-64</code>)</p>
</li>
<li>
<p>macOS on ARM64 (<code>osx-arm64</code>)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To install from source, you need to install R and then Swift/T.
You may install R using your system package manager or a from-source build.</p>
</div>
<div class="paragraph">
<p>A complete description of the Swift/T installation may be found at the <a href="https://swift-lang.github.io/swift-t/guide.html#_installation">Swift/T Guide</a>; an abbreviated version is given here.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Install prerequisites: You need MPI, Tcl, SWIG, ZSH, Ant, JDK, R, and the typical C/C++ compiler tools.  These may be installed using your system package manager, but be sure to install the development versions so that the compile-time headers, etc., are available.</p>
</li>
<li>
<p>Install RInside using R&#8217;s <code>install.packages()</code> (except on <code>osx-arm64</code>, see below):</p>
<div class="listingblock">
<div class="content">
<pre>$ R
&gt; install.packages("RInside")
# Pick any CRAN mirror
* installing *source* package 'RInside' ...
using C++ compiler: ...
miscellaneous g++ commands...
...
* DONE (RInside)</pre>
</div>
</div>
</li>
<li>
<p>Download and unpack the Swift/T source:</p>
<div class="listingblock">
<div class="content">
<pre>$ wget http://swift-lang.github.io/swift-t-downloads/1.6/swift-t-1.6.3.tar.gz
$ tar xfz swift-t-1.6.3.tar.gz
$ cd swift-t-1.6.3</pre>
</div>
</div>
</li>
<li>
<p>Configure Swift/T by editing its settings file:</p>
<div class="listingblock">
<div class="content">
<pre>$ ./dev/build/init-settings.sh
$ run your editor on ./dev/build/swift-t-settings.sh</pre>
</div>
</div>
<div class="paragraph">
<p>In swift-t-settings.sh, ensure that your <code>mpicc</code>, Tcl, Python, and R settings are correct.  The defaults usually work if the tools are in <code>PATH</code>.</p>
</div>
</li>
<li>
<p>Run the installer with:</p>
<div class="listingblock">
<div class="content">
<pre>$ dev/build/build-swift-t.sh</pre>
</div>
</div>
</li>
<li>
<p>Add to <code>PATH</code>:</p>
<div class="listingblock">
<div class="content">
<pre>PATH=$PATH:/path/to/swift-t-install/stc/bin</pre>
</div>
</div>
</li>
<li>
<p>Test with:</p>
<div class="listingblock">
<div class="content">
<pre>$ swift-t -v
$ swift-t -E 'trace(42);'</pre>
</div>
</div>
</li>
</ol>
</div>
<div class="sect3">
<h4 id="_r_on_osx_arm64">A.2.1. R on <code>osx-arm64</code></h4>
<div class="paragraph">
<p>This new OS combination with Anaconda does not seem to support R with the RInside library for C++ integration.  You must install R from source.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Install R dependencies bzip2, XZ, and PCRE2 and set the <code>-I</code> and <code>-L</code> flags via <code>CPPFLAGS</code> and <code>LDFLAGS</code> (details below)</p>
</li>
<li>
<p>Download and unpack R:</p>
<div class="listingblock">
<div class="content">
<pre>$ wget https://cran.r-project.org/src/base/R-4/R-4.3.2.tar.gz
$ tar xfz R-4.3.2.tar.gz
$ cd R-4.3.2</pre>
</div>
</div>
</li>
<li>
<p>Configure and build R:</p>
<div class="listingblock">
<div class="content">
<pre>$ ./configure --config-cache           \
              --prefix=/home/path/to/R \
              --enable-R-shlib         \
              --disable-java           \
              --without-tcltk          \
              --without-cairo          \
              --without-jpeglib        \
              --without-libtiff        \
              --without-ICU            \
              --without-x
$ make
$ make install</pre>
</div>
</div>
</li>
<li>
<p>Install RInside via <code>install.packages()</code></p>
</li>
<li>
<p>Proceed with the installation using this R in <code>swift-t-settings.sh</code></p>
</li>
</ol>
</div>
<div class="sect4">
<h5 id="_install_r_dependencies">Install R dependencies</h5>
<div class="paragraph">
<p>Your options here are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Anaconda</p>
</li>
<li>
<p>Source builds</p>
</li>
<li>
<p>Possibly Homebrew, etc.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For Anaconda, simply:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ conda install bzip2 pcre2 xz</pre>
</div>
</div>
<div class="paragraph">
<p>Make sure <code>xcrun</code> is installed via:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ xcode-select --install</pre>
</div>
</div>
<div class="paragraph">
<p>Then set the compiler paths for R <code>configure</code> to look in Anaconda and the SDK locations:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>export CC=clang
export CXX=clang++

PY=/path/to/Anaconda

SDK=$( xcrun --show-sdk-path )

export CPPFLAGS="-I$PY/include -I$SDK/usr/include"
export LDFLAGS="-L$PY/lib -Wl,-rpath -Wl,$PY/lib "
       LDFLAGS+="-L$SDK/usr/lib -F$SDK/System/Library/Frameworks"</pre>
</div>
</div>
<div class="paragraph">
<p>You can use <code>clang</code> / <code>clang++</code> from the system default location.</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_creating_emews_projects">Appendix B: Creating EMEWS Projects</h2>
<div class="sectionbody">
<div class="paragraph">
<p>EMEWS Creator is a Python application for creating workflow projects for EMEWS from
the command line. The project consists of the canonical EMEWS directory layout and
various files that can be customized by the user for their particular use case.</p>
</div>
<div class="sect2">
<h3 id="_installation">B.1. Installation</h3>
<div class="paragraph">
<p><mark>NOTE: This part might be removed since it&#8217;ll be installed as part of the stack.</mark></p>
</div>
<div class="paragraph">
<p>EMEWS Creator can be downloaded and installed from PyPI using pip.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>pip install emewscreator</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_using_emews_creator">B.2. Using EMEWS Creator</h3>
<div class="paragraph">
<p>Once installed EMEWS Creator is run from the command line. It has the following
options.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ emewscreator -h
Usage: emewscreator [OPTIONS] COMMAND [ARGS]...

Options:
  -V, --version          Show the version and exit.
  -o, --output-dir PATH  Directory into which the project template will be
                         generated. Defaults to the current directory

  -m, --model-name TEXT  Name of the model application. Defaults to "model".
  -w, --overwrite        Overwrite existing files
  -h, --help             Show this message and exit.

Commands:
  eqpy   create an eqpy workflow
  eqr    create an eqr workflow
  eqsql    create an eqsql workflow
  init_db  initialize an eqsql database
  sweep  create a sweep workflow</pre>
</div>
</div>
<div class="paragraph">
<p>Each of the commands creates a particular type of workflow: a sweep, an eqpy-based workflow,
an eqr-based workflow, on an eqsql-based workflow. Each of the commands has its own arguments specific to that
workflow type. These are specified on the command line after the COMMAND argument, and will
be covered in the <a href="#wflow_templates">Workflow Templates</a> section below.</p>
</div>
<div class="paragraph">
<p>The following options supplied to <code>emewscreator</code> are common to all the workflow types:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>--output-dir</code> - the root directory of the directory structure and files created
by EMEWS Creator.</p>
</li>
<li>
<p><code>--model-name</code> - the name  of the model that will be run during the workflow.
This will be used in the model execution bash script. Note that spaces will be replaced by underscores.</p>
</li>
<li>
<p><code>--overwrite</code> - if present, EMEWS Creator will overwrite any existing files in the
<code>output-dir</code> directory when creating the workflow. By default, existing files will <strong>not</strong> be overwritten.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>These values can also be supplied in a yaml format configuration file. Sample
configuration files can be found <a href="https://github.com/emews/emews-project-creator/tree/master/example_cfgs">here</a>
in the <code>example_cfgs</code> directory in the EMEWS Creator github repository.</p>
</div>
</div>
<div class="sect2">
<h3 id="emews_proj_struc">B.3. EMEWS Project Structure</h3>
<div class="paragraph">
<p>Each of the workflow types will create the default EMEWS project structure
in the directory specified by the <code>-o, --output-dir</code> argument.
EMEWS Creator is designed such that multiple workflows can be run in the same directory.
For example, you can begin with the <code>sweep</code> and then create an <code>eqr</code> or <code>eqpy</code>
workflow in the same output directory. When multiple workflows are created
in the same output directory, it is crucial that the <code>workflow_name</code>
configuration template argument is unique to each individual workflow. See
the <a href="#wflow_templates">Workflow Templates</a> section for more information on the <code>workflow_name</code>
argument.</p>
</div>
<div class="sect3">
<h4 id="_directories">B.3.1. Directories</h4>
<div class="paragraph">
<p>Given an <code>--output-dir</code> argument of <code>my_emews_project</code>, the default directory structure
produced by all the workflow types is:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>my_emews_project/
├── data
├── etc
│   └── emews_utils.sh
├── ext
│   └── emews
│       └── emews.swift
├── python
│   └── test
├── R
│   └── test
├── README.md
├── scripts
│   └── run_my_model_sweep_workflow.sh
└── swift
    ├── cfgs
    │   └── sweep_workflow.cfg
    ├── run_sweep_workflow.sh
    └── sweep_workflow.swift</pre>
</div>
</div>
<div class="paragraph">
<p>The directories are intended to contain the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>data</code> - data required by the model and model exploration algorithm (e.g., input data).</p>
</li>
<li>
<p><code>etc</code> - additional code used by EMEWS</p>
</li>
<li>
<p><code>ext</code> - Swift/T (hereafter swift) extensions, including the default EMEWS utility code extension as well as
the EQ/R and EQ/Py extensions when creating eqr or eqpy workflows</p>
</li>
<li>
<p><code>python</code> - Python code (e.g., model exploration algorithms written in Python)</p>
</li>
<li>
<p><code>python\test</code> - tests of the Python code</p>
</li>
<li>
<p><code>R</code> - R code (e.g., model exploration algorithms written R)</p>
</li>
<li>
<p><code>R\test</code> - tests of the R code</p>
</li>
<li>
<p><code>scripts</code> - any necessary scripts (e.g., scripts to launch a model), excluding scripts used to run the workflow</p>
</li>
<li>
<p><code>swift</code> - swift code and scripts used run the workflow</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_files">B.3.2. Files</h4>
<div class="paragraph">
<p>Each of the workflow types will generate the following files. The file names
are derived from parameters specified in the workflow template configuration
arguments. The names of those parameters are included in curly brackets
in the file names below. (Note that in the above directory listing, the workflow_name
was <code>sweep_workflow</code>.)</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>swift/run_{workflow_name}.sh</code> - a bash script used to launch / submit the workflow</p>
</li>
<li>
<p><code>swift/{workflow_name}.swift</code> - the swift script that implements the workflow.</p>
</li>
<li>
<p><code>scripts/run_{model_name}_{workflow_name}.sh</code> - a bash script used to run the model application.</p>
</li>
<li>
<p><code>cfgs/{workflow_name}.cfg</code> - a configuration file for running the workflow</p>
</li>
<li>
<p><code>README.md</code> - a README file for the workflow</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>These files may require some user customization before they can be used. The
relevant sections are marked with <code>TODO</code>.</p>
</div>
<div class="paragraph">
<p>Once the required edits are completed, the workflows can be run with:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ run_{workflow_name}.sh &lt;experiment_name&gt; cfgs/{workflow_name}.cfg</pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="wflow_templates">B.4. Workflow Templates</h3>
<div class="paragraph">
<p>Each workflow template has its own set of command line arguments, but all have the following
in common:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>-n, --workflow-name</code> - the name of the workflow. This will be used as the file name for the workflow configuration, submission, and swift script files. Spaces will be replaced by underscores.
<strong>The <code>workflow_name</code> should be unique among all the workflows in the output directory.</strong></p>
</li>
<li>
<p><code>-c, --config</code> - path to the workflow template configuration file, optional if all
the required arguments are specified on the command line</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The workflow template configuration file can be used to specify any of a
workflow template&#8217;s configuration parameters when those parameters are
not specified on the command line. This file is in yaml format.
As mentioned above, sample configuration files can be found
<a href="https://github.com/emews/emews-project-creator/tree/master/example_cfgs">here</a>
in the <code>example_cfgs</code> directory in the EMEWS Creator github repository. Arguments
supplied on the command line will override those supplied in a configuration file.
If any required arguments are missing from the command line, then the
configuration file is required to supply the missing arguments.</p>
</div>
<div class="sect3">
<h4 id="sweep">B.4.1. Sweep</h4>
<div class="paragraph">
<p>The sweep command creates a sweep workflow in which EMEWS reads an input file,
and runs an application using each line of the input file as input to an application run.
We call this input file an <em>unrolled parameter file</em> or <em>UPF</em> file, as it contains a
full explicit listing of all the parameter combinations to run, rather than some
more terse sweep description.</p>
</div>
<div class="paragraph">
<p>Usage:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ emewscreator sweep -h
Usage: emewscreator sweep [OPTIONS]

Options:
  -c, --config PATH         Path to the template configuration file
                            [required if any command line arguments are
                            missing]

  -n, --workflow-name TEXT  Name of the workflow
  -h, --help                Show this message and exit.</pre>
</div>
</div>
<div class="paragraph">
<p>A sample sweep configuration file can be found <a href="https://github.com/emews/emews-project-creator/blob/master/example_cfgs/sweep.yaml" target="sweep.yaml">here</a>.</p>
</div>
<div class="paragraph">
<p>Generating a sweep workflow creates the following files. The exact file names are dependent on
the workflow_name and model_name configuration parameters. Here the workflow name is <code>sweep workflow</code>
and the model name is <code>my model</code>.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>swift/run_sweep_workflow.sh</code> - a bash script used to launch the workflow</p>
</li>
<li>
<p><code>swift/sweep_workflow.swift</code> - a swift script that will iterate through an input file, passing each line of that input to a model</p>
</li>
<li>
<p><code>scripts/run_my_model_sweep_workflow.sh</code> - a bash script for executing the model. The swift script calls this script
to run the model, passing it one line of input from the input file.</p>
</li>
<li>
<p><code>swift/cfgs/sweep_workflow.cfg</code> - the configuration file for the workflow, specifying the location of the sweep input file,
among other parameters.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>These files contain lines or sections marked with <strong>TODO</strong> where that line or section needs
to be edited to customize the file for your model and workflow. See <a href="#uc1">Use Case 1 Tutorial - Simple Workflows with ABM</a> for a fully fleshed out
sweep workflow created using EMEWS Creator. We will look more closely at relevant parts of these files
next.</p>
</div>
<div class="paragraph">
<p><mark>NOTE: do we need to update all the commit-specific permalinks like the one below?</mark></p>
</div>
<div class="paragraph">
<p><a href="https://github.com/jozik/emews_next_gen_tutorial_tests/blob/2843e5d305c93e38f56988c75e1a723e73b30d8d/code/emews_project/swift/run_sweep_workflow.sh#L1" target="UC1"><code><strong>run_sweep_workflow.sh</strong></code></a></p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The launch scripts produced by the EMEWS Creator <em>source</em> other files. Doing this in a bash script
makes any variables and functions defined in those files available to the current file, as if they had been
defined in the current file.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The initial section of the file processes the input arguments to the file,
initalizing some variables that are used in the following parts of the file.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-ch">#! /usr/bin/env bash</span>
<span class="tok-nb">set</span><span class="tok-w"> </span>-eu

<span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-o">[</span><span class="tok-w"> </span><span class="tok-s2">&quot;</span><span class="tok-nv">$#</span><span class="tok-s2">&quot;</span><span class="tok-w"> </span>-ne<span class="tok-w"> </span><span class="tok-m">2</span><span class="tok-w"> </span><span class="tok-o">]</span><span class="tok-p">;</span><span class="tok-w"> </span><span class="tok-k">then</span><span class="tok-w">    </span><i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-w">  </span><span class="tok-nv">script_name</span><span class="tok-o">=</span><span class="tok-k">$(</span>basename<span class="tok-w"> </span><span class="tok-nv">$0</span><span class="tok-k">)</span>
<span class="tok-w">  </span><span class="tok-nb">echo</span><span class="tok-w"> </span><span class="tok-s2">&quot;Usage: </span><span class="tok-si">${</span><span class="tok-nv">script_name</span><span class="tok-si">}</span><span class="tok-s2"> exp_id cfg_file&quot;</span>
<span class="tok-w">  </span><span class="tok-nb">exit</span><span class="tok-w"> </span><span class="tok-m">1</span>
<span class="tok-k">fi</span>

<span class="tok-c1"># Uncomment to turn on swift/t logging. Can also set TURBINE_LOG,</span>
<span class="tok-c1"># TURBINE_DEBUG, and ADLB_DEBUG to 0 to turn off logging</span>
<span class="tok-c1"># export TURBINE_LOG=1 TURBINE_DEBUG=1 ADLB_DEBUG=1</span>
<span class="tok-nb">export</span><span class="tok-w"> </span><span class="tok-nv">EMEWS_PROJECT_ROOT</span><span class="tok-o">=</span><span class="tok-k">$(</span><span class="tok-w"> </span><span class="tok-nb">cd</span><span class="tok-w"> </span><span class="tok-k">$(</span><span class="tok-w"> </span>dirname<span class="tok-w"> </span><span class="tok-nv">$0</span><span class="tok-w"> </span><span class="tok-k">)</span>/..<span class="tok-w"> </span><span class="tok-p">;</span><span class="tok-w"> </span>/bin/pwd<span class="tok-w"> </span><span class="tok-k">)</span><span class="tok-w">    </span><i class="conum" data-value="2"></i><b>(2)</b>
<span class="tok-c1"># source some utility functions used by EMEWS in this script</span>
<span class="tok-nb">source</span><span class="tok-w"> </span><span class="tok-s2">&quot;</span><span class="tok-si">${</span><span class="tok-nv">EMEWS_PROJECT_ROOT</span><span class="tok-si">}</span><span class="tok-s2">/etc/emews_utils.sh&quot;</span><span class="tok-w">    </span><i class="conum" data-value="3"></i><b>(3)</b>

<span class="tok-nb">export</span><span class="tok-w"> </span><span class="tok-nv">EXPID</span><span class="tok-o">=</span><span class="tok-nv">$1</span>
<span class="tok-nb">export</span><span class="tok-w"> </span><span class="tok-nv">TURBINE_OUTPUT</span><span class="tok-o">=</span><span class="tok-nv">$EMEWS_PROJECT_ROOT</span>/experiments/<span class="tok-nv">$EXPID</span><span class="tok-w">    </span><i class="conum" data-value="4"></i><b>(4)</b>
check_directory_exists

<span class="tok-nv">CFG_FILE</span><span class="tok-o">=</span><span class="tok-nv">$2</span>
<span class="tok-nb">source</span><span class="tok-w"> </span><span class="tok-nv">$CFG_FILE</span><span class="tok-w">     </span><i class="conum" data-value="5"></i><b>(5)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Check that the number of arguments passed to the script is equal to 2. The first should
be the name of the experiment, and the second a configuration file that will be sourced
into the current environment.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Define an <code>EMEWS_PROJECT_ROOT</code> environment variable that specifies the root directory of the project.
This corresponds to the root project directory specified in <code>--output-dir</code> when running
emewscreator.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Source utility functions that are used later in the script. These are: <code>check_directory_exists</code> which checks if the <code>TURBINE_OUTPUT</code> directory exists and prompts the user to continue; and <code>log_script</code> which logs the relevant environment variables and a copy of script to the <code>TURBINE_OUTPUT</code> directory.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Creates and exports an <code>EXPID</code> (an experiment id) environment variable from the experiment id passed into the script and then defines the <code>TURBINE_OUTPUT</code> directory using this <code>EXPID</code>. The <code>TURBINE_OUTPUT</code> directory is used by swift as the
output location for all the files that it produces.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Creates a CFG_FILE environment variable from the second argument passed into the script, and sources this file.
In this way the configuration variables, such as the file to sweep over, are made available to the launch script.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The second part of the file exports variables that are used by swift
when submitting the workflow on an HPC resource. Typically such machines use
a job scheduler that requires the user to provide the number of processes
to use, the name of the compute queue, the project to charge the compute time
to, and an estimate of how long the job will take. This section exports
those values so that they are available to swift when creating the job submission
script. These are set from values defined in the workflow configuration file
(i.e., swift/cfgs/sweep_workflow.cfg). See the discussion of that file below.</p>
</div>
<div class="paragraph">
<p><mark>TODO: make link</mark></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-nb">export</span><span class="tok-w"> </span><span class="tok-nv">PROCS</span><span class="tok-o">=</span><span class="tok-nv">$CFG_PROCS</span><span class="tok-w">    </span><i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-nb">export</span><span class="tok-w"> </span><span class="tok-nv">QUEUE</span><span class="tok-o">=</span><span class="tok-nv">$CFG_QUEUE</span>
<span class="tok-nb">export</span><span class="tok-w"> </span><span class="tok-nv">PROJECT</span><span class="tok-o">=</span><span class="tok-nv">$CFG_PROJECT</span>
<span class="tok-nb">export</span><span class="tok-w"> </span><span class="tok-nv">WALLTIME</span><span class="tok-o">=</span><span class="tok-nv">$CFG_WALLTIME</span>
<span class="tok-nb">export</span><span class="tok-w"> </span><span class="tok-nv">PPN</span><span class="tok-o">=</span><span class="tok-nv">$CFG_PPN</span>
<span class="tok-nb">export</span><span class="tok-w"> </span><span class="tok-nv">TURBINE_JOBNAME</span><span class="tok-o">=</span><span class="tok-s2">&quot;</span><span class="tok-si">${</span><span class="tok-nv">EXPID</span><span class="tok-si">}</span><span class="tok-s2">_job&quot;</span><span class="tok-w">    </span><i class="conum" data-value="2"></i><b>(2)</b>
<span class="tok-nb">export</span><span class="tok-w"> </span><span class="tok-nv">TURBINE_MPI_THREAD</span><span class="tok-o">=</span><span class="tok-m">1</span><span class="tok-w">    </span><i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>PROCS</code>, <code>QUEUE</code>, <code>PROJECT</code>, <code>WALLTIME</code>, and <code>PPN</code> are set from variables defined
in the configuration file. See that section for more info <mark>TODO</mark></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>TURBINE_JOBNAME</code> is used to set the name of the job in the HPC submission script.
When querying the HPC resource for the status of your job, you will see your job
name as the experiment id following by <code>_job</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Set <code>TURBINE_MPI_THREAD</code> to one to run MPI in a thread-safe mode to prevent any errors
if the model is multi-threaded.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The launch scripts for all the available workflow types copy all the relevant
files into the experiment directory (i.e., <code>TURBINE_OUTPUT</code>) so that the original
files can be changed without corrupting the workflow. We see that in the next
section together with some variable declarations and some potential TODOs.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>mkdir<span class="tok-w"> </span>-p<span class="tok-w"> </span><span class="tok-nv">$TURBINE_OUTPUT</span><span class="tok-w">    </span><i class="conum" data-value="1"></i><b>(1)</b>
cp<span class="tok-w"> </span><span class="tok-nv">$CFG_FILE</span><span class="tok-w"> </span><span class="tok-nv">$TURBINE_OUTPUT</span>/cfg.cfg<span class="tok-w">    </span><i class="conum" data-value="2"></i><b>(2)</b>

<span class="tok-c1"># TODO: If R cannot be found, then these will need to be   </span><i class="conum" data-value="3"></i><b>(3)</b>
<span class="tok-c1"># uncommented and set correctly.</span>
<span class="tok-c1"># export R_HOME=/path/to/R</span>
<span class="tok-c1"># export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:$R_HOME/lib</span>

<span class="tok-c1"># TODO: If Python cannot be found or there are &quot;Cannot find     </span><i class="conum" data-value="4"></i><b>(4)</b>
<span class="tok-c1"># X package&quot; type errors then these two environment variables</span>
<span class="tok-c1"># will need to be uncommented and set correctly.</span>
<span class="tok-c1"># export PYTHONHOME=/path/to/python</span>
<span class="tok-c1"># export PYTHONPATH=$EMEWS_PROJECT_ROOT/python</span>

<span class="tok-nv">EMEWS_EXT</span><span class="tok-o">=</span><span class="tok-nv">$EMEWS_PROJECT_ROOT</span>/ext/emews<span class="tok-w">    </span><i class="conum" data-value="5"></i><b>(5)</b>

<span class="tok-c1"># Copies UPF file to experiment directory</span>
<span class="tok-nv">U_UPF_FILE</span><span class="tok-o">=</span><span class="tok-nv">$EMEWS_PROJECT_ROOT</span>/<span class="tok-nv">$CFG_UPF</span>
<span class="tok-nv">UPF_FILE</span><span class="tok-o">=</span><span class="tok-nv">$TURBINE_OUTPUT</span>/upf.txt
cp<span class="tok-w"> </span><span class="tok-nv">$U_UPF_FILE</span><span class="tok-w"> </span><span class="tok-nv">$UPF_FILE</span><span class="tok-w">    </span><i class="conum" data-value="6"></i><b>(6)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Make the <code>TURBINE_OUTPUT</code> experiment directory</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Copy the workflow configuration file into the experiment directory</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>If there are errors when running R code in workflows, this section
can be edited appropriately and uncommented.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>If there are errors when running Python code in workflows, this section
can be edited appropriately and uncommented.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Set an environment directory for the EMEWS swift extensions. This is
used internally by the workflow, and should not be edited.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Copy the <em>UPF</em> file to experiment directory as <code>upf.txt</code>. This
is the file containing the sweep input, one parameter set per line.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The launch script pass arguments to the swift script via the command line.
We define a variable that represents the command line and pass the
location of the <em>UPF</em> file using that.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-nv">CMD_LINE_ARGS</span><span class="tok-o">=</span><span class="tok-s2">&quot;</span><span class="tok-nv">$*</span><span class="tok-s2"> -f=</span><span class="tok-nv">$UPF_FILE</span><span class="tok-s2"> &quot;</span>
<span class="tok-c1"># CMD_LINE_ARGS can be extended with +=:</span>
<span class="tok-c1"># CMD_LINE_ARGS+=&quot;-another_arg=$ANOTHER_VAR&quot;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>When submitting the workflow on an HPC machine, the type of job scheduled must be set in order for
swift to correctly submit the job. This is done in the next section.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># TODO: Set MACHINE to your schedule type (e.g. pbs, slurm, cobalt etc.),</span>
<span class="tok-c1"># or empty for an immediate non-queued unscheduled run</span>
<span class="tok-nv">MACHINE</span><span class="tok-o">=</span><span class="tok-s2">&quot;&quot;</span>

<span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-o">[</span><span class="tok-w"> </span>-n<span class="tok-w"> </span><span class="tok-s2">&quot;</span><span class="tok-nv">$MACHINE</span><span class="tok-s2">&quot;</span><span class="tok-w"> </span><span class="tok-o">]</span><span class="tok-p">;</span><span class="tok-w"> </span><span class="tok-k">then</span>
<span class="tok-w">  </span><span class="tok-nv">MACHINE</span><span class="tok-o">=</span><span class="tok-s2">&quot;-m </span><span class="tok-nv">$MACHINE</span><span class="tok-s2">&quot;</span>
<span class="tok-k">fi</span>

<span class="tok-c1"># TODO: Some slurm machines may expect jobs to be run</span>
<span class="tok-c1"># with srun, rather than the default mpiexec (for example). If</span>
<span class="tok-c1"># so, uncomment this export.</span>
<span class="tok-c1"># export TURBINE_LAUNCHER=srun</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The final section logs a copy of the submission script to the experiment directory and
calls swift to submit the job and execute the workflow swift script.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># TODO: Add any script variables that you want to log as</span>
<span class="tok-c1"># part of the experiment meta data to the USER_VARS array,</span>
<span class="tok-c1"># for example, USER_VARS=(&quot;VAR_1&quot; &quot;VAR_2&quot;)</span>
<span class="tok-nv">USER_VARS</span><span class="tok-o">=()</span>
<span class="tok-c1"># log variables and script to to TURBINE_OUTPUT directory</span>
log_script<span class="tok-w">    </span><i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-c1"># echo&#39;s anything following this to standard out</span>
<span class="tok-nb">set</span><span class="tok-w"> </span>-x
<span class="tok-nv">SWIFT_FILE</span><span class="tok-o">=</span>sweep_workflow.swift<span class="tok-w">    </span><i class="conum" data-value="2"></i><b>(2)</b>
swift-t<span class="tok-w"> </span>-n<span class="tok-w"> </span><span class="tok-nv">$PROCS</span><span class="tok-w"> </span><span class="tok-nv">$MACHINE</span><span class="tok-w"> </span>-p<span class="tok-w"> </span><span class="tok-se">\ </span><span class="tok-w">   </span><i class="conum" data-value="3"></i><b>(3)</b>
<span class="tok-w">    </span>-I<span class="tok-w"> </span><span class="tok-nv">$EMEWS_EXT</span><span class="tok-w"> </span>-r<span class="tok-w"> </span><span class="tok-nv">$EMEWS_EXT</span><span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">    </span>-e<span class="tok-w"> </span>TURBINE_MPI_THREAD<span class="tok-w"> </span><span class="tok-se">\ </span><span class="tok-w">   </span><i class="conum" data-value="4"></i><b>(4)</b>
<span class="tok-w">    </span>-e<span class="tok-w"> </span>TURBINE_OUTPUT<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">    </span>-e<span class="tok-w"> </span>EMEWS_PROJECT_ROOT<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">    </span><span class="tok-nv">$EMEWS_PROJECT_ROOT</span>/swift/<span class="tok-nv">$SWIFT_FILE</span><span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">    </span><span class="tok-nv">$CMD_LINE_ARGS</span><span class="tok-w">    </span><i class="conum" data-value="5"></i><b>(5)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Log a copy of this submission script including any of the variables
in <code>USER_VARS</code> to the experiment directory.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Define a variable containing the name of the swift workflow script to
execute.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Call swift passing it the relevant variables and the path of the swift script to be executed. At this point the script is either executed immediately or scheduled for execution depending on the value of the MACHINE variable.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The <code>-e</code> argument to swift adds the specified variable to the script execution environment. On some HPC machines,
the login environment is separate from the compute environment. Consequently, variables defined in the login environment
that are referenced in the swift script when it executes in the compute environment need to be made available for the
script to work correctly. The <code>-e</code> argument does this, adding the specified variables to the compute environment.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Pass the <code>CMD_LINE_ARGS</code> to the swift script.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><a href="https://github.com/jozik/emews_next_gen_tutorial_tests/blob/2843e5d305c93e38f56988c75e1a723e73b30d8d/code/emews_project/swift/sweep_workflow.swift#L1" target="UC1"><code><strong>sweep_workflow.swift</strong></code></a></p>
</div>
<div class="paragraph">
<p>This file is the swift script that performs the actual sweep. The script consists of an opening section that
defines some variables, and 3 functions, one <code>run_model</code> that calls the model itself, one <code>make_dir</code> utility
function, and a <code>main</code> function that performs the sweep.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="swift"><span></span><span class="tok-n">string</span> <span class="tok-n">emews_root</span> <span class="tok-p">=</span> <span class="tok-n">getenv</span><span class="tok-p">(</span><span class="tok-s">&quot;EMEWS_PROJECT_ROOT&quot;</span><span class="tok-p">);</span>    <i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-n">string</span> <span class="tok-n">turbine_output</span> <span class="tok-p">=</span> <span class="tok-n">getenv</span><span class="tok-p">(</span><span class="tok-s">&quot;TURBINE_OUTPUT&quot;</span><span class="tok-p">);</span>

<span class="tok-n">file</span> <span class="tok-n">model_sh</span> <span class="tok-p">=</span> <span class="tok-n">input</span><span class="tok-p">(</span><span class="tok-n">emews_root</span><span class="tok-o">+</span><span class="tok-s">&quot;/scripts/run_my_model_sweep_workflow.sh&quot;</span><span class="tok-p">);</span>    <i class="conum" data-value="2"></i><b>(2)</b>
<span class="tok-n">file</span> <span class="tok-n">upf</span> <span class="tok-p">=</span> <span class="tok-n">input</span><span class="tok-p">(</span><span class="tok-n">argv</span><span class="tok-p">(</span><span class="tok-s">&quot;f&quot;</span><span class="tok-p">));</span>    <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Set <code>emews_root</code> and <code>turbine_output</code> from the <code>EMEWS_PROJECT_ROOT</code> and <code>TURBINE_OUTPUT</code>
environment variables. These were exported in the
<a href="https://github.com/jozik/emews_next_gen_tutorial_tests/blob/2843e5d305c93e38f56988c75e1a723e73b30d8d/code/emews_project/swift/run_sweep_workflow.sh#L1" target="UC1"><code>run_sweep_workflow.sh</code></a> script.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Get the bash script that will be used to launch the model. Swift calls this script
(<code>scripts/run_my_model_sweep_workflow.sh</code>) to perform a model run.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Get the upf file by parsing the <code>-f</code> argument to this script. The <code>-f</code> argument was specified in
as part of the <code>CMD_LINE_ARGS</code> in the <a href="https://github.com/jozik/emews_next_gen_tutorial_tests/blob/2843e5d305c93e38f56988c75e1a723e73b30d8d/code/emews_project/swift/run_sweep_workflow.sh#L1" target="UC1"><code>run_sweep_workflow.sh</code></a> script.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <code>run_model</code> function executes a single model run via a bash script. It calls bash, passing it the name of the bash
script to run, the parameter line (from the upf file) to use, the EMEWS_PROJECT_ROOT directory, and the path of an instance directory. The expectation is that each model run will execute in its own directory and <code>instance</code> is the path of that directory. Standard out and standard error are redirected to an <code>out</code> and <code>err</code> file, respectively.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="swift"><span></span><span class="tok-c1">// app function used to run the model</span>
<span class="tok-n">app</span> <span class="tok-p">(</span><span class="tok-n">file</span> <span class="tok-n">out</span><span class="tok-p">,</span> <span class="tok-n">file</span> <span class="tok-n">err</span><span class="tok-p">)</span> <span class="tok-n">run_model</span><span class="tok-p">(</span><span class="tok-n">file</span> <span class="tok-n">shfile</span><span class="tok-p">,</span> <span class="tok-n">string</span> <span class="tok-n">param_line</span><span class="tok-p">,</span> <span class="tok-n">string</span> <span class="tok-n">instance</span><span class="tok-p">)</span>
<span class="tok-p">{</span>
    <span class="tok-s">&quot;bash&quot;</span> <span class="tok-n">shfile</span> <span class="tok-n">param_line</span> <span class="tok-n">emews_root</span> <span class="tok-n">instance</span> <span class="tok-p">@</span><span class="tok-n">stdout</span><span class="tok-p">=</span><span class="tok-n">out</span> <span class="tok-p">@</span><span class="tok-n">stderr</span><span class="tok-p">=</span><span class="tok-n">err</span><span class="tok-p">;</span>    <i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Call <code>bash</code> to run the model script specified in the previous section, redirecting
<code>stdout</code> and <code>stderr</code> to <code>file out</code> and <code>file err</code>, respectively.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>When we run the model, we want each to run in its own <code>instance</code> directory, and we
need a function to create that directory. <code>make_dir</code> is a swift app function
that calls the operating system&#8217;s <code>mkdir</code> command to create the directory.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="swift"><span></span><span class="tok-c1">// call this to create any required directories</span>
<span class="tok-n">app</span> <span class="tok-p">(</span><span class="tok-n">void</span> <span class="tok-n">o</span><span class="tok-p">)</span> <span class="tok-n">make_dir</span><span class="tok-p">(</span><span class="tok-n">string</span> <span class="tok-n">dirname</span><span class="tok-p">)</span> <span class="tok-p">{</span>
    <span class="tok-s">&quot;mkdir&quot;</span> <span class="tok-s">&quot;-p&quot;</span> <span class="tok-n">dirname</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>main</code> function iterates over each line of the upf file, passing each line
to the model script to run.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="swift"><span></span><span class="tok-c1">// Iterate over each line in the upf file, passing each line</span>
<span class="tok-c1">// to the model script to run</span>
<span class="tok-n">main</span><span class="tok-p">()</span> <span class="tok-p">{</span>
    <span class="tok-c1">// run_prerequisites() =&gt; {</span>
    <span class="tok-n">string</span> <span class="tok-n">upf_lines</span><span class="tok-p">[]</span> <span class="tok-p">=</span> <span class="tok-n">file_lines</span><span class="tok-p">(</span><span class="tok-n">upf</span><span class="tok-p">);</span>    <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="tok-n">foreach</span> <span class="tok-n">s</span><span class="tok-p">,</span><span class="tok-n">i</span> <span class="tok-k">in</span> <span class="tok-n">upf_lines</span> <span class="tok-p">{</span>    <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="tok-n">string</span> <span class="tok-n">instance</span> <span class="tok-p">=</span> <span class="tok-s">&quot;%s/instance_%i/&quot;</span> <span class="tok-o">%</span> <span class="tok-p">(</span><span class="tok-n">turbine_output</span><span class="tok-p">,</span> <span class="tok-n">i</span><span class="tok-o">+</span><span class="tok-mi">1</span><span class="tok-p">);</span>   <i class="conum" data-value="3"></i><b>(3)</b>
        <span class="tok-n">make_dir</span><span class="tok-p">(</span><span class="tok-n">instance</span><span class="tok-p">)</span> <span class="tok-p">=</span><span class="tok-o">&gt;</span> <span class="tok-p">{</span>    <i class="conum" data-value="4"></i><b>(4)</b>
            <span class="tok-n">file</span> <span class="tok-n">out</span> <span class="tok-p">&lt;</span><span class="tok-n">instance</span><span class="tok-o">+</span><span class="tok-s">&quot;out.txt&quot;</span><span class="tok-o">&gt;</span><span class="tok-p">;</span>    <i class="conum" data-value="5"></i><b>(5)</b>
            <span class="tok-n">file</span> <span class="tok-n">err</span> <span class="tok-p">&lt;</span><span class="tok-n">instance</span><span class="tok-o">+</span><span class="tok-s">&quot;err.txt&quot;</span><span class="tok-o">&gt;</span><span class="tok-p">;</span>
            <span class="tok-p">(</span><span class="tok-n">out</span><span class="tok-p">,</span><span class="tok-n">err</span><span class="tok-p">)</span> <span class="tok-p">=</span> <span class="tok-n">run_model</span><span class="tok-p">(</span><span class="tok-n">model_sh</span><span class="tok-p">,</span> <span class="tok-n">s</span><span class="tok-p">,</span> <span class="tok-n">instance</span><span class="tok-p">);</span>    <i class="conum" data-value="6"></i><b>(6)</b>
        <span class="tok-p">}</span>
    <span class="tok-p">}</span>
    <span class="tok-c1">// }</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Read all the lines from the upf file into a string array <code>upf_lines</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>For each line in the array, executing the code within the block. This
will run in parallel, executing as many lines concurrently as there are
available workers. Here <code>s</code> is the element at index <code>i</code> in the <code>upf_lines</code> array,
such that <code>i</code> corresponds to the line number in the upf file itself.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Create the name of the instance directory that we pass to each model execution,
using <code>i</code> to uniquely name each instance directory.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Call <code>make_dir</code> to create each instance directory.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Create the files into which the <code>stdout</code> and <code>stderr</code> will
be written for each model run in each instance directory, naming
them <code>out.txt</code> and <code>err.txt</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Call <code>run_model</code> to execute the model run.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><a href="https://github.com/jozik/emews_next_gen_tutorial_tests/blob/2843e5d305c93e38f56988c75e1a723e73b30d8d/code/emews_project/scripts/run_my_model_sweep_workflow.sh#L1" target="UC1"><code><strong>run_my_model_sweep_workflow.sh</strong></code></a></p>
</div>
<div class="paragraph">
<p><code>run_my_model_sweep_workflow.sh</code> is called by <code>sweep_workflow.swift</code> to execute
the model as if the model has been run from the command line. The script is passed a
single line of parameters from the upf file, the
emews root directory location, and the instance directory created in <code>sweep_workflow.swift</code>.
You will need to update the <code>MODEL_CMD</code> variable to specify the model executable.</p>
</div>
<div class="paragraph">
<p>The script begins with defining an optional <code>TIMEOUT</code> that will timeout
the model if its run duration exceeds that value.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># Check for an optional timeout threshold in seconds. If the duration of the</span>
<span class="tok-c1"># model run as executed below, takes longer that this threshold</span>
<span class="tok-c1"># then the run will be aborted. Note that the &quot;timeout&quot; command</span>
<span class="tok-c1"># must be supported by executing OS.</span>

<span class="tok-c1"># The timeout argument is optional. By default the &quot;run_model&quot; swift</span>
<span class="tok-c1"># app function sends 3 arguments, and no timeout value is set. If there</span>
<span class="tok-c1"># is a 4th (the TIMEOUT_ARG_INDEX) argument, we use that as the timeout value.</span>

<span class="tok-c1"># !!! IF YOU CHANGE THE NUMBER OF ARGUMENTS PASSED TO THIS SCRIPT, YOU MUST</span>
<span class="tok-c1"># CHANGE THE TIMEOUT_ARG_INDEX !!!</span>
<span class="tok-nv">TIMEOUT</span><span class="tok-o">=</span><span class="tok-s2">&quot;&quot;</span>
<span class="tok-nv">TIMEOUT_ARG_INDEX</span><span class="tok-o">=</span><span class="tok-m">4</span><span class="tok-w">    </span><i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-o">[[</span><span class="tok-w"> </span><span class="tok-nv">$#</span><span class="tok-w"> </span><span class="tok-o">==</span><span class="tok-w">  </span><span class="tok-nv">$TIMEOUT_ARG_INDEX</span><span class="tok-w"> </span><span class="tok-o">]]</span>
<span class="tok-k">then</span>
<span class="tok-w">	</span><span class="tok-nv">TIMEOUT</span><span class="tok-o">=</span><span class="tok-si">${</span><span class="tok-p">!TIMEOUT_ARG_INDEX</span><span class="tok-si">}</span>
<span class="tok-k">fi</span>

<span class="tok-nv">TIMEOUT_CMD</span><span class="tok-o">=</span><span class="tok-s2">&quot;&quot;</span>
<span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-o">[</span><span class="tok-w"> </span>-n<span class="tok-w"> </span><span class="tok-s2">&quot;</span><span class="tok-nv">$TIMEOUT</span><span class="tok-s2">&quot;</span><span class="tok-w"> </span><span class="tok-o">]</span><span class="tok-p">;</span><span class="tok-w"> </span><span class="tok-k">then</span>
<span class="tok-w">  </span><span class="tok-nv">TIMEOUT_CMD</span><span class="tok-o">=</span><span class="tok-s2">&quot;timeout </span><span class="tok-nv">$TIMEOUT</span><span class="tok-s2">&quot;</span>
<span class="tok-k">fi</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>If this script is passed <code>TIMEOUT_ARG_INDEX</code> number of arguments,
then that argument (defaulting to the 4th argument) will be used as
the number of seconds after which to timeout.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The next section of the script assigns the scripts command line arguments to
some variables and changes directory to the instance directory passed to
the script.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># Set PARAM_LINE from the first argument to this script</span>
<span class="tok-c1"># PARAM_LINE is the string containing the model parameters for a run.</span>
<span class="tok-nv">PARAM_LINE</span><span class="tok-o">=</span><span class="tok-nv">$1</span>

<span class="tok-c1"># Set EMEWS_ROOT to the root directory of the project (i.e. the directory</span>
<span class="tok-c1"># that contains the scripts, swift, etc. directories and files)</span>
<span class="tok-nv">EMEWS_ROOT</span><span class="tok-o">=</span><span class="tok-nv">$2</span>

<span class="tok-c1"># Each model run, runs in its own &quot;instance&quot; directory</span>
<span class="tok-c1"># Set INSTANCE_DIRECTORY to that and cd into it.</span>
<span class="tok-nv">INSTANCE_DIRECTORY</span><span class="tok-o">=</span><span class="tok-nv">$3</span>
<span class="tok-nb">cd</span><span class="tok-w"> </span><span class="tok-nv">$INSTANCE_DIRECTORY</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The final section defines the model executable in <code>MODEL_CMD</code> and runs
the model with the optional timeout.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># TODO: Define the command to run the model. For example,</span>
<span class="tok-c1"># MODEL_CMD=&quot;python&quot;</span>
<span class="tok-nv">MODEL_CMD</span><span class="tok-o">=</span><span class="tok-s2">&quot;&quot;</span><span class="tok-w">    </span><i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-c1"># TODO: Define the arguments to the MODEL_CMD. Each argument should be</span>
<span class="tok-c1"># surrounded by quotes and separated by spaces. For example,</span>
<span class="tok-c1"># arg_array=(&quot;$EMEWS_ROOT/python/my_model.py&quot; &quot;$PARAM_LINE&quot;)</span>
<span class="tok-nv">arg_array</span><span class="tok-o">=(</span><span class="tok-s2">&quot;arg1&quot;</span><span class="tok-w"> </span><span class="tok-s2">&quot;arg2&quot;</span><span class="tok-w"> </span><span class="tok-s2">&quot;arg3&quot;</span><span class="tok-o">)</span><span class="tok-w">    </span><i class="conum" data-value="2"></i><b>(2)</b>
<span class="tok-nv">COMMAND</span><span class="tok-o">=</span><span class="tok-s2">&quot;</span><span class="tok-nv">$MODEL_CMD</span><span class="tok-s2"> </span><span class="tok-si">${</span><span class="tok-nv">arg_array</span><span class="tok-p">[@]</span><span class="tok-si">}</span><span class="tok-s2">&quot;</span>

<span class="tok-c1"># Turn bash error checking off. This is</span>
<span class="tok-c1"># required to properly handle the model execution</span>
<span class="tok-c1"># return values and the optional timeout.</span>
<span class="tok-nb">set</span><span class="tok-w"> </span>+e
<span class="tok-nb">echo</span><span class="tok-w"> </span><span class="tok-s2">&quot;Running </span><span class="tok-nv">$COMMAND</span><span class="tok-s2">&quot;</span>

<span class="tok-nv">$TIMEOUT_CMD</span><span class="tok-w"> </span><span class="tok-nv">$COMMAND</span><span class="tok-w">    </span><i class="conum" data-value="3"></i><b>(3)</b>
<span class="tok-c1"># $? is the exit status of the most recently executed command (i.e the</span>
<span class="tok-c1"># line above)</span>
<span class="tok-nv">RES</span><span class="tok-o">=</span><span class="tok-nv">$?</span>
<span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-o">[</span><span class="tok-w"> </span><span class="tok-s2">&quot;</span><span class="tok-nv">$RES</span><span class="tok-s2">&quot;</span><span class="tok-w"> </span>-ne<span class="tok-w"> </span><span class="tok-m">0</span><span class="tok-w"> </span><span class="tok-o">]</span><span class="tok-p">;</span><span class="tok-w"> </span><span class="tok-k">then</span>
<span class="tok-w">	</span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-o">[</span><span class="tok-w"> </span><span class="tok-s2">&quot;</span><span class="tok-nv">$RES</span><span class="tok-s2">&quot;</span><span class="tok-w"> </span><span class="tok-o">==</span><span class="tok-w"> </span><span class="tok-m">124</span><span class="tok-w"> </span><span class="tok-o">]</span><span class="tok-p">;</span><span class="tok-w"> </span><span class="tok-k">then</span>
<span class="tok-w">    </span><span class="tok-nb">echo</span><span class="tok-w"> </span><span class="tok-s2">&quot;---&gt; Timeout error in </span><span class="tok-nv">$COMMAND</span><span class="tok-s2">&quot;</span>
<span class="tok-w">  </span><span class="tok-k">else</span>
<span class="tok-w">	   </span><span class="tok-nb">echo</span><span class="tok-w"> </span><span class="tok-s2">&quot;---&gt; Error in </span><span class="tok-nv">$COMMAND</span><span class="tok-s2">&quot;</span>
<span class="tok-w">  </span><span class="tok-k">fi</span>
<span class="tok-k">fi</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Define the model executable. For a stand alone compiled executable, this will be the
path to that executable. For example, something like <code>$HOME/sfw/epi_model-1.0/bin/epimodel</code>.
For a model written in an interpreted language such as R or Python, this will be the R/RScript or Python
executable.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Define the array of arguments to pass to the <code>MODEL_CMD</code> executable. At the very
least, this will typically include the <code>PARAM_LINE</code> variable in order to pass the
upf line to the model. For an R or Python application, this will also include
the path to the R or Python code to run.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Run the model with the optional <code>TIMEOUT_CMD</code>. If no <code>TIMEOUT</code> was specified, this
will be empty.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><a href="https://github.com/jozik/emews_next_gen_tutorial_tests/blob/2843e5d305c93e38f56988c75e1a723e73b30d8d/code/emews_project/swift/cfgs/sweep_workflow.cfg#L1" target="UC1"><code><strong>sweep_workflow.cfg</strong></code></a></p>
</div>
<div class="paragraph">
<p>The final file produced by the emewscreator for the sweep workflow is
<a href="https://github.com/jozik/emews_next_gen_tutorial_tests/blob/2843e5d305c93e38f56988c75e1a723e73b30d8d/code/emews_project/swift/cfgs/sweep_workflow.cfg#L1" target="UC1"><code>sweep_workflow.cfg</code></a>.
This file is sourced by the submission script <a href="https://github.com/jozik/emews_next_gen_tutorial_tests/blob/2843e5d305c93e38f56988c75e1a723e73b30d8d/code/emews_project/swift/run_sweep_workflow.sh#L1" target="UC1"><code>run_sweep_workflow.sh</code></a> to retrieve the HPC scheduler parameters for the workflow and the location
of the upf file. The intention here is that these parameters are the most frequently changed between
different workflow runs, and rather than edit the submission script itself, it is easier to edit
a configuration file.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-nv">CFG_WALLTIME</span><span class="tok-o">=</span><span class="tok-m">24</span>:00:00<span class="tok-w">   </span><i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-nv">CFG_QUEUE</span><span class="tok-o">=</span>queue<span class="tok-w">    </span><i class="conum" data-value="2"></i><b>(2)</b>
<span class="tok-nv">CFG_PROJECT</span><span class="tok-o">=</span>project<span class="tok-w">    </span><i class="conum" data-value="3"></i><b>(3)</b>
<span class="tok-nv">NODES</span><span class="tok-o">=</span><span class="tok-m">4</span><span class="tok-w">    </span><i class="conum" data-value="4"></i><b>(4)</b>
<span class="tok-nv">CFG_PPN</span><span class="tok-o">=</span><span class="tok-m">4</span><span class="tok-w">    </span><i class="conum" data-value="5"></i><b>(5)</b>
<span class="tok-nv">CFG_PROCS</span><span class="tok-o">=</span><span class="tok-k">$((</span><span class="tok-w"> </span><span class="tok-nv">NODES</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-w"> </span><span class="tok-nv">CFG_PPN</span><span class="tok-w"> </span><span class="tok-k">))</span><span class="tok-w">    </span><i class="conum" data-value="6"></i><b>(6)</b>
<span class="tok-c1"># TODO: Update with path to upf file, relative</span>
<span class="tok-c1"># to emews project root directory.</span>
<span class="tok-nv">CFG_UPF</span><span class="tok-o">=</span>data/upf.txt<span class="tok-w">    </span><i class="conum" data-value="7"></i><b>(7)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Set the estimated duration of the workflow.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Set the queue on which to run the workflow.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Set the project with which to run the workflow.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Set the number of HPC nodes with which to run the workflow.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Set the number of processes per node (PPN) to use.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Compute the total number of processes to allocate to the job
by multiplying the number of nodes by the PPN.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Set the path to the UPF file. For convenience, this is relative to the
emews project root directory.</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
See your HPC resource&#8217;s documentation for details on the appropriate values and formats
for <code>CFG_WALLTIME</code>, <code>CFG_QUEUE</code>, and <code>CFG_PROJECT</code>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="eqpy_top">B.4.2. EQPy</h4>
<div class="paragraph">
<p>The EQPy workflow template creates a workflow that uses EMEWS Queues for Python (EQ/Py)
to execute an application using input parameters provided by a
Python model exploration (ME) algorithm.  EQ/Py is a swift extension that adds two blocking queues through which a swift script and a Python algorithm can coordinate execution. The following is the EMEWS workflow structure with EQ/Py,</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/EMEWS_figure_EQPy_black.png" alt="EQPy" width="640" height="480">
</div>
</div>
<div class="paragraph">
<p>and this is a zoomed in picture showing the Python-based ME and swift script queue coordination.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/EMEWS_figure_zoomed_EQPy_black.png" alt="EQPy Zoomed" width="640" height="480">
</div>
</div>
<div class="paragraph">
<p>The eqpy template installs this extension and adds user customizable code that allows model runs and exploration to be controlled from a Python algorithm using the two queues. By default the coordinated execution of the two follows this pattern:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The swift script initializes the EQ/Py extension, including the the Python code, and then waits for the Python code to produce parameters for a parallelized collection of model runs.</p>
</li>
<li>
<p>The Python code produces an initial set of parameters.</p>
</li>
<li>
<p>The Python code passes these parameters to the swift script.</p>
</li>
<li>
<p>The Python code then waits for the swift code.</p>
</li>
<li>
<p>Having received the parameters for the model runs, the swift script launches those runs in parallel.</p>
</li>
<li>
<p>When the model runs are finished, the swift script passes a result derived from the output of those runs back to the Python code.</p>
</li>
<li>
<p>The swift script then waits for the next set of parameters or a flag indicating that no more runs need to be performed.</p>
</li>
<li>
<p>Having received the results from the swift script, the Python code algorithm produces a new set of parameters based on the swift result, and passes those back to the waiting swift script.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Steps 5 - 8 are repeated until a stopping condition (e.g., algorithm convergence or some maximum number of iterations) is reached.</p>
</div>
<div class="paragraph">
<p>Usage:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code><span></span>$ emewscreator eqpy -h

Usage: emewscreator eqpy [OPTIONS]

Options:
  -c, --config PATH              Path to the template configuration file
                                 [required if any command line arguments are
                                 missing]

  -n, --workflow-name TEXT       Name of the workflow
  --module-name TEXT             Python model exploration algorithm module
                                 name

  --me-cfg-file PATH             Configuration file for the model exploration
                                 algorithm

  --trials INTEGER               Number of trials / replicates to perform for
                                 each model run. Defaults to 1

  --model-output-file-name TEXT  Model output base file name, file name only
                                 (e.g., &quot;output.csv&quot;)

  --eqpy-dir PATH                Directory where the eqpy extension is
                                 located. If the extension does not exist at
                                 this location it will be installed there.
                                 Defaults to {output_dir}/ext/EQ-Py

  -h, --help                     Show this message and exit.</code></pre>
</div>
</div>
<div class="paragraph">
<p>In addition to the common configuration arguments described in <a href="#wflow_templates">Workflow Templates</a>
the eqpy template also has the following arguments:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>--module-name</code> - the Python module implementing the ME algorithm</p>
</li>
<li>
<p><code>--me-cfg-file</code> - the path to a configuration file for the Python ME algorithm. This
path will be passed to the Python ME when it is initialized. This is relative to the
directory specified in <code>--output-dir</code>.</p>
</li>
<li>
<p><code>--trials</code> - the number of trials or replicates to perform for each model run. Defaults to 1.</p>
</li>
<li>
<p><code>model-output-file-name</code> - each model run is passed a file path for writing its output.
This is the name of that file.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In addition to the default set of files described in the <a href="#emews_proj_struc">EMEWS Project Structure</a> section, the
eqpy workflow template will also install the EQPy EMEWS swift extension. By default, the extension will be installed in in <code>ext/EQ-Py</code>. An alternative location can be specified with the <code>--eqpy-dir</code>
configuration parameter.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>--eqpy-dir</code> - specifies the location of the eqpy extension (defaults to <code>ext/EQ-Py</code>)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You can set this to use an existing EQ-Py extension, or if the specified location
doesn&#8217;t exist, the extension will be installed there.</p>
</div>
<div class="paragraph">
<p>The extension consists of the following files.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>eqpy.py</code></p>
</li>
<li>
<p><code>EQPy.swift</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>These should not be edited by the user.</p>
</div>
<div class="paragraph">
<p>A sample <code>eqpy</code> configuration file can be found <a href="https://github.com/emews/emews-project-creator/blob/master/example_cfgs/eqpy.yaml">here</a>.</p>
</div>
<div class="paragraph">
<p>Generating an EQPy workflow creates the following files. The exact file names are dependent on
the <code>workflow_name</code> and <code>model_name</code> configuration parameters. Here the workflow name is <code>eqpy workflow</code>
and the model name is <code>my model</code>.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>swift/run_eqpy_workflow.sh</code> - a bash script used to launch the workflow</p>
</li>
<li>
<p><code>swift/eqpy_workflow.swift</code> - a swift script that will initialize a Python ME algorithm, and wait for that
algorithm to pass it parameters to execute in model runs.</p>
</li>
<li>
<p><code>scripts/run_my_model_eqpy_workflow.sh</code> - a bash script for executing the model. The swift script calls this script
to run the model, passing it the parameters produced by the Python ME algorithm.</p>
</li>
<li>
<p><code>swift/cfgs/eqpy_workflow.cfg</code> - the configuration file for the workflow</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>These files contain lines or sections marked with <strong>TODO</strong> where that line or section needs
to be edited to customize the file for your model and workflow.</p>
</div>
<div id="eqpy_launch_script" class="paragraph">
<p><a href="https://github.com/jozik/emews_next_gen_tutorial_tests/blob/8b24e701c0eda35044cd5723a0d46e4aa5cfa26b/code/eqpy_project/swift/run_eqpy_workflow.sh#L1" target="run_eqpy_workflow.sh"><code><strong>run_eqpy_workflow.sh</strong></code></a></p>
</div>
<div class="paragraph">
<p>More details to come.</p>
</div>
<div id="eqpy_workflow_script" class="paragraph">
<p><a href="https://github.com/jozik/emews_next_gen_tutorial_tests/blob/8b24e701c0eda35044cd5723a0d46e4aa5cfa26b/code/eqpy_project/swift/eqpy_workflow.swift#L1" target="eqpy_workflow.swift"><code><strong>eqpy_workflow.swift</strong></code></a></p>
</div>
<div class="paragraph">
<p>More details to come.</p>
</div>
<div id="run_eqpy_model_script" class="paragraph">
<p><a href="https://github.com/jozik/emews_next_gen_tutorial_tests/blob/8b24e701c0eda35044cd5723a0d46e4aa5cfa26b/code/eqpy_project/scripts/run_my_model_eqpy_workflow.sh#L1" target="run_my_model_eqpy_workflow.sh"><code><strong>run_my_model_eqpy_workflow.sh</strong></code></a></p>
</div>
<div class="paragraph">
<p>More details to come.</p>
</div>
<div id="eqpy_workflow_cfg" class="paragraph">
<p><a href="https://github.com/jozik/emews_next_gen_tutorial_tests/blob/8b24e701c0eda35044cd5723a0d46e4aa5cfa26b/code/eqpy_project/swift/cfgs/eqpy_workflow.cfg#L1" target="eqpy_workflow.cfg"><code><strong>eqpy_workflow.cfg</strong></code></a></p>
</div>
<div class="paragraph">
<p>More details to come.</p>
</div>
</div>
<div class="sect3">
<h4 id="eqr_top">B.4.3. EQR</h4>
<div class="paragraph">
<p>The eqr template works much the same as the eqpy template, but for ME algorithms written in R. It generates files and code for ME using the EQ/R EMEWS extension. The EQ/R extension adds two blocking queues through which a swift script and a R algorithm can coordinate execution. The following is the EMEWS workflow structure with EQ/R,</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/EMEWS_figure_EQR_black.png" alt="EQR" width="640" height="480">
</div>
</div>
<div class="paragraph">
<p>and this is a zoomed in picture showing the R-based ME and swift script queue coordination.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/EMEWS_figure_zoomed_EQR_black.png" alt="EQR Zoomed" width="640" height="480">
</div>
</div>
<div class="paragraph">
<p>The eqr template installs this extension and adds user customizable code that allows model runs and exploration to be controlled from a R algorithm using the two queues. By default the coordinated execution of the two uses the following pattern (identical to that of the eqpy template).</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The swift script initializes the EQ/R extension, including the the R code, and then waits for the R code to produce parameters for a parallelized collection of model runs.</p>
</li>
<li>
<p>The R code produces an initial set of parameters.</p>
</li>
<li>
<p>The R code passes these parameters to the swift script.</p>
</li>
<li>
<p>The R code then waits for the swift script.</p>
</li>
<li>
<p>Having received the parameters for the model runs, the swift script launches those runs in parallel.</p>
</li>
<li>
<p>When the model runs are finished, the swift script passes a result derived from the output of those runs back to the R code.</p>
</li>
<li>
<p>The swift script then waits for the next set of parameters or a flag indicating that no more runs need to be performed.</p>
</li>
<li>
<p>Having received the results from the swift script, the R code algorithm produces a new set of parameters based on the swift result, and passes those back to the waiting swift script.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Steps 5 - 8 are repeated until a stopping condition (e.g., algorithm convergence or some maximum number of iterations) is reached.</p>
</div>
<div class="paragraph">
<p>Usage:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code><span></span>$ emewscreator eqr -h
Usage: emewscreator eqr [OPTIONS]

Options:
  -c, --config PATH              Path to the template configuration file
                                 [required if any command line arguments are
                                 missing]

  -n, --workflow-name TEXT       Name of the workflow
  --script-file TEXT             Path to the R model exploration algorithm
  --me-cfg-file PATH             Configuration file for the model exploration
                                 algorithm

  --trials INTEGER               Number of trials / replicates to perform for
                                 each model run

  --model-output-file-name TEXT  Model output base file name, file name only
                                 (e.g., &quot;output.csv&quot;)

  --eqr-dir PATH                 Directory where the eqr extension is located.
                                 If the extension does not exist at this
                                 location it will be installed there. Defaults
                                 to {output_dir}/ext/EQ-R

  -h, --help                     Show this message and exit.</code></pre>
</div>
</div>
<div class="paragraph">
<p>In addition to the common configuration parameters described in <a href="#wflow_templates">Workflow Templates</a>
the <code>eqr</code> template also has the following arguments:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>--script-file</code> - the path to the R script implementing the ME algorithm</p>
</li>
<li>
<p><code>--me-cfg-file</code> - the path to a configuration file for the R ME algorithm. This
path will be passed to the R ME when it is initialized. This path is relative
to the directory specified by <code>--output-dir</code>.</p>
</li>
<li>
<p><code>--trials</code> - the number of trials or replicates to perform for each model run</p>
</li>
<li>
<p><code>--model_output_file_name</code> - each model run is passed a file path for writing its output.
This is the name of that file.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In addition to the default set of files described in the <a href="#emews_proj_struc">EMEWS Project Structure</a>
section, the eqr workflow template will also
install the source for the EQ/R EMEWS swift extension. By default, the extension will be installed
in <code>ext/EQ-R</code>. An alternative location can be specified with the <code>--eqr-dir</code> configuration argument.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>--eqr-dir</code> - specifies the location of the eqr extension (defaults to <code>ext/EQ-R</code>)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You can set this to use an existing EQ-R extension, or if the specified location
doesn&#8217;t exist, the extension <mark>will be installed there.</mark></p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
The extension needs to be compiled before it can be used. See <code>{eqr_dir}/src/README.md</code> for compilation instructions.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>A sample EQR configuration file can be found <a href="https://github.com/emews/emews-project-creator/blob/master/example_cfgs/eqr.yaml">here</a>.</p>
</div>
<div class="paragraph">
<p>Generating an EQR workflow creates the following files. The exact file names are dependent on
the <code>workflow_name</code> and <code>model_name</code> configuration parameters. Here the workflow name is <code>eqr workflow</code>
and the model name is <code>my model</code>.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>swift/run_eqr_workflow.sh</code> - a bash script used to launch the workflow</p>
</li>
<li>
<p><code>swift/eqr_workflow.swift</code> - a swift script that will initialize a R ME algorithm, and wait for that
algorithm to pass it parameters to execute in model runs.</p>
</li>
<li>
<p><code>scripts/run_my_model_eqr_workflow.sh</code> - a bash script for executing the model. The swift script calls this script
to run the model, passing it the parameters produced by the Python ME algorithm.</p>
</li>
<li>
<p><code>swift/cfgs/eqr_workflow.cfg</code> - the configuration file for the workflow</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>These files contain lines or sections marked with <strong>TODO</strong> where that line or section needs
to be edited to customize the file for your model and workflow.</p>
</div>
<div id="eqr_launch_script" class="paragraph">
<p><a href="https://github.com/jozik/emews_next_gen_tutorial_tests/blob/8b24e701c0eda35044cd5723a0d46e4aa5cfa26b/code/eqr_project/swift/run_eqr_workflow.sh#L1" target="run_eqr_workflow.sh"><code><strong>run_eqr_workflow.sh</strong></code></a></p>
</div>
<div class="paragraph">
<p>More details to come.</p>
</div>
<div id="eqr_workflow_script" class="paragraph">
<p><a href="https://github.com/jozik/emews_next_gen_tutorial_tests/blob/8b24e701c0eda35044cd5723a0d46e4aa5cfa26b/code/eqr_project/swift/eqr_workflow.swift#L1" target="eqr_workflow.swift"><code><strong>eqr_workflow.swift</strong></code></a></p>
</div>
<div class="paragraph">
<p>More details to come.</p>
</div>
<div id="run_eqr_model_script" class="paragraph">
<p><a href="https://github.com/jozik/emews_next_gen_tutorial_tests/blob/8b24e701c0eda35044cd5723a0d46e4aa5cfa26b/code/eqr_project/scripts/run_my_model_eqr_workflow.sh#L1" target="run_my_model_eqr_workflow.sh"><code><strong>run_my_model_eqr_workflow.sh</strong></code></a></p>
</div>
<div class="paragraph">
<p>More details to come.</p>
</div>
<div id="eqr_workflow_cfg" class="paragraph">
<p><a href="https://github.com/jozik/emews_next_gen_tutorial_tests/blob/8b24e701c0eda35044cd5723a0d46e4aa5cfa26b/code/eqr_project/swift/cfgs/eqr_workflow.cfg#L1" target="eqr_workflow.cfg"><code><strong>eqr_workflow.cfg</strong></code></a></p>
</div>
<div class="paragraph">
<p>More details to come.</p>
</div>
</div>
<div class="sect3">
<h4 id="eqsql_top">B.4.4. EQSQL</h4>
<div class="paragraph">
<p><mark>TODO</mark>: text that distinguishes between local run (db on same machine, swift non-scheduled
submission), and swift scheduled worker pool submission, and how that applies to the code
created by the template.</p>
</div>
<div class="paragraph">
<p>The eqsql command creates a workflow that submits tasks (such as
application runs) to a database queue. Worker pools pop tasks
off this queue for evaluation, and push the results back to a database input queue.
The tasks can be provided by a Python or R language ME algorithm.</p>
</div>
<div class="paragraph">
<p>Usage:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$emewscreator eqsql -h
Usage: emewscreator eqsql [OPTIONS]

Options:
  -c, --config PATH              Path to the template configuration file.
                                 [required if any command line arguments are
                                 missing]
  --pool-id TEXT                 The name of the task worker pool.
  --task-type INTEGER            The task type id for the tasks consumed by
                                 the worker pool.
  -n, --workflow-name TEXT       Name of the workflow.
  --trials INTEGER               Number of trials / replicates to perform for
                                 each model run. Defaults to 1.
  --model-output-file-name TEXT  Model output base file name, file name only
                                 (e.g., "output.csv").
  --me-language [python|R|None]  Model exploration algorithm programming
                                 language: Python, R, or None.
  --me-file-name TEXT            The name of the model exploration algorithm
                                 template file to generate. Omit the extension
                                 (e.g., "algo", not "algo.py").
  --me-cfg-file-name TEXT        The name of the model exploration algorithm
                                 configuration file.
  --esql-db-path PATH            The path to the eqsql database.
  -h, --help                     Show this message and exit.</pre>
</div>
</div>
<div class="paragraph">
<p>A sample eqsql configuration file can be found <a href="https://github.com/emews/emews-project-creator/blob/master/example_cfgs/eqsql.yaml" target="eqsql.yaml">here</a>.</p>
</div>
<div class="paragraph">
<p>In addition to the common configuration arguments described [above](#workflow_templates),
the eqsql template also has the following arguments:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>--pool-id</code> - a unique identifier for the swift worker pool created by the template.</p>
</li>
<li>
<p><code>--task-type</code> - an integer identifying the type of task the worker pool will consume.</p>
</li>
<li>
<p><code>--trials</code> - the number of trials or replicates to perform for each task evaluation. Defaults to 1.</p>
</li>
<li>
<p><code>--model-output-file-name</code> - each task evaluation is passed a file path for writing its output.
This is the name of that file.</p>
</li>
<li>
<p><code>--me-language</code> - the ME programming language (R, Python, None). The template will create an example ME written
in this language. If the value is <code>None</code>, then no ME example file will be created.</p>
</li>
<li>
<p><code>--me-cfg-file-name</code> - the name of the yaml format configuration file used to configure the example ME.</p>
</li>
<li>
<p><code>--esql-db-path</code> - the path to the eqsql database. This is used by the example ME to start
the database.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Generating an eqsql workflow, creates the following files, the contents of which reflect the
arguments (e.g., <code>pool_id</code>.) above. The exact file names are dependent on
the <code>workflow_name</code>, and <code>model_name</code> configuration parameters. In the following, the workflow name
was set to <code>eqsql</code>, and the model name to <code>my model</code>.
If Python or R is specified in the <code>me_language</code> parameter, then an example
ME algorithm and configuration file are created. Here, the <code>me_language</code> is Python,
the <code>me_file_name</code> is <code>algo</code>, and the <code>me_cfg_file_name</code> is <code>algo_cfg</code>.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>swift/run_eqsql_worker_pool.sh</code> - a bash script used to launch the worker pool</p>
</li>
<li>
<p><code>swift/eqsql_worker_pool.swift</code> - a swift script the implements an eqsql worker pool</p>
</li>
<li>
<p><code>scripts/run_my_model.sh</code> - a bash script for executing the model. The swift script calls this script, passing it task parameters from the ME via the database.</p>
</li>
<li>
<p><code>python/algo.py</code> - an example eqsql ME in Python. The file name is specified by the <code>me_file_name</code> configuration parameter.</p>
</li>
<li>
<p><code>python/algo_cfg.yaml</code> - the configuration file for the example ME. The file name is specified by the <code>me_cfg_file_name</code> parameter</p>
</li>
<li>
<p><code>ext/EQ-SQL/EQSQL.swift</code> - swift code used by worker pools to retrieve tasks and report results to the
eqsql database. Typically this should not be edited by the user.</p>
</li>
<li>
<p><code>ext/EQ-SQL/eqsql_swift.py</code> - Python code used by worker pools to retrieve tasks and report results to the eqsql database.
Typically, this should not be edited by the user.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>These files (excluding those in <code>ext/EQ-SQL</code>) contain lines or sections marked with <strong>TODO</strong> where that line or section needs
to be edited to customize the file for your model and workflow. See <a href="#uc4">Use Case 4 Tutorial - An EQSQL Workflow</a> for a fully fleshed out
eqsql workflow created using EMEWS Creator. We look more closely at relevant parts of these files
next.</p>
</div>
<div id="eqsql_launch_script" class="paragraph">
<p><a href="https://github.com/jozik/emews_next_gen_tutorial_tests/blob/675eb2423dea8fd3c567a42dce610d655b9ab77e/code/eqsql_project/swift/run_eqsql_worker_pool.sh#L1" target="eqsql_worker_pool.sh"><code><strong>run_eqsql_worker_pool.sh</strong></code></a></p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The launch scripts produced by the EMEWS Creator <em>source</em> other files. Doing this in a bash script
makes any variables and functions defined in those files available to the current file, as if they had been
defined in the current file.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The initial section of the file processes the input arguments to the file,
and initializes variables that are used in the following parts of the file.</p>
</div>
<div id="submit_init" class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-ch">#! /usr/bin/env bash</span>
<span class="tok-nb">set</span><span class="tok-w"> </span>-eu

<span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-o">[</span><span class="tok-w"> </span><span class="tok-s2">&quot;</span><span class="tok-nv">$#</span><span class="tok-s2">&quot;</span><span class="tok-w"> </span>-ne<span class="tok-w"> </span><span class="tok-m">2</span><span class="tok-w"> </span><span class="tok-o">]</span><span class="tok-p">;</span><span class="tok-w"> </span><span class="tok-k">then</span><span class="tok-w">    </span><i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-w">  </span><span class="tok-nv">script_name</span><span class="tok-o">=</span><span class="tok-k">$(</span>basename<span class="tok-w"> </span><span class="tok-nv">$0</span><span class="tok-k">)</span>
<span class="tok-w">  </span><span class="tok-nb">echo</span><span class="tok-w"> </span><span class="tok-s2">&quot;Usage: </span><span class="tok-si">${</span><span class="tok-nv">script_name</span><span class="tok-si">}</span><span class="tok-s2"> exp_id cfg_file&quot;</span>
<span class="tok-w">  </span><span class="tok-nb">exit</span><span class="tok-w"> </span><span class="tok-m">1</span>
<span class="tok-k">fi</span>

<span class="tok-c1"># Uncomment to turn on swift/t logging. Can also set TURBINE_LOG,</span>
<span class="tok-c1"># TURBINE_DEBUG, and ADLB_DEBUG to 0 to turn off logging</span>
<span class="tok-c1"># export TURBINE_LOG=1 TURBINE_DEBUG=1 ADLB_DEBUG=1</span>
<span class="tok-nb">export</span><span class="tok-w"> </span><span class="tok-nv">EMEWS_PROJECT_ROOT</span><span class="tok-o">=</span><span class="tok-k">$(</span><span class="tok-w"> </span><span class="tok-nb">cd</span><span class="tok-w"> </span><span class="tok-k">$(</span><span class="tok-w"> </span>dirname<span class="tok-w"> </span><span class="tok-nv">$0</span><span class="tok-w"> </span><span class="tok-k">)</span>/..<span class="tok-w"> </span><span class="tok-p">;</span><span class="tok-w"> </span>/bin/pwd<span class="tok-w"> </span><span class="tok-k">)</span><span class="tok-w">    </span><i class="conum" data-value="2"></i><b>(2)</b>
<span class="tok-c1"># source some utility functions used by EMEWS in this script</span>
<span class="tok-nb">source</span><span class="tok-w"> </span><span class="tok-s2">&quot;</span><span class="tok-si">${</span><span class="tok-nv">EMEWS_PROJECT_ROOT</span><span class="tok-si">}</span><span class="tok-s2">/etc/emews_utils.sh&quot;</span><span class="tok-w">    </span><i class="conum" data-value="3"></i><b>(3)</b>

<span class="tok-nb">export</span><span class="tok-w"> </span><span class="tok-nv">EXPID</span><span class="tok-o">=</span><span class="tok-nv">$1</span><span class="tok-w">    </span><i class="conum" data-value="4"></i><b>(4)</b>
<span class="tok-nb">export</span><span class="tok-w"> </span><span class="tok-nv">TURBINE_OUTPUT</span><span class="tok-o">=</span><span class="tok-nv">$EMEWS_PROJECT_ROOT</span>/experiments/<span class="tok-nv">$EXPID</span><span class="tok-w">    </span><i class="conum" data-value="5"></i><b>(5)</b>
check_directory_exists

<span class="tok-nv">CFG_FILE</span><span class="tok-o">=</span><span class="tok-nv">$2</span><span class="tok-w">    </span><i class="conum" data-value="6"></i><b>(6)</b>
<span class="tok-nb">source</span><span class="tok-w"> </span><span class="tok-nv">$CFG_FILE</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Check that the number of arguments passed to the script is equal to 2. The first should
be the name of the experiment, and the second a configuration file that will be sourced
into the current environment.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Define an <code>EMEWS_PROJECT_ROOT</code> environment variable that specifies the root directory of the project.
This corresponds to the root project directory specified in <code>--output-dir</code> when running
emewscreator.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Source utility functions that are used later in the script. These are: <code>check_directory_exists</code>
which checks if the <code>TURBINE_OUTPUT</code> directory exists and prompts the user to continue; and <code>log_script</code>
which logs the relevant environment variables and a copy of script to the <code>TURBINE_OUTPUT</code> directory.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Define and export an <code>EXPID</code> (an experiment id) environment variable from the experiment id passed
into the script.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Define the <code>TURBINE_OUTPUT</code> directory using the <code>EXPID</code>. The <code>TURBINE_OUTPUT</code> directory is the
sandbox directory in which the application runs, and is used by swift as the
output location for all the files that it produces.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Create a CFG_FILE environment variable from the second argument passed into the script, and source this file.
In this way the configuration variables which may change from workflow run to workflow run are included
into this submission script.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The second part of the file exports variables that are used by swift
when submitting the workflow on an HPC resource. Typically such machines use
a job scheduler that requires the user to provide the number of processes
to use, the name of the compute queue, the project to charge the compute time
to, and an estimate of how long the job will take. This section exports
those values so that they are available to swift when creating the job submission
script. These are set from values defined in the workflow configuration file
(i.e., <a href="https://github.com/jozik/emews_next_gen_tutorial_tests/blob/675eb2423dea8fd3c567a42dce610d655b9ab77e/code/eqsql_project/swift/cfgs/eqsql_worker_pool.cfg#L1" target="eqsql_worker_pool.sh"><code>swift/cfgs/eqsql_worker_pool.cfg</code></a>).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-nb">export</span><span class="tok-w"> </span><span class="tok-nv">PROCS</span><span class="tok-o">=</span><span class="tok-nv">$CFG_PROCS</span><span class="tok-w">    </span><i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-nb">export</span><span class="tok-w"> </span><span class="tok-nv">QUEUE</span><span class="tok-o">=</span><span class="tok-nv">$CFG_QUEUE</span>
<span class="tok-nb">export</span><span class="tok-w"> </span><span class="tok-nv">PROJECT</span><span class="tok-o">=</span><span class="tok-nv">$CFG_PROJECT</span>
<span class="tok-nb">export</span><span class="tok-w"> </span><span class="tok-nv">WALLTIME</span><span class="tok-o">=</span><span class="tok-nv">$CFG_WALLTIME</span>
<span class="tok-nb">export</span><span class="tok-w"> </span><span class="tok-nv">PPN</span><span class="tok-o">=</span><span class="tok-nv">$CFG_PPN</span>
<span class="tok-nb">export</span><span class="tok-w"> </span><span class="tok-nv">TURBINE_JOBNAME</span><span class="tok-o">=</span><span class="tok-s2">&quot;</span><span class="tok-si">${</span><span class="tok-nv">EXPID</span><span class="tok-si">}</span><span class="tok-s2">_job&quot;</span><span class="tok-w">    </span><i class="conum" data-value="2"></i><b>(2)</b>
<span class="tok-nb">export</span><span class="tok-w"> </span><span class="tok-nv">TURBINE_MPI_THREAD</span><span class="tok-o">=</span><span class="tok-m">1</span><span class="tok-w">    </span><i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>PROCS</code>, <code>QUEUE</code>, <code>PROJECT</code>, <code>WALLTIME</code>, and <code>PPN</code> are set from variables defined
in the configuration file. See that <a href="#pool_cfg">section</a> for more information.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>TURBINE_JOBNAME</code> is used to set the name of the job in the HPC submission script.
When querying the HPC resource for the status of your job, you will see your job
name as the experiment id following by <code>_job</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Set <code>TURBINE_MPI_THREAD</code> to one to run MPI in a thread-safe mode to prevent any errors
if the model is multi-threaded.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The launch script copies all the relevant
files into the experiment directory (i.e., the  <code>TURBINE_OUTPUT</code> value) so that the original
files can be changed without corrupting the workflow. We see that in the next
section together with some variable declarations and potential TODOs.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>mkdir<span class="tok-w"> </span>-p<span class="tok-w"> </span><span class="tok-nv">$TURBINE_OUTPUT</span><span class="tok-w">    </span><i class="conum" data-value="1"></i><b>(1)</b>
cp<span class="tok-w"> </span><span class="tok-nv">$CFG_FILE</span><span class="tok-w"> </span><span class="tok-nv">$TURBINE_OUTPUT</span>/cfg.cfg<span class="tok-w">    </span><i class="conum" data-value="2"></i><b>(2)</b>

<span class="tok-c1"># TODO: If R cannot be found, then these will need to be   </span><i class="conum" data-value="3"></i><b>(3)</b>
<span class="tok-c1"># uncommented and set correctly.</span>
<span class="tok-c1"># export R_HOME=/path/to/R</span>
<span class="tok-c1"># export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:$R_HOME/lib</span>

<span class="tok-c1"># EQSQL swift extension location</span>
<span class="tok-nv">EQSQL</span><span class="tok-o">=</span><span class="tok-nv">$EMEWS_PROJECT_ROOT</span>/ext/EQ-SQL<span class="tok-w">    </span><i class="conum" data-value="4"></i><b>(4)</b>
<span class="tok-nv">EMEWS_EXT</span><span class="tok-o">=</span><span class="tok-nv">$EMEWS_PROJECT_ROOT</span>/ext/emews<span class="tok-w">    </span><i class="conum" data-value="5"></i><b>(5)</b>

<span class="tok-c1"># TODO: if Python cannot be found then uncomment    </span><i class="conum" data-value="6"></i><b>(6)</b>
<span class="tok-c1"># and edit this line.</span>
<span class="tok-c1"># export PYTHONHOME=/path/to/python</span>

<span class="tok-c1"># TODO: if there are &quot;Cannot find</span>
<span class="tok-c1"># X package&quot; type Python errors then append</span>
<span class="tok-c1"># the missing package&#39;s path to the PYTHONPATH</span>
<span class="tok-c1"># variable below, separating the entries with &quot;:&quot;</span>
<span class="tok-nb">export</span><span class="tok-w"> </span><span class="tok-nv">PYTHONPATH</span><span class="tok-o">=</span><span class="tok-nv">$EMEWS_PROJECT_ROOT</span>/python:<span class="tok-nv">$EQSQL</span><span class="tok-w">    </span><i class="conum" data-value="7"></i><b>(7)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Make the <code>TURBINE_OUTPUT</code> experiment directory</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Copy the workflow configuration file into the experiment directory</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>If there are errors when running R code in workflows, this section
can be edited appropriately and uncommented.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Set an environment variable for the EQ/SQL swift extension location. This is
used internally by the workflow, and should not be edited.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Set an environment directory for the EMEWS swift extension location. This is
used internally by the workflow, and should not be edited.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>If there are errors when running Python code in workflows, this section
can be edited appropriately and uncommented.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>If any required Python packages cannot be found, their locations
can be appended to the PYTHONPATH environment variable.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The launch script also exports some database related variables:
the database host, user, port and name. These are used by the
swift script to communicate with the database. The values
are sourced from the configuration file and they should be
edited there if necessary. These variables will be further explained
in the configuration file <a href="#pool_cfg">section</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># EQSQL DB variables, set from the CFG file.</span>
<span class="tok-c1"># To change these, edit the CFG file.</span>
<span class="tok-nb">export</span><span class="tok-w"> </span><span class="tok-nv">DB_HOST</span><span class="tok-o">=</span><span class="tok-nv">$CFG_DB_HOST</span>
<span class="tok-nb">export</span><span class="tok-w"> </span><span class="tok-nv">DB_USER</span><span class="tok-o">=</span><span class="tok-nv">$CFG_DB_USER</span>
<span class="tok-nb">export</span><span class="tok-w"> </span><span class="tok-nv">DB_PORT</span><span class="tok-o">=</span><span class="tok-si">${</span><span class="tok-nv">CFG_DB_PORT</span><span class="tok-k">:-</span><span class="tok-si">}</span>
<span class="tok-nb">export</span><span class="tok-w"> </span><span class="tok-nv">DB_NAME</span><span class="tok-o">=</span><span class="tok-nv">$CFG_DB_NAME</span>
<span class="tok-nb">export</span><span class="tok-w"> </span><span class="tok-nv">EQ_DB_RETRY_THRESHOLD</span><span class="tok-o">=</span><span class="tok-nv">$CFG_DB_RETRY_THRESHOLD</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>When submitting the workflow on an HPC machine, the type of HPC job scheduler must be set in order for
swift to correctly submit the job. This is done in the next section. The <strong>else</strong> clause writes
the worker pools stdout and stderr to a file when running on a non-queued unscheduled resource.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1">#TODO: Set MACHINE to your schedule type (e.g. pbs, slurm, cobalt etc.),</span>
<span class="tok-c1"># or empty for an immediate non-queued unscheduled run</span>
<span class="tok-nv">MACHINE</span><span class="tok-o">=</span><span class="tok-s2">&quot;&quot;</span>

<span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-o">[</span><span class="tok-w"> </span>-n<span class="tok-w"> </span><span class="tok-s2">&quot;</span><span class="tok-nv">$MACHINE</span><span class="tok-s2">&quot;</span><span class="tok-w"> </span><span class="tok-o">]</span><span class="tok-p">;</span><span class="tok-w"> </span><span class="tok-k">then</span>
<span class="tok-w">  </span><span class="tok-nv">MACHINE</span><span class="tok-o">=</span><span class="tok-s2">&quot;-m </span><span class="tok-nv">$MACHINE</span><span class="tok-s2">&quot;</span>
<span class="tok-k">else</span>
<span class="tok-w">  </span><span class="tok-nb">echo</span><span class="tok-w"> </span><span class="tok-s2">&quot;Logging output to </span><span class="tok-nv">$TURBINE_OUTPUT</span><span class="tok-s2">/output.txt&quot;</span>
<span class="tok-w">  </span><span class="tok-c1"># Redirect stdout and stderr to output.txt</span>
<span class="tok-w">  </span><span class="tok-c1"># if running without a scheduler.</span>
<span class="tok-w">  </span><span class="tok-nb">exec</span><span class="tok-w"> </span><span class="tok-p">&amp;</span>&gt;<span class="tok-w"> </span><span class="tok-s2">&quot;</span><span class="tok-nv">$TURBINE_OUTPUT</span><span class="tok-s2">/output.txt&quot;</span>
<span class="tok-k">fi</span></code></pre>
</div>
</div>
<div id="pass_cmd_args" class="paragraph">
<p>The launch script passes some arguments to the swift script, that it calls, via the command line.
We define a variable that represents the command line and pass the number of trials
(replicates), the worker pool task type, batch size, batch threshold and worker pool
id using that variable. These arguments are all set via the configuration file and will be discussed
in more detail <a href="#pool_cfg">there</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-nv">CMD_LINE_ARGS</span><span class="tok-o">=</span><span class="tok-s2">&quot;--trials=</span><span class="tok-nv">$CFG_TRIALS</span><span class="tok-s2"> --task_type=</span><span class="tok-nv">$CFG_TASK_TYPE</span><span class="tok-s2"> --batch_size=</span><span class="tok-nv">$CFG_BATCH_SIZE</span><span class="tok-s2"> &quot;</span>
<span class="tok-nv">CMD_LINE_ARGS</span><span class="tok-o">+=</span><span class="tok-s2">&quot;--batch_threshold=</span><span class="tok-nv">$CFG_BATCH_THRESHOLD</span><span class="tok-s2"> --worker_pool_id=</span><span class="tok-nv">$CFG_POOL_ID</span><span class="tok-s2"> </span><span class="tok-nv">$*</span><span class="tok-s2">&quot;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The final section logs a copy of the submission script to the experiment directory and
calls swift to submit the job and execute the workflow swift script.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># TODO: Add any script variables that you want to log as</span>
<span class="tok-c1"># part of the experiment meta data to the USER_VARS array,</span>
<span class="tok-c1"># for example, USER_VARS=(&quot;VAR_1&quot; &quot;VAR_2&quot;)</span>
<span class="tok-nv">USER_VARS</span><span class="tok-o">=()</span>
<span class="tok-c1"># log variables and script to to TURBINE_OUTPUT directory</span>
log_script<span class="tok-w">    </span><i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-c1"># echo&#39;s anything following this to standard out</span>
<span class="tok-nb">set</span><span class="tok-w"> </span>-x
<span class="tok-nv">SWIFT_FILE</span><span class="tok-o">=</span>eqsql_worker_pool.swift<span class="tok-w">    </span><i class="conum" data-value="2"></i><b>(2)</b>
swift-t<span class="tok-w"> </span>-n<span class="tok-w"> </span><span class="tok-nv">$PROCS</span><span class="tok-w"> </span><span class="tok-nv">$MACHINE</span><span class="tok-w"> </span>-p<span class="tok-w"> </span>-I<span class="tok-w"> </span><span class="tok-nv">$EQSQL</span><span class="tok-w"> </span>-r<span class="tok-w"> </span><span class="tok-nv">$EQSQL</span><span class="tok-w"> </span><span class="tok-se">\ </span><span class="tok-w">  </span><i class="conum" data-value="3"></i><b>(3)</b>
<span class="tok-w">    </span>-I<span class="tok-w"> </span><span class="tok-nv">$EMEWS_EXT</span><span class="tok-w"> </span>-r<span class="tok-w"> </span><span class="tok-nv">$EMEWS_EXT</span><span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">    </span>-e<span class="tok-w"> </span>TURBINE_MPI_THREAD<span class="tok-w"> </span><span class="tok-se">\ </span><span class="tok-w">   </span><i class="conum" data-value="4"></i><b>(4)</b>
<span class="tok-w">    </span>-e<span class="tok-w"> </span>TURBINE_OUTPUT<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">    </span>-e<span class="tok-w"> </span>EMEWS_PROJECT_ROOT<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">    </span>-e<span class="tok-w"> </span>DB_HOST<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">    </span>-e<span class="tok-w"> </span>DB_USER<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">    </span>-e<span class="tok-w"> </span>DB_PORT<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">    </span>-e<span class="tok-w"> </span>DB_NAME<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">    </span>-e<span class="tok-w"> </span>EQ_DB_RETRY_THRESHOLD<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">    </span>-e<span class="tok-w"> </span>PYTHONPATH<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">    </span>-e<span class="tok-w"> </span>RESIDENT_WORK_RANK<span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">    </span><span class="tok-nv">$EMEWS_PROJECT_ROOT</span>/swift/<span class="tok-nv">$SWIFT_FILE</span><span class="tok-w"> </span><span class="tok-se">\</span>
<span class="tok-w">    </span><span class="tok-nv">$CMD_LINE_ARGS</span><span class="tok-w">     </span><i class="conum" data-value="5"></i><b>(5)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Log a copy of this submission script including any of the variables
in <code>USER_VARS</code> to the experiment directory.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Define a variable containing the name of the swift workflow script to
execute.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Call swift passing it the relevant variables and the path of the swift script to be executed. At this point
the script is compiled and then either executed immediately or scheduled for execution depending on the value of the <code>MACHINE</code> variable.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The <code>-e</code> argument to swift adds the specified variable to the script execution environment. On some HPC machines,
the login environment is separate from the compute environment. Consequently, variables defined in the login environment
that are referenced in the swift script when it executes in the compute environment need to be made available for the
script to work correctly. The <code>-e</code> argument does this, adding the specified variables to the compute environment.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Pass <code>CMD_LINE_ARGS</code> to the swift script.</td>
</tr>
</table>
</div>
<div id="swift_worker_pool" class="paragraph">
<p><a href="https://github.com/jozik/emews_next_gen_tutorial_tests/blob/675eb2423dea8fd3c567a42dce610d655b9ab77e/code/eqsql_project/swift/eqsql_worker_pool.swift#L1" target="eqsql_worker_pool.swift"><code><strong>eqsql_worker_pool.swift</strong></code></a></p>
</div>
<div class="paragraph">
<p>This file is the swift script that implements the worker pool. The worker pool pops tasks off of the database
output queue and executes those tasks. When a task has completed, the worker pool pushes the result
into the database input queue where it can be retrieved by the ME. The following will describe the general
structure of the script, highlighting those areas most relevant to the user.</p>
</div>
<div class="paragraph">
<p>The script begins by defining some variables. The ones defined using the <code>getenv</code> function are
set from environment variables, while those those defined using <code>argv</code> are set from command
line arguments passed to the swift script from <a href="#pass_cmd_args"><code>run_eqsql_worker_pool.sh</code></a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="swift"><span></span><span class="tok-n">string</span> <span class="tok-n">emews_root</span> <span class="tok-p">=</span> <span class="tok-n">getenv</span><span class="tok-p">(</span><span class="tok-s">&quot;EMEWS_PROJECT_ROOT&quot;</span><span class="tok-p">);</span>    <i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-n">string</span> <span class="tok-n">turbine_output</span> <span class="tok-p">=</span> <span class="tok-n">getenv</span><span class="tok-p">(</span><span class="tok-s">&quot;TURBINE_OUTPUT&quot;</span><span class="tok-p">);</span>
<span class="tok-n">int</span> <span class="tok-n">resident_work_rank</span> <span class="tok-p">=</span> <span class="tok-n">string2int</span><span class="tok-p">(</span><span class="tok-n">getenv</span><span class="tok-p">(</span><span class="tok-s">&quot;RESIDENT_WORK_RANK&quot;</span><span class="tok-p">));</span>

<span class="tok-n">int</span> <span class="tok-n">TASK_TYPE</span> <span class="tok-p">=</span> <span class="tok-n">string2int</span><span class="tok-p">(</span><span class="tok-n">argv</span><span class="tok-p">(</span><span class="tok-s">&quot;task_type&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;0&quot;</span><span class="tok-p">));</span>    <i class="conum" data-value="2"></i><b>(2)</b>
<span class="tok-n">int</span> <span class="tok-n">BATCH_SIZE</span> <span class="tok-p">=</span> <span class="tok-n">string2int</span><span class="tok-p">(</span><span class="tok-n">argv</span><span class="tok-p">(</span><span class="tok-s">&quot;batch_size&quot;</span><span class="tok-p">));</span>
<span class="tok-n">int</span> <span class="tok-n">BATCH_THRESHOLD</span> <span class="tok-p">=</span> <span class="tok-n">string2int</span><span class="tok-p">(</span><span class="tok-n">argv</span><span class="tok-p">(</span><span class="tok-s">&quot;batch_threshold&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;1&quot;</span><span class="tok-p">));</span>
<span class="tok-n">string</span> <span class="tok-n">WORKER_POOL_ID</span> <span class="tok-p">=</span> <span class="tok-n">argv</span><span class="tok-p">(</span><span class="tok-s">&quot;worker_pool_id&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;default&quot;</span><span class="tok-p">);</span>

<span class="tok-n">file</span> <span class="tok-n">model_sh</span> <span class="tok-p">=</span> <span class="tok-n">input</span><span class="tok-p">(</span><span class="tok-n">emews_root</span><span class="tok-o">+</span><span class="tok-s">&quot;/scripts/run_my_model_eqsql_worker_pool.sh&quot;</span><span class="tok-p">);</span>    <i class="conum" data-value="3"></i><b>(3)</b>
<span class="tok-n">int</span> <span class="tok-n">n_trials</span> <span class="tok-p">=</span> <span class="tok-n">string2int</span><span class="tok-p">(</span><span class="tok-n">argv</span><span class="tok-p">(</span><span class="tok-s">&quot;trials&quot;</span><span class="tok-p">,</span> <span class="tok-s">&quot;1&quot;</span><span class="tok-p">));</span>    <i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Set <code>emews_root</code> and <code>turbine_output</code> from the EMEWS_PROJECT_ROOT and TURBINE_OUTPUT environment variables. These were exported in the <a href="https://github.com/jozik/emews_next_gen_tutorial_tests/blob/675eb2423dea8fd3c567a42dce610d655b9ab77e/code/eqsql_project/swift/run_eqsql_worker_pool.sh#L13" target="run_eqsql_worker_pool.sh"><code><strong>run_eqsql_worker_pool.sh</strong></code></a> script.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Set the TASK_TYPE, BATCH_SIZE, BATCH_THRESHOLD, and WORKER_POOL_ID variables. These are used
by the swift script when fetching tasks and reporting task results.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Get the bash script that will be used to launch the model. Swift calls this <a href="#run_my_model">script</a> (<code>scripts/run_my_model.sh</code>) to perform a model run.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Get the number of trials (replicates) to perform for each model run.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The script execution begins by calling the start function in which we initialize the
task batch querying from the database.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="swift"><span></span><span class="tok-p">(</span><span class="tok-n">void</span> <span class="tok-n">o</span><span class="tok-p">)</span> <span class="tok-n">start</span><span class="tok-p">()</span> <span class="tok-p">{</span>
  <span class="tok-n">location</span> <span class="tok-n">querier_loc</span> <span class="tok-p">=</span> <span class="tok-n">locationFromRank</span><span class="tok-p">(</span><span class="tok-n">resident_work_rank</span><span class="tok-p">);</span>
  <span class="tok-n">eq_init_batch_querier</span><span class="tok-p">(</span><span class="tok-n">querier_loc</span><span class="tok-p">,</span> <span class="tok-n">WORKER_POOL_ID</span><span class="tok-p">,</span> <span class="tok-n">BATCH_SIZE</span><span class="tok-p">,</span> <span class="tok-n">BATCH_THRESHOLD</span><span class="tok-p">,</span> <span class="tok-n">TASK_TYPE</span><span class="tok-p">)</span> <span class="tok-p">=</span><span class="tok-o">&gt;</span>    <i class="conum" data-value="1"></i><b>(1)</b>
  <span class="tok-n">loop</span><span class="tok-p">(</span><span class="tok-n">querier_loc</span><span class="tok-p">)</span> <span class="tok-p">=</span><span class="tok-o">&gt;</span> <span class="tok-p">{</span>    <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="tok-n">eq_stop_batch_querier</span><span class="tok-p">(</span><span class="tok-n">querier_loc</span><span class="tok-p">);</span>    <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="tok-n">o</span> <span class="tok-p">=</span> <span class="tok-n">propagate</span><span class="tok-p">();</span>
  <span class="tok-p">}</span>
<span class="tok-p">}</span>

<span class="tok-n">start</span><span class="tok-p">()</span> <span class="tok-p">=</span><span class="tok-o">&gt;</span> <span class="tok-n">printf</span><span class="tok-p">(</span><span class="tok-s">&quot;worker pool: normal exit.&quot;</span><span class="tok-p">);</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Initialize the batch querier for the worker pool identified by <code>WORKER_POOL_ID</code>,
requesting tasks of <code>TASK_TYPE</code> with the specified <code>BATCH_SIZE</code>, and <code>BATCH_THRESHOLD</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Call the loop function in which tasks are retrieved, executed, and results reported.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Stop the batch querier, and exit the script.</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Batch querying allows a worker pool to request up to <code>BATCH_SIZE</code> number of tasks to consume at a time, while accounting for the number of tasks a worker pool has already obtained but have not yet completed. So, for example, if a worker pool is configured to possess 33 tasks at a time, if it owns 30 uncompleted tasks when querying the output queue, it will only obtain 3 additional tasks. This can be tweaked using a <code>BATCH_THRESHOLD</code> value that specifies how large the deficit between requested tasks and owned tasks must be before more tasks are obtained.
Querying for tasks in this way allows a worker pool to tune its query to the number of available workers such that all its workers are busy while equitably sharing work among multiple possible worker pools.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In the loop function, tasks are retrieved and dispatched for execution.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="swift"><span></span><span class="tok-n">message</span> <span class="tok-n">msgs</span><span class="tok-p">[]</span> <span class="tok-p">=</span> <span class="tok-n">eq_batch_task_query</span><span class="tok-p">(</span><span class="tok-n">querier_loc</span><span class="tok-p">);</span>    <i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-n">boolean</span> <span class="tok-n">c</span><span class="tok-p">;</span>
<span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-n">msgs</span><span class="tok-p">[</span><span class="tok-mi">0</span><span class="tok-p">].</span><span class="tok-n">msg_type</span> <span class="tok-p">==</span> <span class="tok-s">&quot;status&quot;</span><span class="tok-p">)</span> <span class="tok-p">{</span>    <i class="conum" data-value="2"></i><b>(2)</b>
  <span class="tok-k">if</span> <span class="tok-p">(</span><span class="tok-n">msgs</span><span class="tok-p">[</span><span class="tok-mi">0</span><span class="tok-p">].</span><span class="tok-n">payload</span> <span class="tok-p">==</span> <span class="tok-s">&quot;EQ_STOP&quot;</span><span class="tok-p">)</span> <span class="tok-p">{</span>
    <span class="tok-n">printf</span><span class="tok-p">(</span><span class="tok-s">&quot;loop.swift: STOP&quot;</span><span class="tok-p">)</span> <span class="tok-p">=</span><span class="tok-o">&gt;</span>
      <span class="tok-n">v</span> <span class="tok-p">=</span> <span class="tok-n">propagate</span><span class="tok-p">()</span> <span class="tok-p">=</span><span class="tok-o">&gt;</span>
      <span class="tok-n">c</span> <span class="tok-p">=</span> <span class="tok-kc">false</span><span class="tok-p">;</span>
  <span class="tok-p">}</span> <span class="tok-k">else</span> <span class="tok-p">{</span>
    <span class="tok-c1">// sleep to give time for Python etc.</span>
    <span class="tok-c1">// to flush messages</span>
    <span class="tok-n">sleep</span><span class="tok-p">(</span><span class="tok-mi">5</span><span class="tok-p">);</span>
    <span class="tok-n">printf</span><span class="tok-p">(</span><span class="tok-s">&quot;loop.swift: got %s: exiting!&quot;</span><span class="tok-p">,</span> <span class="tok-n">msgs</span><span class="tok-p">[</span><span class="tok-mi">0</span><span class="tok-p">].</span><span class="tok-n">payload</span><span class="tok-p">)</span> <span class="tok-p">=</span><span class="tok-o">&gt;</span>
    <span class="tok-n">v</span> <span class="tok-p">=</span> <span class="tok-n">propagate</span><span class="tok-p">()</span> <span class="tok-p">=</span><span class="tok-o">&gt;</span>
    <span class="tok-n">c</span> <span class="tok-p">=</span> <span class="tok-kc">false</span><span class="tok-p">;</span>
  <span class="tok-p">}</span>
<span class="tok-p">}</span> <span class="tok-k">else</span> <span class="tok-p">{</span>
  <span class="tok-n">run</span><span class="tok-p">(</span><span class="tok-n">msgs</span><span class="tok-p">);</span>    <i class="conum" data-value="3"></i><b>(3)</b>
  <span class="tok-n">c</span> <span class="tok-p">=</span> <span class="tok-kc">true</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Query for tasks to execute, retrieving them in swift array. The tasks are formatted as <code>message</code>-s. Each message
has an integer <code>task_id</code>, a string <code>msg_type</code>, and string <code>payload</code>. The <code>task_id</code> is a unique
identifier for the task, the <code>msg_type</code> specifies the type of message: <code>status</code> or <code>work</code>.
The <code>payload</code> consists of either a status update, or input to the task to be performed in JSON format.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>If the first of the message types is <code>status</code> then exit the loop with the appropriately.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>If the first of the message types is not <code>status</code>, then execute the task messages in the array.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The run function executes the tasks in parallel in a swift <code>foreach</code> loop, and reports the results back
to the database.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="swift"><span></span><span class="tok-n">run</span><span class="tok-p">(</span><span class="tok-n">message</span> <span class="tok-n">msgs</span><span class="tok-p">[])</span> <span class="tok-p">{</span>
  <span class="tok-c1">// printf(&quot;MSGS SIZE: %d&quot;, size(msgs));</span>
  <span class="tok-n">foreach</span> <span class="tok-n">msg</span><span class="tok-p">,</span> <span class="tok-n">i</span> <span class="tok-k">in</span> <span class="tok-n">msgs</span> <span class="tok-p">{</span>
    <span class="tok-n">result_payload</span> <span class="tok-p">=</span> <span class="tok-n">run_task</span><span class="tok-p">(</span><span class="tok-n">msg</span><span class="tok-p">.</span><span class="tok-n">eq_task_id</span><span class="tok-p">,</span> <span class="tok-n">msg</span><span class="tok-p">.</span><span class="tok-n">payload</span><span class="tok-p">);</span>
    <span class="tok-n">eq_task_report</span><span class="tok-p">(</span><span class="tok-n">msg</span><span class="tok-p">.</span><span class="tok-n">eq_task_id</span><span class="tok-p">,</span> <span class="tok-n">TASK_TYPE</span><span class="tok-p">,</span> <span class="tok-n">result_payload</span><span class="tok-p">);</span>
  <span class="tok-p">}</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><code>run_task</code> executes the specified number of trials for an individual task (e.g., a model run), running the task with the same parameters and varying a random seed parameter. All the trials will run in an <code>instance_N</code> directory
where <code>N</code> is the task&#8217;s task_id.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="swift"><span></span><span class="tok-p">(</span><span class="tok-n">string</span> <span class="tok-n">obj_result</span><span class="tok-p">)</span> <span class="tok-n">run_task</span><span class="tok-p">(</span><span class="tok-n">int</span> <span class="tok-n">task_id</span><span class="tok-p">,</span> <span class="tok-n">string</span> <span class="tok-n">task_payload</span><span class="tok-p">)</span> <span class="tok-p">{</span>
    <span class="tok-n">float</span> <span class="tok-n">results</span><span class="tok-p">[];</span>

    <span class="tok-n">string</span> <span class="tok-n">instance</span> <span class="tok-p">=</span> <span class="tok-s">&quot;%s/instance_%i/&quot;</span> <span class="tok-o">%</span> <span class="tok-p">(</span><span class="tok-n">turbine_output</span><span class="tok-p">,</span> <span class="tok-n">task_id</span><span class="tok-p">);</span>
    <span class="tok-n">mkdir</span><span class="tok-p">(</span><span class="tok-n">instance</span><span class="tok-p">)</span> <span class="tok-p">=</span><span class="tok-o">&gt;</span> <span class="tok-p">{</span>    <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="tok-n">foreach</span> <span class="tok-n">i</span> <span class="tok-k">in</span> <span class="tok-p">[</span><span class="tok-mi">0</span><span class="tok-p">:</span><span class="tok-n">n_trials</span><span class="tok-o">-</span><span class="tok-mi">1</span><span class="tok-p">:</span><span class="tok-mi">1</span><span class="tok-p">]</span> <span class="tok-p">{</span>    <i class="conum" data-value="2"></i><b>(2)</b>
            <span class="tok-n">int</span> <span class="tok-n">trial</span> <span class="tok-p">=</span> <span class="tok-n">i</span> <span class="tok-o">+</span> <span class="tok-mi">1</span><span class="tok-p">;</span>
            <span class="tok-n">string</span> <span class="tok-n">instance_id</span> <span class="tok-p">=</span> <span class="tok-s">&quot;i_%i&quot;</span> <span class="tok-o">%</span> <span class="tok-p">(</span><span class="tok-n">task_id</span><span class="tok-p">,</span> <span class="tok-n">trial</span><span class="tok-p">);</span>
            <span class="tok-n">results</span><span class="tok-p">[</span><span class="tok-n">i</span><span class="tok-p">]</span> <span class="tok-p">=</span> <span class="tok-n">run_obj</span><span class="tok-p">(</span><span class="tok-n">task_payload</span><span class="tok-p">,</span> <span class="tok-n">trial</span><span class="tok-p">,</span> <span class="tok-n">instance</span><span class="tok-p">,</span> <span class="tok-n">instance_id</span><span class="tok-p">);</span>    <i class="conum" data-value="3"></i><b>(3)</b>
        <span class="tok-p">}</span>
    <span class="tok-p">}</span>

    <span class="tok-n">obj_result</span> <span class="tok-p">=</span> <span class="tok-n">float2string</span><span class="tok-p">(</span><span class="tok-n">get_aggregate_result</span><span class="tok-p">(</span><span class="tok-n">results</span><span class="tok-p">));</span> <span class="tok-c1">// =&gt;    </span><i class="conum" data-value="4"></i><b>(4)</b>
    <span class="tok-c1">// </span><span class="tok-cs">TODO:</span><span class="tok-c1"> delete the &quot;;&quot; above, uncomment the &quot;&quot;=&gt;&quot;&quot; above and</span>
    <span class="tok-c1">// and the rm_dir below to delete the instance directory if</span>
    <span class="tok-c1">// it is not needed after the result have been computed.</span>
    <span class="tok-c1">// rm_dir(instance);</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Create the instance directory</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Iterate concurrently over the number of trials.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>For each trial, call <code>run_obj</code>, passing the task payload (input parameters),
trial number, instance directory, and instance_id. The result from each trial
is added to the <code>results</code> array.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Call <code>get_aggregate_result</code> passing it the results from each trial to compute the
aggregate result over all the trials.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><code>run_obj</code> creates files for logging model run&#8217;s standard output and error streams, as well as path location for the model results, and calls the swift app function <code>run_task_app</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="swift"><span></span><span class="tok-p">(</span><span class="tok-n">float</span> <span class="tok-n">result</span><span class="tok-p">)</span> <span class="tok-n">run_obj</span><span class="tok-p">(</span><span class="tok-n">string</span> <span class="tok-n">task_payload</span><span class="tok-p">,</span> <span class="tok-n">int</span> <span class="tok-n">trial</span><span class="tok-p">,</span> <span class="tok-n">string</span> <span class="tok-n">instance_dir</span><span class="tok-p">,</span> <span class="tok-n">string</span> <span class="tok-n">instance_id</span><span class="tok-p">)</span> <span class="tok-p">{</span>
    <span class="tok-n">file</span> <span class="tok-n">out</span> <span class="tok-p">&lt;</span><span class="tok-n">instance_dir</span> <span class="tok-o">+</span> <span class="tok-s">&quot;/&quot;</span> <span class="tok-o">+</span> <span class="tok-n">instance_id</span><span class="tok-o">+</span><span class="tok-s">&quot;_out.txt&quot;</span><span class="tok-o">&gt;</span><span class="tok-p">;</span>    <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="tok-n">file</span> <span class="tok-n">err</span> <span class="tok-p">&lt;</span><span class="tok-n">instance_dir</span> <span class="tok-o">+</span> <span class="tok-s">&quot;/&quot;</span> <span class="tok-o">+</span> <span class="tok-n">instance_id</span><span class="tok-o">+</span><span class="tok-s">&quot;_err.txt&quot;</span><span class="tok-o">&gt;</span><span class="tok-p">;</span>
    <span class="tok-n">string</span> <span class="tok-n">output_file</span> <span class="tok-p">=</span> <span class="tok-s">&quot;%s/output_%s.csv&quot;</span> <span class="tok-o">%</span> <span class="tok-p">(</span><span class="tok-n">instance_dir</span><span class="tok-p">,</span> <span class="tok-n">instance_id</span><span class="tok-p">);</span>    <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="tok-p">(</span><span class="tok-n">out</span><span class="tok-p">,</span><span class="tok-n">err</span><span class="tok-p">)</span> <span class="tok-p">=</span> <span class="tok-n">run_task_app</span><span class="tok-p">(</span><span class="tok-n">model_sh</span><span class="tok-p">,</span> <span class="tok-n">task_payload</span><span class="tok-p">,</span> <span class="tok-n">output_file</span><span class="tok-p">,</span>  <span class="tok-n">trial</span><span class="tok-p">,</span> <span class="tok-n">instance_dir</span><span class="tok-p">)</span> <span class="tok-p">=</span><span class="tok-o">&gt;</span>    <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="tok-n">result</span> <span class="tok-p">=</span> <span class="tok-n">get_result</span><span class="tok-p">(</span><span class="tok-n">output_file</span><span class="tok-p">);</span>    <i class="conum" data-value="4"></i><b>(4)</b>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Create swift file objects to capture the standard out and standard error from the <code>run_task_app</code>
function.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Create a unique output file name for the trial run that can be passed to the model to write its
output.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Call <code>run_task_app</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Call <code>get_result</code>, passing the output file to retrieve the output of the model run from the
output file.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><code>run_task_app</code> calls <a href="#run_my_model"><code>scripts/run_my_model.sh</code></a> passing it the task payload,
the output file path, the trial number, the emews_root location, and the instance directory. The
<code>@stdout</code> and <code>@stderr</code> commands are used by swift to redirect the standard out and standard
error streams to files specified in <code>run_obj</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="swift"><span></span><span class="tok-c1">// app function used to run the task</span>
<span class="tok-n">app</span> <span class="tok-p">(</span><span class="tok-n">file</span> <span class="tok-n">out</span><span class="tok-p">,</span> <span class="tok-n">file</span> <span class="tok-n">err</span><span class="tok-p">)</span> <span class="tok-n">run_task_app</span><span class="tok-p">(</span><span class="tok-n">file</span> <span class="tok-n">shfile</span><span class="tok-p">,</span> <span class="tok-n">string</span> <span class="tok-n">task_payload</span><span class="tok-p">,</span> <span class="tok-n">string</span> <span class="tok-n">output_file</span><span class="tok-p">,</span> <span class="tok-n">int</span> <span class="tok-n">trial</span><span class="tok-p">,</span> <span class="tok-n">string</span> <span class="tok-n">instance_dir</span><span class="tok-p">)</span> <span class="tok-p">{</span>
    <span class="tok-s">&quot;bash&quot;</span> <span class="tok-n">shfile</span> <span class="tok-n">task_payload</span> <span class="tok-n">output_file</span> <span class="tok-n">trial</span> <span class="tok-n">emews_root</span> <span class="tok-n">instance_dir</span> <span class="tok-p">@</span><span class="tok-n">stdout</span><span class="tok-p">=</span><span class="tok-n">out</span> <span class="tok-p">@</span><span class="tok-n">stderr</span><span class="tok-p">=</span><span class="tok-n">err</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The final two functions are the result calculations. These need to be completed by the user
and are marked with the appropriate TODOs.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="swift"><span></span><span class="tok-p">(</span><span class="tok-n">float</span> <span class="tok-n">result</span><span class="tok-p">)</span> <span class="tok-n">get_result</span><span class="tok-p">(</span><span class="tok-n">string</span> <span class="tok-n">output_file</span><span class="tok-p">)</span> <span class="tok-p">{</span>
    <span class="tok-c1">// TODO given the model output, set the the model result</span>
    <span class="tok-n">result</span> <span class="tok-p">=</span> <span class="tok-mf">0.0</span><span class="tok-p">;</span>
<span class="tok-p">}</span>

<span class="tok-p">(</span><span class="tok-n">float</span> <span class="tok-n">agg_result</span><span class="tok-p">)</span> <span class="tok-n">get_aggregate_result</span><span class="tok-p">(</span><span class="tok-n">float</span> <span class="tok-n">model_results</span><span class="tok-p">[])</span> <span class="tok-p">{</span>
    <span class="tok-c1">// TODO replace with aggregate result calculation (e.g.,</span>
    <span class="tok-c1">// take the average of model results with avg(model_results);</span>
    <span class="tok-n">agg_result</span> <span class="tok-p">=</span> <span class="tok-mf">0.0</span><span class="tok-p">;</span>
<span class="tok-p">}</span></code></pre>
</div>
</div>
<div id="pool_cfg" class="paragraph">
<p><a href="https://github.com/jozik/emews_next_gen_tutorial_tests/blob/675eb2423dea8fd3c567a42dce610d655b9ab77e/code/eqsql_project/swift/cfgs/eqsql_worker_pool.cfg#L1" target="eqsql_worker_pool"><code><strong>eqsql_worker_pool.cfg</strong></code></a></p>
</div>
<div class="paragraph">
<p><code>eqsql_worker_pool.cfg</code> contains configuration variables for running the worker pool. It is sourced
by the submission <a href="#submit_init">script</a> <code>run_eqsql_worker_pool.sh</code> to retrieve the database connection parameters, the HPC scheduler parameters, and the other variables required by the workflow.
The intention here is that these parameters are the most frequently changed between
different workflow runs, and rather than edit the submission script itself, it is easier to edit
a short configuration file.</p>
</div>
<div class="paragraph">
<p>The cfg file begins with the HPC and general workflow setup parameters.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-nv">CFG_WALLTIME</span><span class="tok-o">=</span><span class="tok-m">01</span>:00:00<span class="tok-w">    </span><i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-nv">CFG_QUEUE</span><span class="tok-o">=</span>queue<span class="tok-w">    </span><i class="conum" data-value="2"></i><b>(2)</b>
<span class="tok-nv">CFG_PROJECT</span><span class="tok-o">=</span>project<span class="tok-w">    </span><i class="conum" data-value="3"></i><b>(3)</b>
<span class="tok-nv">NODES</span><span class="tok-o">=</span><span class="tok-m">4</span><span class="tok-w">    </span><i class="conum" data-value="4"></i><b>(4)</b>
<span class="tok-nv">CFG_PPN</span><span class="tok-o">=</span><span class="tok-m">4</span><span class="tok-w">    </span><i class="conum" data-value="5"></i><b>(5)</b>
<span class="tok-nv">CFG_PROCS</span><span class="tok-o">=</span><span class="tok-k">$((</span><span class="tok-w"> </span><span class="tok-nv">NODES</span><span class="tok-w"> </span><span class="tok-o">*</span><span class="tok-w"> </span><span class="tok-nv">CFG_PPN</span><span class="tok-w"> </span><span class="tok-k">))</span><span class="tok-w">    </span><i class="conum" data-value="6"></i><b>(6)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Set the estimated duration of the workflow.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Set the queue on which to run the workflow.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Set the project under which to run the workflow.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Set the number of HPC nodes to run the workflow with.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Set the number of process per node (PPN) to use.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Compute the total number of processes to allocate to the job
by multiplying the number of nodes by the PPN.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The database connection parameters are used by the swift script to connect to the EQSQL database.
The postgresql database requires a user, database, hostname, and optional port when connecting.
Those are specified here.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># Database port - this can be left empty</span>
<span class="tok-c1"># for local conda postgresql install</span>
<span class="tok-nv">CFG_DB_PORT</span><span class="tok-o">=</span><span class="tok-w">    </span><i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-nv">CFG_DB_USER</span><span class="tok-o">=</span>eqsql_user<span class="tok-w">    </span><i class="conum" data-value="2"></i><b>(2)</b>
<span class="tok-nv">CFG_DB_NAME</span><span class="tok-o">=</span>EQ_SQL<span class="tok-w">    </span><i class="conum" data-value="3"></i><b>(3)</b>
<span class="tok-nv">CFG_DB_HOST</span><span class="tok-o">=</span>localhost<span class="tok-w">     </span><i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Set the database port. If using the default local database configuration, no port needs
to be specified.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Set the database user name. This defaults to <code>eqsql_user</code> under the default local database
configuration.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Set the database name. This defaults to <code>EQ_SQL</code> under the default local database configuration.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Set the database host name. This defaults to <code>localhost</code> under the default local database
configuration.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The final set of parameters sets the number of trials, the worker pool id, the task type
the worker pool will retrieve, and the task query parameters.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-nv">CFG_TRIALS</span><span class="tok-o">=</span><span class="tok-m">10</span><span class="tok-w">    </span><i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-nv">CFG_POOL_ID</span><span class="tok-o">=</span>default<span class="tok-w">    </span><i class="conum" data-value="2"></i><b>(2)</b>
<span class="tok-c1"># Update this to match the task / work type</span>
<span class="tok-nv">CFG_TASK_TYPE</span><span class="tok-o">=</span><span class="tok-m">0</span><span class="tok-w">    </span><i class="conum" data-value="3"></i><b>(3)</b>
<span class="tok-nv">CFG_BATCH_SIZE</span><span class="tok-o">=</span><span class="tok-k">$((</span><span class="tok-w"> </span><span class="tok-nv">CFG_PROCS</span><span class="tok-w"> </span><span class="tok-o">+</span><span class="tok-w"> </span><span class="tok-m">2</span><span class="tok-w"> </span><span class="tok-k">))</span><span class="tok-w">    </span><i class="conum" data-value="4"></i><b>(4)</b>
<span class="tok-nv">CFG_BATCH_THRESHOLD</span><span class="tok-o">=</span><span class="tok-m">1</span><span class="tok-w">    </span><i class="conum" data-value="5"></i><b>(5)</b>
<span class="tok-nv">CFG_DB_RETRY_THRESHOLD</span><span class="tok-o">=</span><span class="tok-m">10</span><span class="tok-w">      </span><i class="conum" data-value="6"></i><b>(6)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Set the number of trials / replicates to perform</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Set the unique identifier for the worker pool</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Set the task type that the worker pool will retrieve from the database.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Set the batch size for batch task querying. The worker pool will request up to this number
of tasks to own at a time. For example, if the batch size is 33, and the worker pool currently owns 30 uncompleted tasks, it will only obtain 3 additional tasks when querying the output queue.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Set the batch query threshold which specifies how large the deficit between requested tasks and owned tasks must be before more tasks are obtained.</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
A worker pool can request and own all the task in the database by setting <code>CFG_BATCH_SIZE</code> to a number
greater than the number of expected tasks. A smaller number, however, allows an ME to manipulate the database output queue re-prioritizing existing unowned tasks, for example.
</td>
</tr>
</table>
</div>
<div id="run_my_model" class="paragraph">
<p><a href="https://github.com/jozik/emews_next_gen_tutorial_tests/blob/675eb2423dea8fd3c567a42dce610d655b9ab77e/code/eqsql_project/scripts/run_my_model.sh#L1" target="run_my_model.sh"><code><strong>run_my_model.sh</strong></code></a></p>
</div>
<div class="paragraph">
<p><code>run_my_model.sh</code> is called by <code>eqsql_worker_pool.swift</code> to execute the model as if the model has been run from the command line. The script passes model input parameters (the payload string), the output file for the
model to use, the trial number for this set of parameters, the emews root directory location, and the instance directory that was created in <code>eqsql_worker_pool.swift</code>. <code>run_my_model.sh</code> includes two important <strong>TODOs</strong>.
You will need to update the <code>MODEL_CMD</code> variable to specify the model executable, and the <code>arg_array</code> to
specify the command line parameters to the model command.</p>
</div>
<div class="paragraph">
<p>The script begins with defining an optional <code>TIMEOUT</code> that will timeout the model if its
run duration exceeds that value.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># Check for an optional timeout threshold in seconds. If the duration of the</span>
<span class="tok-c1"># model run as executed below, takes longer that this threshhold</span>
<span class="tok-c1"># then the run will be aborted. Note that the &quot;timeout&quot; command</span>
<span class="tok-c1"># must be supported by executing OS.</span>

<span class="tok-c1"># The timeout argument is optional. By default the &quot;run_model&quot; swift</span>
<span class="tok-c1"># app fuction sends 5 arguments, and no timeout value is set. If there</span>
<span class="tok-c1"># is a 6th (the TIMEOUT_ARG_INDEX) argument, we use that as the timeout value.</span>

<span class="tok-c1"># !!! IF YOU CHANGE THE NUMBER OF ARGUMENTS PASSED TO THIS SCRIPT, YOU MUST</span>
<span class="tok-c1"># CHANGE THE TIMEOUT_ARG_INDEX !!!</span>
<span class="tok-nv">TIMEOUT</span><span class="tok-o">=</span><span class="tok-s2">&quot;&quot;</span>
<span class="tok-nv">TIMEOUT_ARG_INDEX</span><span class="tok-o">=</span><span class="tok-m">6</span><span class="tok-w">    </span><i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-o">[[</span><span class="tok-w"> </span><span class="tok-nv">$#</span><span class="tok-w"> </span><span class="tok-o">==</span><span class="tok-w">  </span><span class="tok-nv">$TIMEOUT_ARG_INDEX</span><span class="tok-w"> </span><span class="tok-o">]]</span>
<span class="tok-k">then</span>
<span class="tok-w">	</span><span class="tok-nv">TIMEOUT</span><span class="tok-o">=</span><span class="tok-si">${</span><span class="tok-p">!TIMEOUT_ARG_INDEX</span><span class="tok-si">}</span>
<span class="tok-k">fi</span>

<span class="tok-nv">TIMEOUT_CMD</span><span class="tok-o">=</span><span class="tok-s2">&quot;&quot;</span>
<span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-o">[</span><span class="tok-w"> </span>-n<span class="tok-w"> </span><span class="tok-s2">&quot;</span><span class="tok-nv">$TIMEOUT</span><span class="tok-s2">&quot;</span><span class="tok-w"> </span><span class="tok-o">]</span><span class="tok-p">;</span><span class="tok-w"> </span><span class="tok-k">then</span>
<span class="tok-w">  </span><span class="tok-nv">TIMEOUT_CMD</span><span class="tok-o">=</span><span class="tok-s2">&quot;timeout </span><span class="tok-nv">$TIMEOUT</span><span class="tok-s2">&quot;</span>
<span class="tok-k">fi</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>If this script is passed <code>TIMEOUT_ARG_INDEX</code> number of arguments,
then that argument (defaulting to the 6th argument) will be used as
the number of seconds after which to timeout.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The next section of the script assigns the scripts command line arguments to
variables and changes the directory to the instance directory passed to
the script.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># Set PARAM_LINE from the first argument to this script</span>
<span class="tok-c1"># PARAM_LINE is the string containing the model parameters for a run.</span>
<span class="tok-nv">PARAM_LINE</span><span class="tok-o">=</span><span class="tok-nv">$1</span>

<span class="tok-c1"># Set the name of the file to write model output to.</span>
<span class="tok-nv">OUTPUT_FILE</span><span class="tok-o">=</span><span class="tok-nv">$2</span>

<span class="tok-c1"># Set the TRIAL_ID - this can be used to pass a random seed (for example)</span>
<span class="tok-c1"># to the model</span>
<span class="tok-nv">TRIAL_ID</span><span class="tok-o">=</span><span class="tok-nv">$3</span>

<span class="tok-c1"># Set EMEWS_ROOT to the root directory of the project (i.e. the directory</span>
<span class="tok-c1"># that contains the scripts, swift, etc. directories and files)</span>
<span class="tok-nv">EMEWS_ROOT</span><span class="tok-o">=</span><span class="tok-nv">$4</span>

<span class="tok-c1"># Each model run, runs in its own &quot;instance&quot; directory</span>
<span class="tok-c1"># Set INSTANCE_DIRECTORY to that and cd into it.</span>
<span class="tok-nv">INSTANCE_DIRECTORY</span><span class="tok-o">=</span><span class="tok-nv">$5</span>
<span class="tok-nb">cd</span><span class="tok-w"> </span><span class="tok-nv">$INSTANCE_DIRECTORY</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The final section defines the model executable in <code>MODEL_CMD</code>, the arguments to
that executable in <code>arg_array</code> and runs the model with the optional timeout.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># TODO: Define the command to run the model. For example,</span>
<span class="tok-c1"># MODEL_CMD=&quot;python&quot;</span>
<span class="tok-nv">MODEL_CMD</span><span class="tok-o">=</span><span class="tok-s2">&quot;&quot;</span><span class="tok-w">    </span><i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-c1"># TODO: Define the arguments to the MODEL_CMD. Each argument should be</span>
<span class="tok-c1"># surrounded by quotes and separated by spaces. For example,</span>
<span class="tok-c1"># arg_array=(&quot;$EMEWS_ROOT/python/my_model.py&quot; &quot;$PARAM_LINE&quot; &quot;$OUTPUT_FILE&quot; &quot;$TRIAL_ID&quot;)</span>
<span class="tok-nv">arg_array</span><span class="tok-o">=(</span><span class="tok-s2">&quot;arg1&quot;</span><span class="tok-w"> </span><span class="tok-s2">&quot;arg2&quot;</span><span class="tok-w"> </span><span class="tok-s2">&quot;arg3&quot;</span><span class="tok-o">)</span><span class="tok-w">    </span><i class="conum" data-value="2"></i><b>(2)</b>

<span class="tok-c1"># Turn bash error checking off. This is</span>
<span class="tok-c1"># required to properly handle the model execution</span>
<span class="tok-c1"># return values and the optional timeout.</span>
<span class="tok-nb">set</span><span class="tok-w"> </span>+e
<span class="tok-nb">echo</span><span class="tok-w"> </span><span class="tok-s2">&quot;Running </span><span class="tok-nv">$MODEL_CMD</span><span class="tok-s2"> </span><span class="tok-si">${</span><span class="tok-nv">arg_array</span><span class="tok-p">[@]</span><span class="tok-si">}</span><span class="tok-s2">&quot;</span>

<span class="tok-nv">$TIMEOUT_CMD</span><span class="tok-w"> </span><span class="tok-s2">&quot;</span><span class="tok-nv">$MODEL_CMD</span><span class="tok-s2">&quot;</span><span class="tok-w"> </span><span class="tok-s2">&quot;</span><span class="tok-si">${</span><span class="tok-nv">arg_array</span><span class="tok-p">[@]</span><span class="tok-si">}</span><span class="tok-s2">&quot;</span><span class="tok-w">    </span><i class="conum" data-value="3"></i><b>(3)</b>

<span class="tok-c1"># $? is the exit status of the most recently executed command (i.e the</span>
<span class="tok-c1"># line above)</span>
<span class="tok-nv">RES</span><span class="tok-o">=</span><span class="tok-nv">$?</span>
<span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-o">[</span><span class="tok-w"> </span><span class="tok-s2">&quot;</span><span class="tok-nv">$RES</span><span class="tok-s2">&quot;</span><span class="tok-w"> </span>-ne<span class="tok-w"> </span><span class="tok-m">0</span><span class="tok-w"> </span><span class="tok-o">]</span><span class="tok-p">;</span><span class="tok-w"> </span><span class="tok-k">then</span>
<span class="tok-w">	</span><span class="tok-k">if</span><span class="tok-w"> </span><span class="tok-o">[</span><span class="tok-w"> </span><span class="tok-s2">&quot;</span><span class="tok-nv">$RES</span><span class="tok-s2">&quot;</span><span class="tok-w"> </span><span class="tok-o">==</span><span class="tok-w"> </span><span class="tok-m">124</span><span class="tok-w"> </span><span class="tok-o">]</span><span class="tok-p">;</span><span class="tok-w"> </span><span class="tok-k">then</span>
<span class="tok-w">    </span><span class="tok-nb">echo</span><span class="tok-w"> </span><span class="tok-s2">&quot;---&gt; Timeout error in </span><span class="tok-nv">$COMMAND</span><span class="tok-s2">&quot;</span>
<span class="tok-w">  </span><span class="tok-k">else</span>
<span class="tok-w">	   </span><span class="tok-nb">echo</span><span class="tok-w"> </span><span class="tok-s2">&quot;---&gt; Error in </span><span class="tok-nv">$COMMAND</span><span class="tok-s2">&quot;</span>
<span class="tok-w">  </span><span class="tok-k">fi</span>
<span class="tok-k">fi</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Define the model executable. For a stand alone compiled executable, this will be
the path to that executable. For example, something like <code>$HOME/sfw/epi_model-1.0/bin/epimodel</code>.
For a model written in an interpreted language such as R or Python, this will be the <code>Rscript</code> or <code>python</code>
executable.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Define the array of arguments to pass to the <code>MODEL_CMD</code> executable. At the very
least, this will typically include the <code>PARAM_LINE</code> variable in order to pass the
task payload input parameters to the model. For an R or Python application, this will also include
the path to the R or Python code to run.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Run the model with the optional <code>TIMEOUT_CMD</code>. If no <code>TIMEOUT</code> was specified, the <code>TIMEOUT_CMD</code>
will be an ignored empty string.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><a href="https://github.com/jozik/emews_next_gen_tutorial_tests/blob/675eb2423dea8fd3c567a42dce610d655b9ab77e/code/eqsql_project/python/algo.py#L1" target="algo"><code><strong>algo.py</strong></code></a></p>
</div>
<div class="paragraph">
<p>If the <code>me_language</code> argument to the <code>eqsql</code> template command is <code>python</code>, then an example Python ME and ME configuration file will be produced. The ME can be run from the command line as follows:</p>
</div>
<div class="paragraph">
<p><mark>TODO: text about local vs. remote run</mark></p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ python3 algo.py -h
usage: algo.py [-h] exp_id config_file

positional arguments:
  exp_id       experiment id
  config_file  yaml format configuration file

optional arguments:
  -h, --help   show this help message and exit</pre>
</div>
</div>
<div class="paragraph">
<p>The two command line parameters to <code>algo.py</code> are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>exp_id</code> - an experiment identifier for the current run the workflow (e.g., epi_model_experiment_3).</p>
</li>
<li>
<p><code>config_file</code> - the path to the ME configuration file (e.g., <code>algo_cfg.yaml</code>)</p>
</li>
</ul>
</div>
<div id="me_main" class="paragraph">
<p>The bare example ME contains two functions and a <code>if <em>name</em> == 'main'</code> section.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">create_parser</span><span class="tok-p">():</span>
    <span class="tok-n">parser</span> <span class="tok-o">=</span> <span class="tok-n">argparse</span><span class="tok-o">.</span><span class="tok-n">ArgumentParser</span><span class="tok-p">()</span>
    <span class="tok-n">parser</span><span class="tok-o">.</span><span class="tok-n">add_argument</span><span class="tok-p">(</span><span class="tok-s1">&#39;exp_id&#39;</span><span class="tok-p">,</span> <span class="tok-n">help</span><span class="tok-o">=</span><span class="tok-s1">&#39;experiment id&#39;</span><span class="tok-p">)</span>
    <span class="tok-n">parser</span><span class="tok-o">.</span><span class="tok-n">add_argument</span><span class="tok-p">(</span><span class="tok-s1">&#39;config_file&#39;</span><span class="tok-p">,</span> <span class="tok-n">help</span><span class="tok-o">=</span><span class="tok-s2">&quot;yaml format configuration file&quot;</span><span class="tok-p">)</span>
    <span class="tok-k">return</span> <span class="tok-n">parser</span>


<span class="tok-k">if</span> <span class="tok-vm">__name__</span> <span class="tok-o">==</span> <span class="tok-s1">&#39;__main__&#39;</span><span class="tok-p">:</span>
    <span class="tok-n">parser</span> <span class="tok-o">=</span> <span class="tok-n">create_parser</span><span class="tok-p">()</span>
    <span class="tok-n">args</span> <span class="tok-o">=</span> <span class="tok-n">parser</span><span class="tok-o">.</span><span class="tok-n">parse_args</span><span class="tok-p">()</span>
    <span class="tok-k">with</span> <span class="tok-nb">open</span><span class="tok-p">(</span><span class="tok-n">args</span><span class="tok-o">.</span><span class="tok-n">config_file</span><span class="tok-p">)</span> <span class="tok-k">as</span> <span class="tok-n">fin</span><span class="tok-p">:</span>
        <span class="tok-n">params</span> <span class="tok-o">=</span> <span class="tok-n">yaml</span><span class="tok-o">.</span><span class="tok-n">safe_load</span><span class="tok-p">(</span><span class="tok-n">fin</span><span class="tok-p">)</span>

    <span class="tok-n">run</span><span class="tok-p">(</span><span class="tok-n">args</span><span class="tok-o">.</span><span class="tok-n">exp_id</span><span class="tok-p">,</span> <span class="tok-n">params</span><span class="tok-p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>create_parser</code> function creates the command line arguments, and the <code><em>main</em></code> section
loads the configuration file into a Python dictionary, and calls the <code>run</code> function, passing it
the  <code>params</code> dictionary.</p>
</div>
<div id="me_init" class="paragraph">
<p>The <code>run</code> function starts the EQ/SQL database, and the worker pool, and creates a task queue
for submitting tasks to the database output queue to be retrieved by the worker pool for
execution.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">def</span> <span class="tok-nf">run</span><span class="tok-p">(</span><span class="tok-n">exp_id</span><span class="tok-p">:</span> <span class="tok-nb">str</span><span class="tok-p">,</span> <span class="tok-n">params</span><span class="tok-p">:</span> <span class="tok-n">Dict</span><span class="tok-p">):</span>    <i class="conum" data-value="1"></i><b>(1)</b>
  <span class="tok-o">...</span>
  <span class="tok-c1"># start database</span>
  <span class="tok-n">db_tools</span><span class="tok-o">.</span><span class="tok-n">start_db</span><span class="tok-p">(</span><span class="tok-n">params</span><span class="tok-p">[</span><span class="tok-s1">&#39;db_path&#39;</span><span class="tok-p">])</span>    <i class="conum" data-value="2"></i><b>(2)</b>
  <span class="tok-n">db_started</span> <span class="tok-o">=</span> <span class="tok-kc">True</span>

  <span class="tok-c1"># start local task queue</span>
  <span class="tok-n">task_queue</span> <span class="tok-o">=</span> <span class="tok-n">local_queue</span><span class="tok-o">.</span><span class="tok-n">init_task_queue</span><span class="tok-p">(</span><span class="tok-n">params</span><span class="tok-p">[</span><span class="tok-s1">&#39;db_host&#39;</span><span class="tok-p">],</span> <span class="tok-n">params</span><span class="tok-p">[</span><span class="tok-s1">&#39;db_user&#39;</span><span class="tok-p">],</span>    <i class="conum" data-value="3"></i><b>(3)</b>
                                           <span class="tok-n">port</span><span class="tok-o">=</span><span class="tok-kc">None</span><span class="tok-p">,</span> <span class="tok-n">db_name</span><span class="tok-o">=</span><span class="tok-n">params</span><span class="tok-p">[</span><span class="tok-s1">&#39;db_name&#39;</span><span class="tok-p">])</span>

  <span class="tok-c1"># check if the input and output queues are empty,</span>
  <span class="tok-c1"># if not, then exit with a warning.</span>
  <span class="tok-k">if</span> <span class="tok-ow">not</span> <span class="tok-n">task_queue</span><span class="tok-o">.</span><span class="tok-n">are_queues_empty</span><span class="tok-p">():</span>    <i class="conum" data-value="4"></i><b>(4)</b>
      <span class="tok-nb">print</span><span class="tok-p">(</span><span class="tok-s2">&quot;WARNING: db input / output queues are not empty. Aborting run&quot;</span><span class="tok-p">,</span> <span class="tok-n">flush</span><span class="tok-o">=</span><span class="tok-kc">True</span><span class="tok-p">)</span>
      <span class="tok-k">return</span>

  <span class="tok-c1"># start worker pool</span>
  <span class="tok-n">pool_params</span> <span class="tok-o">=</span> <span class="tok-n">worker_pool</span><span class="tok-o">.</span><span class="tok-n">cfg_file_to_dict</span><span class="tok-p">(</span><span class="tok-n">params</span><span class="tok-p">[</span><span class="tok-s1">&#39;pool_cfg_file&#39;</span><span class="tok-p">])</span>
  <span class="tok-n">pool</span> <span class="tok-o">=</span> <span class="tok-n">worker_pool</span><span class="tok-o">.</span><span class="tok-n">start_local_pool</span><span class="tok-p">(</span><span class="tok-n">params</span><span class="tok-p">[</span><span class="tok-s1">&#39;worker_pool_id&#39;</span><span class="tok-p">],</span>    <i class="conum" data-value="5"></i><b>(5)</b>
                                      <span class="tok-n">params</span><span class="tok-p">[</span><span class="tok-s1">&#39;pool_launch_script&#39;</span><span class="tok-p">],</span>
                                      <span class="tok-n">exp_id</span><span class="tok-p">,</span> <span class="tok-n">pool_params</span><span class="tok-p">)</span>
  <span class="tok-n">task_type</span> <span class="tok-o">=</span> <span class="tok-n">params</span><span class="tok-p">[</span><span class="tok-s1">&#39;task_type&#39;</span><span class="tok-p">]</span>
  <span class="tok-n">fts</span> <span class="tok-o">=</span> <span class="tok-p">[]</span>

  <span class="tok-c1"># TODO: submit some tasks to DB, and append the returned eqsql.eq.futures to </span><i class="conum" data-value="6"></i><b>(6)</b>
  <span class="tok-c1"># the list of futures. For example:</span>

  <span class="tok-c1"># payloads = [json.dumps({&#39;x&#39;: random.uniform(0, 10), &#39;y&#39;: random.uniform(0, 10)}) for _ in range(100)]</span>
  <span class="tok-c1"># _, fts = task_queue.submit_tasks(exp_id, task_type, payloads)</span>

  <span class="tok-c1"># TODO: do something with the completed futures. See the EQSQL documentation</span>
  <span class="tok-c1"># for more options. For example:</span>
  <span class="tok-c1"># for ft in task_queue.as_completed(fts):</span>
  <span class="tok-c1">#     print(ft.result())</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The params dictionary contains all the parameters used to initialize the workflow.
These will be explained in more detail in the <a href="#algo_cfg">configuration file</a>
discussion.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Start the database located at the <code>db_path</code> parameter.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Initialize a task queue for submitting tasks to the database queue.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Check if the database input and output queues are empty before submitting
tasks. If not, then abort the run.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Start the worker pool using the worker pool related configuration parameters.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Once the initialization is complete, the <code>task_queue</code> can be used to submit
tasks (model input parameters) to the database output queue, and to retrieve
and use the results returned by the worker pool to the database input queue.</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
See the eqsql package documentation <mark>TODO: create and make link</mark> for
more details.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The body of the <code>run</code> function is wrapped in a <code>try &#8230;&#8203; finally</code> clause
in order to shutdown the database, worker pool, and task queue as cleanly
as possible in the event of an error occurring.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><mark>TODO: R example ME discussion</mark></p>
</div>
<div id="algo_cfg" class="paragraph">
<p><a href="https://github.com/jozik/emews_next_gen_tutorial_tests/blob/675eb2423dea8fd3c567a42dce610d655b9ab77e/code/eqsql_project/python/algo_cfg.yaml#L1" target="algo_cfg"><code><strong>algo_cfg.yaml</strong></code></a></p>
</div>
<div class="paragraph">
<p><code>algo_cfg.yaml</code> is a yaml format file used configure the example ME. The file begins with the
database related parameters. These parameters are used by the example ME algorithm to
start and connect to the database.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1"># TODO: Edit DB properties if necessary</span>
db_path:<span class="tok-w"> </span>/home/nick/tmp/db<span class="tok-w">    </span><i class="conum" data-value="1"></i><b>(1)</b>
db_host:<span class="tok-w"> </span>localhost<span class="tok-w">    </span><i class="conum" data-value="2"></i><b>(2)</b>
db_user:<span class="tok-w"> </span>eqsql_user<span class="tok-w">    </span><i class="conum" data-value="3"></i><b>(3)</b>
db_name:<span class="tok-w"> </span>EQ_SQL<span class="tok-w">    </span><i class="conum" data-value="4"></i><b>(4)</b>
<span class="tok-c1"># db_port can be empty for local run</span>
db_port:<span class="tok-w">    </span><i class="conum" data-value="5"></i><b>(5)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Set the db_path variable to the location of the db directory. The ME will use this
to start the database.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Set the database host name. This defaults to <code>localhost</code> under the default local database
configuration.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Set the database user name. This defaults to <code>eqsql_user</code> under the default local database
configuration.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Set the database name. This defaults to <code>EQ_SQL</code> under the default local database configuration.
&lt;5&gt;Set the database port. If using the default local database configuration, no port needs
to be specified.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The remaining parameters are used by the ME when working with the worker pool.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>worker_pool_id:<span class="tok-w"> </span>default<span class="tok-w">    </span><i class="conum" data-value="1"></i><b>(1)</b>
task_type:<span class="tok-w"> </span><span class="tok-m">0</span><span class="tok-w">    </span><i class="conum" data-value="2"></i><b>(2)</b>

pool_launch_script:<span class="tok-w"> </span>/home/nick/Documents/repos/emews_next_gen_tutorial_tests/code/eqsql_project/swift/run_eqsql_worker_pool.sh<span class="tok-w">    </span><i class="conum" data-value="3"></i><b>(3)</b>
pool_cfg_file:<span class="tok-w"> </span>/home/nick/Documents/repos/emews_next_gen_tutorial_tests/code/eqsql_project/swift/cfgs/eqsql_worker_pool.cfg<span class="tok-w">    </span><i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Set a worker pool id. The example ME assigns this id to the worker pool when it starts it using
the <code>pool_launch_script</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Set the type of task for the worker pool to consume.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Set the worker pool launch script. The example ME will use this script to start the worker pool.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Set the configuration file for the worker pool.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_init_db">B.5. INIT DB</h3>
<div class="paragraph">
<p>EMEWS Creator also includes an <code>init_db</code> command that
creates the EQSQL database in a user specified directory for use by an EQ/SQL workflow. It assumes that the postgresql
binaries are available in the user PATH, and that the eqsql package has been installed. The database name will
default to <code>EQ_SQL</code>, and the database user to <code>eqsql_user</code>. Database log messages will be written to
a <code>db.log</code> file in the database directory.</p>
</div>
<div class="paragraph">
<p>Usage:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code><span></span>emewscreator init_db -h
Usage: emewscreator init_db [OPTIONS]

Options:
  -d, --db-path PATH  Database directory path. The database will be created in
                      this directory.  [required]
  -p, --port INTEGER  The database port, if any.
  -h, --help          Show this message and exit.</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>init_db</code> takes the following arguments:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>--db-path</code> - the directory in which to create the database. This must not already exist,
and will be created by the running template.</p>
</li>
<li>
<p><code>--port</code> - an optional port number for the database to listen for connections on. This is not
required for a local database.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_references">References</h2>
<div class="sectionbody">
<div class="paragraph">
<p><a id="boussaid_survey_2013"></a>Boussaïd, Ilhem, Julien Lepagnot, and Patrick Siarry. 2013. “A Survey on Optimization Metaheuristics.” <em>Information Sciences</em>, Prediction, Control and Diagnosis using Advanced Neural Computations, 237 (July): 82–117. <a href="https://doi.org/10.1016/j.ins.2013.02.041" class="bare">https://doi.org/10.1016/j.ins.2013.02.041</a>.</p>
</div>
<div class="paragraph">
<p><a id="ozik_desktop_2016"></a>Ozik, Jonathan, Nicholson T. Collier, Justin M. Wozniak, and Carmine Spagnuolo. 2016. “From Desktop to Large-Scale Model Exploration with Swift/T.” In <em>2016 Winter Simulation Conference (WSC)</em>, 206–20. <a href="https://doi.org/10.1109/WSC.2016.7822090" class="bare">https://doi.org/10.1109/WSC.2016.7822090</a>.</p>
</div>
<div class="paragraph">
<p><a id="ozik_population_2021"></a>Ozik, Jonathan, Justin M Wozniak, Nicholson Collier, Charles M Macal, and Mickaël Binois. 2021. “A Population Data-Driven Workflow for COVID-19 Modeling and Learning.” <em>The International Journal of High Performance Computing Applications</em> 35 (5): 483–99. <a href="https://doi.org/10.1177/10943420211035164" class="bare">https://doi.org/10.1177/10943420211035164</a>.</p>
</div>
<div class="paragraph">
<p><a id="wozniak_swiftt_2013"></a>Wozniak, J. M., T. G. Armstrong, M. Wilde, D. S. Katz, E. Lusk, and I. T. Foster. 2013. “Swift/T: Large-Scale Application Composition via Distributed-Memory Dataflow Processing.” In <em>2013 13th IEEE/ACM International Symposium on Cluster, Cloud, and Grid Computing</em>, 95–102. IEEE. <a href="https://doi.org/10.1109/CCGrid.2013.99" class="bare">https://doi.org/10.1109/CCGrid.2013.99</a>.</p>
</div>
<div class="paragraph">
<p><a id="wozniak_candle_supervisor_2018"></a>Wozniak, Justin M., Rajeev Jain, Prasanna Balaprakash, Jonathan Ozik, Nicholson T. Collier, John Bauer, Fangfang Xia, et al. 2018. “CANDLE/Supervisor: a Workflow Framework for Machine Learning Applied to Cancer Research.” <em>BMC Bioinformatics</em> 19 (18): 491. <a href="https://doi.org/10.1186/s12859-018-2508-4" class="bare">https://doi.org/10.1186/s12859-018-2508-4</a>.</p>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2024-01-13 11:18:09 -0600
</div>
</div>
</body>
</html>